<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>高效创建ip代理池 - P1n93r - 博学而精一</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="P1n93r"><meta name=description content="前言 这次自动化软件测试课设过程中，弄着弄着ip就被ban了，于是想到挂代理，然后就想自己创建一个ip代理池，最后在github上发现了一个开"><meta name=keywords content="Security,Java,Web,Android"><meta name=generator content="Hugo 0.97.3 with theme even"><link rel=canonical href=https://p1n93r.github.io/post/other/%E9%AB%98%E6%95%88%E5%88%9B%E5%BB%BAip%E4%BB%A3%E7%90%86%E6%B1%A0/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="高效创建ip代理池"><meta property="og:description" content="前言 这次自动化软件测试课设过程中，弄着弄着ip就被ban了，于是想到挂代理，然后就想自己创建一个ip代理池，最后在github上发现了一个开"><meta property="og:type" content="article"><meta property="og:url" content="https://p1n93r.github.io/post/other/%E9%AB%98%E6%95%88%E5%88%9B%E5%BB%BAip%E4%BB%A3%E7%90%86%E6%B1%A0/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-10-04T14:09:36+08:00"><meta property="article:modified_time" content="2019-10-04T14:09:36+08:00"><meta itemprop=name content="高效创建ip代理池"><meta itemprop=description content="前言 这次自动化软件测试课设过程中，弄着弄着ip就被ban了，于是想到挂代理，然后就想自己创建一个ip代理池，最后在github上发现了一个开"><meta itemprop=datePublished content="2019-10-04T14:09:36+08:00"><meta itemprop=dateModified content="2019-10-04T14:09:36+08:00"><meta itemprop=wordCount content="1412"><meta itemprop=keywords content="ip代理池,"><meta name=twitter:card content="summary"><meta name=twitter:title content="高效创建ip代理池"><meta name=twitter:description content="前言 这次自动化软件测试课设过程中，弄着弄着ip就被ban了，于是想到挂代理，然后就想自己创建一个ip代理池，最后在github上发现了一个开"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>P1n93r</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>P1n93r</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>高效创建ip代理池</h1><div class=post-meta><span class=post-time>2019-10-04</span><div class=post-category><a href=/categories/other/>Other</a></div><span class=more-meta>约 1412 字</span>
<span class=more-meta>预计阅读 3 分钟</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次阅读</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#show-you-the-code>Show you the code</a></li><li><a href=#演示>演示</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=前言>前言</h2><p>这次自动化软件测试课设过程中，弄着弄着ip就被ban了，于是想到挂代理，然后就想自己创建一个ip代理池，最后在github上发现了一个开源项目：<a href=https://github.com/fate0/proxylist>proxylist
</a>，此项目作者自己每隔15分钟将自己爬到的代理ip发布到此项目的proxy.list下，所以我们直接获取这个文件就行了。以下的所有操作都是基于这个项目的。感谢作者提供的便利！</p><p>然后我用的是python3解析获取到的proxy.list，将里面的代理ip存放到一个excel文件里， <strong>使用了openpyxl模块</strong> ，需要pip安装一下。然后所谓的高效，就是用了多线程而已=-= ，多线程筛选可用的ip，并且多线程写入excel，最后汇总到一个excel。</p><h2 id=show-you-the-code>Show you the code</h2><pre><code>import json
import requests
import threading
import time
import os
import shutil
import openpyxl
from openpyxl import Workbook

#写文件的多线程类
class WriteIpList(threading.Thread):
    def __init__(self,location,list,start):
        super(WriteIpList,self).__init__()
        self.location=location
        self.list=list
        self.startLocation=start
        
    def run(self):
        currentLocation=self.startLocation
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.append([&quot;host&quot;,&quot;port&quot;,&quot;type&quot;])
        for index in range(len(self.list)):
            proxyJson = json.loads(self.list[index])
            host = proxyJson['host']
            port = proxyJson['port']
            type = proxyJson['type']
            temp=[host,port,type]
            #将得到的ip数据添加到excel的一行
            ws.append(temp)
        
        # 判断路径是否存在
        isExists=os.path.exists(&quot;./temp&quot;)
        if not isExists:
            os.mkdir(&quot;./temp&quot;)
        #保存当前excel
        wb.save(&quot;temp/temp_&quot;+str(self.startLocation)+'.xlsx')

#筛选ip的多线程类
class SelectIp(threading.Thread):
    def __init__(self,list,targetList):
        super(SelectIp,self).__init__()
        self.list=list
        self.targetList=targetList
        
    def run(self):
        for i in range(len(self.list)):
            #验证当前ip是否可用(虽然可以设置代理，但是不保证可以隐匿)
            proxyJson = json.loads(self.list[i])
            proxy = {
                &quot;http&quot;:proxyJson['host']+&quot;:&quot;+str(proxyJson['port']),
            }
            try:
                proxyResp = requests.get('http://icanhazip.com',proxies=proxy,timeout=3)
                if proxyResp.text.strip()==proxyJson['host']:
                    self.targetList.append(self.list[i])
            except Exception as e:
                #使用此代理ip不能联网或者网速过慢，所以舍弃
                continue

def getIpList(count):
    while(True):
        try:
            #待提取ip文本地址
            proxyUrl = 'https://raw.githubusercontent.com/fate0/proxylist/master/proxy.list'
            response = requests.get(proxyUrl,timeout=5)
            proxiesList = response.text.split('\n')[:-1]
            totalCount=len(proxiesList)
            if count&gt;totalCount:
                count=totalCount
            print(&quot;请求成功！\n本次捕获到的ip数量为：&quot;,totalCount)
            #返回ip列表
            return proxiesList[:count]
        except Exception as e:
            print(&quot;本次请求ip代理池失败，正在进行下次请求......&quot;)
            continue;

def endWrite(location):
    xlfs=[str(&quot;./temp/&quot;)+x for x in os.listdir('./temp/') if os.path.isfile(str(&quot;./temp/&quot;)+x) and os.path.splitext(str(&quot;./temp/&quot;)+x)[1] == '.xlsx']
    count=len(xlfs)
    if count!=0:
        #一个存放结果的列表
        result=[]
        #复制每个表的数据（除去表头）
        for each in range(count):
            wb=openpyxl.load_workbook(xlfs[each])
            ws=wb.active
            #获取总行数和总列数
            rows=ws.max_row
            columns=ws.max_column
            for i in range(2,rows+1):
                rowValue=[]
                for j in range(1,columns+1):
                    rowValue.append(ws.cell(row=i, column=j).value)
                result.append(rowValue)
        #创建一张汇总的新表
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.append([&quot;host&quot;,&quot;port&quot;,&quot;type&quot;])
        for each in range(len(result)):
            ws.append(result[each])
        wb.save(location)
        #汇总之后，删除temp文件夹
        shutil.rmtree('./temp')
        
def startWrite(count,location):
    '''
        Function:将ip池写道指定的excel文件下，count为期望的ip池大小，location是指定excel文件的位置（带后缀）
    '''
    try:
        #开始时间
        start=time.time()
        originalIpList=getIpList(count)
        #存放结果的list
        resultList=[]
        #线程池
        selectIpThread=[]
        #启动筛选线程
        selectThreadCount=(len(originalIpList)+9)//10
        print(&quot;启动了&quot;,selectThreadCount,&quot;个筛选线程&quot;)
        for i in range(selectThreadCount):
            t=SelectIp(originalIpList[i*10:i*10+10],resultList)
            t.start()
            #将启动的线程加入线程池
            selectIpThread.append(t)
            
        #等待线程完成
        for i in range(0,len(selectIpThread)):
            selectIpThread[i].join()
        
        #得到筛选后的ip列表
        finalIpList=resultList
        totalCount=len(finalIpList)
        print(&quot;实际将存储的ip数量为：&quot;,totalCount)
        #分配线程策略：一个线程写10行
        threadCount=(totalCount+9)//10
        print(&quot;启动了&quot;,threadCount,&quot;个写线程&quot;)
        #创建线程池
        thread=[]
        for i in range(0,threadCount):
            targetList=finalIpList[i*10:i*10+10]
            t=WriteIpList(location,targetList,i*10)
            t.start()
            #将启动的线程加入线程池
            thread.append(t)
        #等待线程完成
        for i in range(0,len(thread)):
            thread[i].join()
        end=time.time()
        endWrite(location)
        print(&quot;ip代理池创建完成，历时：&quot;,end-start)
    except Exception as e:
        print(e)
        
if __name__==&quot;__main__&quot;:
    try:
        updateIps=input(&quot;创建ip代理池？(是：1，否：其他数字)：&quot;)
        if int(updateIps)==1:
            count=input(&quot;请输入代理池的最大值(筛选掉不能使用的ip后将导致实际值偏小)：&quot;)
            location=input(&quot;请输入写入文件位置：\nExample:proxyIpList.xlsx\n&quot;)
            count=int(count)
            startWrite(count,location)
    except Exception as e:
            print(&quot;请合法输入！\n\n&quot;)
</code></pre><h2 id=演示>演示</h2><p>运行演示如图所示：</p><p><img src=/media/20191004-1.png alt=脚本运行图></p><p>打开脚本生成的excel结果如图所示(未显示完全)：</p><p><img src=/media/20191004-2.png alt=excel结果></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>P1n93r</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2019-10-04</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/ip%E4%BB%A3%E7%90%86%E6%B1%A0/>ip代理池</a></div><nav class=post-nav><a class=prev href=/post/java/%E9%9B%86%E5%90%88/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">集合</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/java/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E4%BA%8C/><span class="next-text nav-default">面向对象(二)</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="p1n93r",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:pin83r@gmail.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/p1n93r class="iconfont icon-github" title=github></a>
<a href=https://p1n93r.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次</span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>本站总访客数 <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span> 人</span></div><span class=copyright-year>&copy;
2019 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>P1n93r</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js></script></body></html>